# 3.3.1 智谱AI接口集成架构

心语精灵采用智谱AI的大语言模型作为核心AI能力提供者，构建了一套完整的AI服务集成架构。本节详细介绍智谱AI接口的集成架构设计与实现。

## 接口集成架构设计

心语精灵的智谱AI接口集成架构采用分层设计，实现了AI能力的灵活调用和高效管理。整体架构如图3-2所示：

![图3-2 智谱AI接口集成架构图](../图片路径)

该架构主要分为四层：

**1. 应用层**
- 包含聊天对话、情感分析、用户画像等业务功能
- 通过调用服务层接口获取AI能力
- 负责业务逻辑处理和结果展示

**2. 服务层**
- 封装了智谱AI的各种能力，提供标准化的服务接口
- 包括对话服务、情感分析服务、向量生成服务等
- 负责请求参数构建和结果数据处理

**3. 适配层**
- 实现了与智谱AI API的适配和转换
- 处理认证、请求构建、响应解析等通用逻辑
- 提供错误处理、重试机制和性能优化

**4. 基础层**
- 提供HTTP请求、加密签名、日志记录等基础功能
- 实现API密钥管理和安全策略
- 负责网络通信和底层资源管理

这种分层架构设计具有以下优势：

- **解耦合**：各层之间通过明确的接口通信，降低耦合度
- **可扩展**：可以方便地添加新的AI能力或替换底层AI服务提供商
- **可维护**：各层职责明确，便于定位和解决问题
- **可测试**：各层可以独立测试，提高代码质量

## 接口集成实现

心语精灵的智谱AI接口集成主要通过云函数实现，核心代码结构如下：

```
cloudfunctions/
├── analysis/                # 情感分析云函数
│   ├── index.js             # 入口文件
│   ├── bigmodel.js          # 智谱AI接口封装
│   └── package.json         # 依赖配置
├── chat/                    # 聊天对话云函数
│   ├── index.js             # 入口文件
│   ├── bigmodel.js          # 智谱AI接口封装
│   └── package.json         # 依赖配置
└── httpRequest/             # HTTP请求云函数
    ├── index.js             # 入口文件
    └── package.json         # 依赖配置
```

### 基础层实现

基础层主要通过`httpRequest`云函数实现，提供通用的HTTP请求能力：

```javascript
// httpRequest/index.js
const cloud = require('wx-server-sdk');
const axios = require('axios');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

exports.main = async (event, context) => {
  const { url, method = 'GET', headers = {}, body, timeout = 30000 } = event;
  
  try {
    const response = await axios({
      url,
      method,
      headers,
      data: body ? JSON.parse(body) : undefined,
      timeout,
      validateStatus: () => true // 返回所有状态码的响应
    });
    
    return {
      statusCode: response.status,
      headers: response.headers,
      body: typeof response.data === 'object' ? 
        JSON.stringify(response.data) : response.data
    };
  } catch (error) {
    console.error('HTTP请求失败:', error);
    return {
      error: error.message,
      statusCode: 500
    };
  }
};
```

### 适配层实现

适配层主要在各业务云函数中的`bigmodel.js`文件中实现，负责与智谱AI API的适配：

```javascript
// analysis/bigmodel.js (适配层核心实现)
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

// API常量定义
const API_BASE_URL = 'https://open.bigmodel.cn/api/paas/v4';
const GLM_4_FLASH = 'glm-4-flash';
const EMBEDDING_3 = 'embedding-3';

// 获取认证头部
function getAuthHeaders() {
  const apiKey = process.env.ZHIPU_API_KEY;
  if (!apiKey) {
    throw new Error('未设置ZHIPU_API_KEY环境变量');
  }
  
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`
  };
}

// 调用智谱AI API
async function callZhipuAPI(endpoint, data) {
  try {
    // 调用httpRequest云函数发送请求
    const response = await cloud.callFunction({
      name: 'httpRequest',
      data: {
        url: `${API_BASE_URL}/${endpoint}`,
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(data),
        timeout: 60000
      }
    });
    
    // 检查HTTP请求是否成功
    if (response.result.error) {
      throw new Error(`HTTP请求失败: ${response.result.error}`);
    }
    
    // 解析响应体
    const responseBody = JSON.parse(response.result.body);
    
    // 检查API响应是否包含错误
    if (responseBody.error) {
      throw new Error(`API错误: ${responseBody.error.message || responseBody.error.type}`);
    }
    
    return responseBody;
  } catch (error) {
    console.error(`调用智谱AI API失败 (${endpoint}):`, error);
    throw error;
  }
}
```

### 服务层实现

服务层在适配层的基础上，封装了各种AI能力的服务接口：

```javascript
// analysis/bigmodel.js (服务层实现)

// 情感分析服务
async function analyzeEmotion(text, history = []) {
  try {
    // 构建提示词
    const promptMessages = [
      {
        role: "system",
        content: "你是一个专业的情感分析助手，能够准确分析文本中表达的情感。"
      },
      {
        role: "user",
        content: `分析以下文本中表达的情感，返回JSON格式：
        文本：${text}
        
        请返回以下字段：
        1. primary_emotion: 主要情绪类型 (喜悦、悲伤、愤怒、恐惧、惊讶、厌恶、中性)
        2. secondary_emotion: 次要情绪类型 (如果有)
        3. intensity: 情绪强度 (0.0-1.0)
        4. keywords: 情绪关键词数组
        5. analysis: 简短的情绪分析描述
        6. suggestions: 基于情绪状态的建议数组
        
        确保返回的是有效的JSON格式。`
      }
    ];
    
    // 添加历史消息上下文（如果有）
    if (history && history.length > 0) {
      // 在system和user提示词之间插入历史消息
      promptMessages.splice(1, 0, ...history.map(msg => ({
        role: msg.role,
        content: msg.content
      })));
    }
    
    // 调用智谱AI API
    const response = await callZhipuAPI('chat/completions', {
      model: GLM_4_FLASH,
      messages: promptMessages,
      temperature: 0.3,
      response_format: { type: 'json_object' }
    });
    
    // 解析JSON响应
    const content = response.choices[0].message.content;
    const result = JSON.parse(content);
    
    // 标准化结果
    return {
      success: true,
      result: {
        type: result.primary_emotion,
        secondary: result.secondary_emotion,
        intensity: result.intensity,
        keywords: result.keywords || [],
        analysis: result.analysis,
        suggestions: result.suggestions || [],
        originalText: text
      }
    };
  } catch (error) {
    console.error('情感分析失败:', error);
    return {
      success: false,
      error: error.message || '情感分析失败'
    };
  }
}

// 关键词提取服务
async function extractKeywords(text, maxKeywords = 10) {
  try {
    // 构建提示词
    const promptMessages = [
      {
        role: "system",
        content: "你是一个专业的关键词提取助手，能够准确提取文本中的关键词和短语。"
      },
      {
        role: "user",
        content: `从以下文本中提取最重要的${maxKeywords}个关键词或短语，按重要性排序：
        文本：${text}
        
        请返回JSON格式：
        {
          "keywords": [
            {"word": "关键词1", "weight": 0.9},
            {"word": "关键词2", "weight": 0.8},
            ...
          ]
        }`
      }
    ];
    
    // 调用智谱AI API
    const response = await callZhipuAPI('chat/completions', {
      model: GLM_4_FLASH,
      messages: promptMessages,
      temperature: 0.3,
      response_format: { type: 'json_object' }
    });
    
    // 解析JSON响应
    const content = response.choices[0].message.content;
    const result = JSON.parse(content);
    
    return {
      success: true,
      keywords: result.keywords || []
    };
  } catch (error) {
    console.error('关键词提取失败:', error);
    return {
      success: false,
      error: error.message || '关键词提取失败',
      keywords: []
    };
  }
}

// 文本向量化服务
async function generateEmbedding(text) {
  try {
    // 调用智谱AI Embedding API
    const response = await callZhipuAPI('embeddings', {
      model: EMBEDDING_3,
      input: text
    });
    
    return {
      success: true,
      embedding: response.data[0].embedding,
      usage: response.usage
    };
  } catch (error) {
    console.error('生成文本向量失败:', error);
    return {
      success: false,
      error: error.message || '生成文本向量失败'
    };
  }
}

// 导出服务接口
module.exports = {
  analyzeEmotion,
  extractKeywords,
  generateEmbedding,
  // 其他服务接口...
};
```

### 应用层实现

应用层在各业务云函数的入口文件中实现，负责业务逻辑处理：

```javascript
// analysis/index.js (应用层实现)
const cloud = require('wx-server-sdk');
const bigModelModule = require('./bigmodel');

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

// 云函数入口函数
exports.main = async (event, context) => {
  // 获取微信上下文
  const wxContext = cloud.getWXContext();
  const openid = wxContext.OPENID;
  
  // 根据请求类型分发处理
  switch (event.type) {
    case 'emotion':
      return await analyzeEmotion(event, openid);
    case 'keywords':
      return await extractKeywords(event, openid);
    case 'embedding':
      return await generateEmbedding(event, openid);
    default:
      return {
        success: false,
        error: '未知的请求类型'
      };
  }
};

// 情感分析处理函数
async function analyzeEmotion(event, openid) {
  const { text, history, saveRecord = false, chatId, messageId } = event;
  
  // 参数验证
  if (!text || typeof text !== 'string' || text.trim() === '') {
    return {
      success: false,
      error: '无效的文本参数'
    };
  }
  
  // 调用情感分析服务
  const result = await bigModelModule.analyzeEmotion(text, history);
  
  // 如果需要保存记录且分析成功
  if (saveRecord && result.success) {
    try {
      // 构建记录数据
      const recordData = {
        userId: openid,
        text: text,
        emotions: {
          joy: 0,
          sadness: 0,
          anger: 0,
          fear: 0,
          surprise: 0,
          disgust: 0,
          neutral: 0,
          // 根据分析结果设置对应情绪值
          [result.result.type]: result.result.intensity
        },
        primary: result.result.type,
        secondary: result.result.secondary,
        keywords: result.result.keywords,
        analysis: result.result.analysis,
        timestamp: db.serverDate()
      };
      
      // 添加可选关联字段
      if (chatId) recordData.chatId = chatId;
      if (messageId) recordData.messageId = messageId;
      
      // 保存到数据库
      await db.collection('emotionRecords').add({
        data: recordData
      });
    } catch (error) {
      console.error('保存情感记录失败:', error);
      // 注意：即使保存失败，仍然返回分析结果
    }
  }
  
  return result;
}

// 其他处理函数...
```

## 接口安全与管理

心语精灵在智谱AI接口集成中，特别注重安全性和可管理性，实现了以下机制：

**1. API密钥安全管理**

采用云函数环境变量存储API密钥，避免硬编码和泄露风险：

```javascript
// 在云开发控制台设置环境变量
// ZHIPU_API_KEY=your_api_key_here

// 在代码中安全获取
const apiKey = process.env.ZHIPU_API_KEY;
if (!apiKey) {
  throw new Error('未设置ZHIPU_API_KEY环境变量');
}
```

**2. 请求限流与监控**

实现了请求限流和监控机制，防止API滥用和成本失控：

```javascript
// 简化版限流实现
const requestLimiter = {
  maxRequests: 100, // 每分钟最大请求数
  currentRequests: 0,
  resetTime: Date.now() + 60000,
  
  canMakeRequest() {
    const now = Date.now();
    if (now > this.resetTime) {
      this.currentRequests = 0;
      this.resetTime = now + 60000;
    }
    
    if (this.currentRequests < this.maxRequests) {
      this.currentRequests++;
      return true;
    }
    
    return false;
  }
};

// 在API调用前检查
if (!requestLimiter.canMakeRequest()) {
  throw new Error('API请求频率超限，请稍后再试');
}
```

**3. 日志记录与分析**

实现了详细的日志记录和分析功能，便于问题排查和优化：

```javascript
// 日志记录
function logApiCall(endpoint, params, result, startTime) {
  const endTime = Date.now();
  const duration = endTime - startTime;
  
  console.log({
    type: 'api_call',
    endpoint,
    duration,
    success: !result.error,
    error: result.error,
    timestamp: new Date().toISOString()
  });
  
  // 可以将日志写入数据库或云监控系统
}
```

通过以上智谱AI接口集成架构的设计与实现，心语精灵实现了对AI能力的高效调用和管理，为情感陪伴和情商提升功能提供了强大的技术支持。
