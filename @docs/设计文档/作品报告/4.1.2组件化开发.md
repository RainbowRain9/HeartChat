# 4.1.2 组件化开发

心语精灵采用组件化开发方式，将界面拆分为可复用的组件，提高了开发效率和代码质量。本节详细介绍组件化开发的实现过程和关键组件设计。

## 公共组件设计

### 聊天气泡组件（chat-bubble）

聊天气泡组件是聊天界面的核心元素，用于展示用户和AI的对话内容。

**组件设计**：
- 支持两种气泡样式：用户消息（右侧蓝色）和AI消息（左侧灰色）
- 气泡形状采用圆角矩形，配合小三角指示发言方向
- 支持文本内容自动换行和长度自适应
- 集成情绪标签显示，在消息下方展示情绪分析结果
- 支持长按操作菜单（复制、删除、收藏等）

**技术实现**：
```javascript
// chat-bubble组件属性定义
properties: {
  message: {
    type: Object,
    value: {}
  },
  isSelf: {
    type: Boolean,
    value: false
  },
  showEmotion: {
    type: Boolean,
    value: true
  },
  darkMode: {
    type: Boolean,
    value: false
  }
}
```

组件内部根据`isSelf`属性动态调整气泡样式和位置，通过`wxs`模块处理文本内容（如链接识别、表情替换等）。气泡组件还实现了消息状态指示（发送中、已发送、已读）和错误重试功能。

### 情感分析卡片组件（emotion-card）

情感分析卡片组件用于展示情绪分析结果，是情感分析页面和首页的重要组成部分。

**组件设计**：
- 卡片顶部展示主要情绪类型和强度，配以对应情绪图标
- 中部使用饼图展示情绪分布比例
- 底部展示情绪关键词和简短分析
- 支持点击展开查看详细分析
- 适配不同尺寸和显示场景（首页缩略版/分析页完整版）

**技术实现**：
```javascript
// emotion-card组件数据结构
data: {
  emotionIcons: {
    'joy': '/images/emotions/joy.png',
    'sadness': '/images/emotions/sadness.png',
    'anger': '/images/emotions/anger.png',
    'fear': '/images/emotions/fear.png',
    'surprise': '/images/emotions/surprise.png',
    'disgust': '/images/emotions/disgust.png',
    'neutral': '/images/emotions/neutral.png'
  },
  emotionColors: {
    'joy': '#FFD700',
    'sadness': '#6495ED',
    'anger': '#FF6347',
    'fear': '#9370DB',
    'surprise': '#00CED1',
    'disgust': '#8FBC8F',
    'neutral': '#A9A9A9'
  },
  chartOption: {} // ECharts配置项
}
```

组件内部集成了ECharts饼图，根据传入的情绪数据动态生成图表配置。组件还实现了情绪强度的可视化表示（进度条）和情绪变化趋势指示（上升/下降箭头）。

### 角色卡片组件（role-card）

角色卡片组件用于展示AI角色信息，在角色选择页面和首页推荐区域使用。

**组件设计**：
- 卡片包含角色头像、名称、简介和标签
- 支持多种尺寸（大卡片/中卡片/小卡片）
- 显示角色类型标识（系统角色/用户自定义）
- 集成操作按钮（开始对话、编辑、删除等）
- 支持点击展开查看角色详情

**技术实现**：
```javascript
// role-card组件属性定义
properties: {
  role: {
    type: Object,
    value: {}
  },
  size: {
    type: String,
    value: 'medium' // large, medium, small
  },
  showActions: {
    type: Boolean,
    value: true
  },
  darkMode: {
    type: Boolean,
    value: false
  }
}
```

组件根据`size`属性调整布局和显示内容，大卡片显示完整信息，小卡片仅显示头像和名称。组件内部实现了角色标签的横向滚动和溢出处理，以及角色详情的弹窗展示。

## 业务组件封装

### 情绪历史图表组件（emotion-history）

情绪历史图表组件用于可视化展示用户情绪变化趋势，是情感分析页面的核心组件。

**组件设计**：
- 支持多种图表类型：折线图（时间趋势）、雷达图（情绪分布）、柱状图（情绪强度）
- 实现时间范围选择（日/周/月/年）
- 支持图表交互：缩放、提示、点击查看详情
- 适配不同屏幕尺寸，横屏模式下自动扩展

**技术实现**：
```javascript
// 初始化图表配置
initCharts() {
  const { width, height } = this.data.chartSize;
  const lineOption = {
    grid: { left: '5%', right: '5%', top: '8%', bottom: '8%', containLabel: true },
    tooltip: { trigger: 'axis' },
    xAxis: {
      type: 'time',
      axisLine: { lineStyle: { color: this.data.darkMode ? '#666' : '#ccc' } },
      axisLabel: { color: this.data.darkMode ? '#aaa' : '#666' }
    },
    yAxis: {
      type: 'value',
      min: 0,
      max: 1,
      axisLine: { lineStyle: { color: this.data.darkMode ? '#666' : '#ccc' } },
      axisLabel: { color: this.data.darkMode ? '#aaa' : '#666' }
    },
    series: this.generateSeries()
  };
  
  this.lineChart.setOption(lineOption);
}
```

组件内部实现了数据预处理逻辑，将原始情绪记录转换为图表所需的数据格式。组件还支持数据筛选和聚合功能，可按情绪类型、时间段进行数据过滤和统计。

### 兴趣标签云组件（interest-tag-cloud）

兴趣标签云组件用于可视化展示用户兴趣和关键词，在用户画像和情感分析页面使用。

**组件设计**：
- 标签大小根据权重自动调整，重要标签更大更醒目
- 标签颜色根据类别或情绪类型区分，增强视觉区分度
- 支持标签点击交互，可查看详细信息
- 实现标签布局自适应，避免重叠和溢出
- 支持动态更新和动画效果

**技术实现**：
```javascript
// 生成标签云数据
generateTagsData() {
  return this.data.tags.map(tag => {
    // 计算字体大小，范围12-24px
    const fontSize = 12 + Math.floor(tag.weight * 12);
    // 根据类别或情绪分配颜色
    const color = this.getTagColor(tag.category || tag.emotion);
    // 计算旋转角度，随机-30到30度
    const rotate = Math.random() * 60 - 30;
    
    return {
      text: tag.word,
      weight: tag.weight,
      fontSize: fontSize,
      color: color,
      rotate: rotate,
      data: tag // 存储原始数据用于点击事件
    };
  });
}
```

组件使用自定义算法实现标签的布局计算，确保标签分布均匀且避免重叠。组件还实现了标签的动态添加/删除动画，增强用户体验。

## 组件通信与状态管理

心语精灵采用多种组件通信方式，根据不同场景选择最合适的方案：

**属性传递（Properties）**：
- 用于父组件向子组件传递数据
- 适用于简单的数据传递和单向数据流
- 在组件定义中声明properties，父组件通过属性绑定传值

**事件通信（Events）**：
- 用于子组件向父组件传递消息和数据
- 子组件通过`this.triggerEvent()`触发自定义事件
- 父组件通过`bind:eventName`监听事件

```javascript
// 子组件触发事件
this.triggerEvent('emotionChange', {
  emotion: this.data.currentEmotion,
  timestamp: new Date().getTime()
});

// 父组件监听事件
<emotion-card bind:emotionChange="handleEmotionChange"></emotion-card>
```

**全局状态管理**：
- 使用自定义的事件总线（EventBus）实现跨组件通信
- 核心状态（如用户信息、主题设置）存储在App全局数据中
- 复杂状态变更通过事件机制通知相关组件更新

```javascript
// 事件总线实现
const eventBus = {
  events: {},
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  },
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  },
  off(event, callback) {
    if (this.events[event]) {
      this.events[event] = this.events[event].filter(cb => cb !== callback);
    }
  }
};
```

**组件实例引用**：
- 使用`this.selectComponent()`获取子组件实例
- 适用于需要直接调用子组件方法的场景
- 主要用于图表组件的方法调用和数据更新

## 组件复用策略

为提高开发效率和代码质量，心语精灵采用了以下组件复用策略：

**抽象基础组件**：
- 设计通用的基础组件，如按钮、输入框、卡片等
- 基础组件高度可配置，支持不同场景的样式和行为定制
- 统一处理常见逻辑，如加载状态、错误处理、动画效果等

**组合模式**：
- 采用组合而非继承的方式构建复杂组件
- 将大型组件拆分为多个小型组件，通过组合实现完整功能
- 例如，情感分析卡片由情绪图标、情绪饼图、关键词标签等小组件组合而成

**插槽机制**：
- 使用插槽（slot）实现内容的灵活定制
- 组件提供默认内容，父组件可通过插槽覆盖或扩展
- 支持具名插槽，满足复杂布局需求

```html
<!-- 组件模板定义 -->
<view class="card">
  <view class="card-header">
    <slot name="header">默认标题</slot>
  </view>
  <view class="card-body">
    <slot>默认内容</slot>
  </view>
  <view class="card-footer">
    <slot name="footer"></slot>
  </view>
</view>

<!-- 组件使用 -->
<custom-card>
  <view slot="header">自定义标题</view>
  <view>自定义内容</view>
  <view slot="footer">自定义底部</view>
</custom-card>
```

**行为混入**：
- 实现常用行为的混入（mixin）模式
- 将通用逻辑（如分页加载、下拉刷新、主题切换等）封装为可复用的行为
- 组件通过混入获取这些行为，避免代码重复

```javascript
// 主题切换行为混入
const themeMixin = {
  data: {
    darkMode: false
  },
  attached() {
    // 获取当前主题设置
    const app = getApp();
    this.setData({
      darkMode: app.globalData.darkMode
    });
    
    // 监听主题变化
    app.watchTheme(darkMode => {
      this.setData({ darkMode });
      this.updateThemeStyle();
    });
  },
  methods: {
    updateThemeStyle() {
      // 更新组件样式
    }
  }
};

// 在组件中使用混入
Component({
  behaviors: [themeMixin],
  // 组件其他定义
})
```

通过以上组件化开发策略，心语精灵实现了高度可复用的组件体系，提高了开发效率和代码质量，同时保证了界面风格的一致性和用户体验的流畅性。
