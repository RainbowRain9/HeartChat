# 4.1.3 暗夜模式适配

心语精灵全面支持暗夜模式，为用户在弱光环境下提供舒适的使用体验，减轻视觉疲劳。本节详细介绍暗夜模式的设计原则、实现机制和优化策略。

## 暗夜模式设计原则

在设计暗夜模式时，我们遵循以下核心原则：

**对比度与可读性**：
- 确保文本与背景之间保持足够的对比度，符合WCAG 2.1 AA标准（对比度至少4.5:1）
- 主要文本使用浅色（#E0E0E0），次要文本使用稍暗的灰色（#AAAAAA）
- 背景采用深色系列，主背景为深灰色（#121212），次级背景为稍浅的灰色（#1E1E1E、#2D2D2D）
- 避免纯黑色背景（#000000），减少"光晕"效果和视觉疲劳

**色彩调和与一致性**：
- 降低色彩饱和度，避免过于鲜艳的颜色
- 保持品牌色调，但降低亮度和饱和度
- 主色调从亮色模式的蓝色(#4A90E2)调整为暗色模式的深蓝色(#3A7BC8)
- 确保所有界面元素在明暗模式下保持视觉一致性

**层次与深度**：
- 使用微妙的阴影和边框区分界面层次
- 通过不同深度的背景色创建视觉层次
- 卡片和弹窗使用略高于背景的颜色（#2D2D2D）
- 使用1dp-8dp的阴影效果增强深度感

**状态与反馈**：
- 确保交互元素在暗夜模式下有清晰的状态指示
- 按钮和可点击元素使用适当的高亮效果
- 错误状态使用柔和的红色（#CF6679）而非鲜红色
- 成功状态使用柔和的绿色（#4CAF50的暗色版本）

## 主题切换机制实现

心语精灵实现了完善的主题切换机制，支持手动切换、跟随系统和定时切换三种模式：

**全局主题状态管理**：
- 在App全局数据中维护当前主题状态
- 实现主题变更的发布-订阅机制，组件可订阅主题变化

```javascript
// app.js
App({
  globalData: {
    darkMode: false,
    themeChangeCallbacks: []
  },
  
  onLaunch() {
    // 初始化主题设置
    this.initThemeSettings();
  },
  
  // 初始化主题设置
  initThemeSettings() {
    try {
      // 获取本地存储的主题设置
      const themeSettings = wx.getStorageSync('themeSettings') || {};
      const { darkMode, followSystem } = themeSettings;
      
      if (followSystem) {
        // 获取系统主题
        wx.getSystemInfo({
          success: (res) => {
            const systemDarkMode = res.theme === 'dark';
            this.setDarkMode(systemDarkMode);
            
            // 监听系统主题变化
            wx.onThemeChange((result) => {
              const newDarkMode = result.theme === 'dark';
              this.setDarkMode(newDarkMode);
            });
          }
        });
      } else if (darkMode !== undefined) {
        this.setDarkMode(darkMode);
      }
    } catch (e) {
      console.error('初始化主题设置失败:', e);
    }
  },
  
  // 设置暗夜模式
  setDarkMode(darkMode) {
    this.globalData.darkMode = darkMode;
    
    // 通知所有订阅者
    this.globalData.themeChangeCallbacks.forEach(callback => {
      try {
        callback(darkMode);
      } catch (e) {
        console.error('主题变更回调执行失败:', e);
      }
    });
    
    // 更新导航栏样式
    this.updateNavigationBarStyle(darkMode);
  },
  
  // 监听主题变化
  watchTheme(callback) {
    if (typeof callback === 'function') {
      this.globalData.themeChangeCallbacks.push(callback);
      // 立即执行一次回调，同步当前状态
      callback(this.globalData.darkMode);
    }
    return () => {
      // 返回取消订阅函数
      const index = this.globalData.themeChangeCallbacks.indexOf(callback);
      if (index > -1) {
        this.globalData.themeChangeCallbacks.splice(index, 1);
      }
    };
  },
  
  // 更新导航栏样式
  updateNavigationBarStyle(darkMode) {
    wx.setNavigationBarColor({
      frontColor: darkMode ? '#ffffff' : '#000000',
      backgroundColor: darkMode ? '#121212' : '#ffffff',
      animation: {
        duration: 300,
        timingFunc: 'easeIn'
      }
    });
  }
});
```

**CSS变量与动态样式**：
- 使用CSS变量定义主题颜色和样式
- 根据主题状态动态切换CSS变量值
- 在app.wxss中定义全局主题变量

```css
/* app.wxss */
page {
  /* 亮色主题变量 */
  --bg-color: #ffffff;
  --card-bg-color: #f5f5f5;
  --text-color: #333333;
  --text-secondary-color: #666666;
  --border-color: #e0e0e0;
  --primary-color: #4A90E2;
  --success-color: #4CAF50;
  --warning-color: #FFC107;
  --error-color: #F44336;
  
  /* 应用当前主题变量 */
  background-color: var(--bg-color);
  color: var(--text-color);
}

/* 暗夜模式变量 */
page[data-theme="dark"] {
  --bg-color: #121212;
  --card-bg-color: #1e1e1e;
  --text-color: #e0e0e0;
  --text-secondary-color: #aaaaaa;
  --border-color: #333333;
  --primary-color: #3A7BC8;
  --success-color: #388E3C;
  --warning-color: #F57C00;
  --error-color: #CF6679;
}
```

**主题切换器组件**：
- 实现主题切换开关组件
- 支持手动切换、跟随系统和定时切换三种模式
- 提供平滑的切换动画效果

```javascript
// theme-switcher组件
Component({
  properties: {
    // 组件属性
  },
  
  data: {
    darkMode: false,
    followSystem: false,
    autoChangeTime: null
  },
  
  lifetimes: {
    attached() {
      // 获取当前主题设置
      const app = getApp();
      const themeSettings = wx.getStorageSync('themeSettings') || {};
      
      this.setData({
        darkMode: app.globalData.darkMode,
        followSystem: themeSettings.followSystem || false,
        autoChangeTime: themeSettings.autoChangeTime || null
      });
      
      // 监听主题变化
      this.unwatchTheme = app.watchTheme(darkMode => {
        this.setData({ darkMode });
      });
    },
    
    detached() {
      // 取消主题监听
      if (this.unwatchTheme) {
        this.unwatchTheme();
      }
    }
  },
  
  methods: {
    // 切换暗夜模式
    toggleDarkMode() {
      const app = getApp();
      const newDarkMode = !this.data.darkMode;
      
      // 更新全局主题状态
      app.setDarkMode(newDarkMode);
      
      // 保存设置到本地存储
      this.saveThemeSettings({
        darkMode: newDarkMode,
        followSystem: false,
        autoChangeTime: null
      });
    },
    
    // 设置跟随系统
    setFollowSystem(e) {
      const followSystem = e.detail.value;
      
      if (followSystem) {
        // 获取系统当前主题
        wx.getSystemInfo({
          success: (res) => {
            const systemDarkMode = res.theme === 'dark';
            getApp().setDarkMode(systemDarkMode);
          }
        });
      }
      
      // 保存设置到本地存储
      this.saveThemeSettings({
        followSystem,
        autoChangeTime: null
      });
    },
    
    // 设置定时切换
    setAutoChangeTime(e) {
      const timeRange = e.detail.value;
      // 解析时间范围，设置定时器
      // ...
      
      // 保存设置到本地存储
      this.saveThemeSettings({
        followSystem: false,
        autoChangeTime: timeRange
      });
    },
    
    // 保存主题设置
    saveThemeSettings(settings) {
      const themeSettings = wx.getStorageSync('themeSettings') || {};
      const newSettings = { ...themeSettings, ...settings };
      
      wx.setStorageSync('themeSettings', newSettings);
      
      this.setData({
        followSystem: newSettings.followSystem,
        autoChangeTime: newSettings.autoChangeTime
      });
    }
  }
});
```

**页面和组件适配**：
- 页面通过获取全局主题状态设置data-theme属性
- 组件通过属性接收主题状态或订阅主题变化
- 使用条件样式和动态类名适配不同主题

```javascript
// 页面适配示例
Page({
  data: {
    darkMode: false
  },
  
  onLoad() {
    const app = getApp();
    this.setData({ darkMode: app.globalData.darkMode });
    
    // 监听主题变化
    this.unwatchTheme = app.watchTheme(darkMode => {
      this.setData({ darkMode });
    });
  },
  
  onUnload() {
    // 取消主题监听
    if (this.unwatchTheme) {
      this.unwatchTheme();
    }
  }
});
```

```html
<!-- 页面模板适配示例 -->
<view class="container {{darkMode ? 'dark' : 'light'}}">
  <view class="card">
    <text class="title">标题文本</text>
    <text class="content">内容文本</text>
  </view>
  
  <!-- 传递主题状态给组件 -->
  <custom-component dark-mode="{{darkMode}}"></custom-component>
</view>
```

## 图表与图像暗夜模式优化

图表和图像是心语精灵中重要的视觉元素，我们对其进行了专门的暗夜模式优化：

**ECharts图表适配**：
- 为所有图表组件实现暗夜模式配置
- 调整坐标轴、图例、标签等元素的颜色
- 优化图表配色方案，确保在暗背景下的可读性
- 实现图表主题动态切换

```javascript
// ECharts暗夜模式配置
function getChartTheme(darkMode) {
  return {
    backgroundColor: darkMode ? 'rgba(0,0,0,0)' : 'rgba(0,0,0,0)',
    textStyle: {
      color: darkMode ? '#e0e0e0' : '#333333'
    },
    title: {
      textStyle: {
        color: darkMode ? '#e0e0e0' : '#333333'
      }
    },
    legend: {
      textStyle: {
        color: darkMode ? '#aaaaaa' : '#666666'
      }
    },
    grid: {
      borderColor: darkMode ? '#333333' : '#e0e0e0'
    },
    categoryAxis: {
      axisLine: {
        lineStyle: {
          color: darkMode ? '#555555' : '#cccccc'
        }
      },
      splitLine: {
        lineStyle: {
          color: darkMode ? '#333333' : '#eeeeee'
        }
      },
      axisLabel: {
        color: darkMode ? '#aaaaaa' : '#666666'
      }
    },
    valueAxis: {
      axisLine: {
        lineStyle: {
          color: darkMode ? '#555555' : '#cccccc'
        }
      },
      splitLine: {
        lineStyle: {
          color: darkMode ? '#333333' : '#eeeeee'
        }
      },
      axisLabel: {
        color: darkMode ? '#aaaaaa' : '#666666'
      }
    },
    tooltip: {
      backgroundColor: darkMode ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)',
      borderColor: darkMode ? '#555555' : '#cccccc',
      textStyle: {
        color: darkMode ? '#e0e0e0' : '#333333'
      }
    },
    // 情绪颜色映射
    color: darkMode ? 
      ['#3A7BC8', '#CF6679', '#F57C00', '#9C64A6', '#00B8A9', '#58B19F', '#777777'] : 
      ['#4A90E2', '#F44336', '#FFC107', '#9C27B0', '#00BCD4', '#4CAF50', '#9E9E9E']
  };
}

// 在图表组件中应用主题
function updateChart() {
  const chartOption = {
    ...this.data.baseOption,
    ...getChartTheme(this.data.darkMode)
  };
  
  this.chart.setOption(chartOption);
}
```

**情绪图标适配**：
- 为每种情绪图标准备明暗两套版本
- 根据当前主题自动切换图标
- 优化图标对比度和可见性

```javascript
// 情绪图标适配
const emotionIcons = {
  light: {
    'joy': '/images/emotions/light/joy.png',
    'sadness': '/images/emotions/light/sadness.png',
    'anger': '/images/emotions/light/anger.png',
    'fear': '/images/emotions/light/fear.png',
    'surprise': '/images/emotions/light/surprise.png',
    'disgust': '/images/emotions/light/disgust.png',
    'neutral': '/images/emotions/light/neutral.png'
  },
  dark: {
    'joy': '/images/emotions/dark/joy.png',
    'sadness': '/images/emotions/dark/sadness.png',
    'anger': '/images/emotions/dark/anger.png',
    'fear': '/images/emotions/dark/fear.png',
    'surprise': '/images/emotions/dark/surprise.png',
    'disgust': '/images/emotions/dark/disgust.png',
    'neutral': '/images/emotions/dark/neutral.png'
  }
};

// 获取当前主题下的情绪图标
function getEmotionIcon(emotion, darkMode) {
  const theme = darkMode ? 'dark' : 'light';
  return emotionIcons[theme][emotion] || emotionIcons[theme]['neutral'];
}
```

**角色头像优化**：
- 为角色头像添加适应暗夜模式的边框
- 调整头像亮度和对比度，确保在暗背景下清晰可见
- 实现头像加载占位图的暗夜模式版本

```css
/* 角色头像暗夜模式适配 */
.avatar {
  width: 80rpx;
  height: 80rpx;
  border-radius: 50%;
  border: 2rpx solid var(--border-color);
  background-color: var(--card-bg-color);
}

/* 暗夜模式下增加微光边框效果 */
page[data-theme="dark"] .avatar {
  border: 2rpx solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 8rpx rgba(255, 255, 255, 0.1);
}
```

**图片资源处理**：
- 对背景图片和装饰图片进行暗夜模式适配
- 使用CSS滤镜调整图片亮度和对比度
- 为重要UI元素准备专门的暗夜模式版本

```css
/* 图片暗夜模式适配 */
.bg-image {
  width: 100%;
  height: 300rpx;
}

/* 暗夜模式下调整图片亮度和对比度 */
page[data-theme="dark"] .bg-image {
  filter: brightness(0.8) contrast(1.1);
}

/* 使用不同的背景图片 */
.welcome-bg {
  background-image: url('/images/welcome_bg_light.png');
}

page[data-theme="dark"] .welcome-bg {
  background-image: url('/images/welcome_bg_dark.png');
}
```

## 用户偏好持久化存储

为确保用户的主题设置能够持久保存并在不同会话中保持一致，我们实现了完善的偏好持久化机制：

**本地存储结构**：
- 使用wx.setStorageSync/wx.getStorageSync API存储主题设置
- 主题设置包含暗夜模式状态、跟随系统设置和自动切换时间

```javascript
// 主题设置存储结构
const themeSettings = {
  darkMode: boolean,       // 是否启用暗夜模式
  followSystem: boolean,   // 是否跟随系统设置
  autoChangeTime: {        // 自动切换时间（可选）
    startTime: string,     // 开始时间，格式 "HH:MM"
    endTime: string        // 结束时间，格式 "HH:MM"
  }
};
```

**设置同步机制**：
- 在应用启动时读取本地存储的主题设置
- 在用户修改设置时实时更新本地存储
- 使用try-catch处理存储异常，确保应用稳定性

```javascript
// 读取主题设置
function loadThemeSettings() {
  try {
    return wx.getStorageSync('themeSettings') || {
      darkMode: false,
      followSystem: true,
      autoChangeTime: null
    };
  } catch (e) {
    console.error('读取主题设置失败:', e);
    return {
      darkMode: false,
      followSystem: true,
      autoChangeTime: null
    };
  }
}

// 保存主题设置
function saveThemeSettings(settings) {
  try {
    wx.setStorageSync('themeSettings', settings);
    return true;
  } catch (e) {
    console.error('保存主题设置失败:', e);
    return false;
  }
}
```

**多端同步**：
- 利用云开发数据库存储用户主题偏好
- 在用户登录时同步云端设置到本地
- 在用户修改设置时同步本地设置到云端
- 实现多设备间的主题设置同步

```javascript
// 同步主题设置到云端
async function syncThemeSettingsToCloud() {
  if (!app.globalData.isLoggedIn) return;
  
  try {
    const themeSettings = wx.getStorageSync('themeSettings') || {};
    const db = wx.cloud.database();
    
    await db.collection('user_settings').where({
      _openid: app.globalData.openid
    }).update({
      data: {
        themeSettings: themeSettings,
        updateTime: db.serverDate()
      }
    });
  } catch (e) {
    console.error('同步主题设置到云端失败:', e);
  }
}

// 从云端同步主题设置
async function syncThemeSettingsFromCloud() {
  if (!app.globalData.isLoggedIn) return;
  
  try {
    const db = wx.cloud.database();
    const result = await db.collection('user_settings').where({
      _openid: app.globalData.openid
    }).get();
    
    if (result.data.length > 0 && result.data[0].themeSettings) {
      const cloudSettings = result.data[0].themeSettings;
      wx.setStorageSync('themeSettings', cloudSettings);
      
      // 应用云端设置
      const app = getApp();
      if (cloudSettings.followSystem) {
        // 跟随系统设置
        app.initThemeSettings();
      } else {
        // 使用指定的暗夜模式设置
        app.setDarkMode(cloudSettings.darkMode);
      }
    }
  } catch (e) {
    console.error('从云端同步主题设置失败:', e);
  }
}
```

**设置界面**：
- 在用户中心提供主题设置界面
- 支持手动切换、跟随系统和定时切换三种模式
- 提供实时预览效果，方便用户选择

![图6 主题设置界面](../图片路径)

通过以上暗夜模式适配策略，心语精灵实现了全面、专业的暗夜模式支持，为用户在不同光线环境下提供舒适的使用体验，同时展现了应用的专业品质和对用户体验的重视。
