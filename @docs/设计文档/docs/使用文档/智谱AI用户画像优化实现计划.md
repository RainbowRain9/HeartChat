# 智谱AI用户画像优化实现计划

## 一、项目背景

当前HeartChat微信小程序的用户画像功能使用了预设的基础特征值，并根据用户的情绪记录和兴趣数据进行简单调整。这种方法缺乏个性化和准确性，无法真实反映用户的性格特点和行为模式。

参考`cloudfunctions\roles\userPerception.js`中的实现，我们计划使用智谱AI来分析用户的对话内容，提取更准确的用户画像，从而提高个性分析的准确性和个性化程度。

## 二、优化目标

1. 使用智谱AI分析用户对话内容，提取用户的兴趣、偏好、沟通风格和情感模式
2. 生成更准确、更个性化的用户画像
3. 提供更自然、更友好的个性总结描述
4. 保持与现有系统的兼容性，确保平滑过渡

## 三、实现步骤

### 1. 修改`cloudfunctions\user\userPerception.js`

#### 1.1 添加智谱AI调用功能
- 添加`callZhipuAI`函数，用于调用智谱AI接口
- 确保正确处理API密钥和请求参数
- 添加错误处理和日志记录

#### 1.2 添加用户对话分析功能
- 添加`analyzeUserDialogues`函数，用于从用户对话中提取用户画像
- 查询用户的历史对话记录
- 调用智谱AI分析用户对话内容
- 解析并处理AI返回的结果

#### 1.3 优化个性特征生成
- 修改`generatePersonalityTraits`函数，使用AI分析结果替代预设值
- 保留基于情绪记录和兴趣数据的调整逻辑作为备选
- 确保生成的特征数据格式与现有系统兼容

#### 1.4 优化个性总结生成
- 添加`generateAIPersonalitySummary`函数，使用智谱AI生成更自然的个性描述
- 确保生成的描述友好、自然，不像机器分析报告
- 添加错误处理，在AI生成失败时回退到简单模板

### 2. 修改`cloudfunctions\user\index.js`

- 更新`getUserPerception`函数，调用新的用户画像分析功能
- 确保向前兼容性，处理可能的错误情况

### 3. 创建或确认`cloudfunctions\httpRequest\index.js`

- 如果不存在，创建`httpRequest`云函数
- 实现通用的HTTP请求功能，支持与智谱AI API通信
- 添加适当的错误处理和日志记录

## 四、数据结构

### 用户画像数据结构
```javascript
{
  // 用户兴趣（字符串数组）
  interests: ["阅读", "音乐", "旅行", ...],
  
  // 用户偏好（字符串数组）
  preferences: ["简约风格", "科技产品", ...],
  
  // 沟通风格（字符串）
  communication_style: "用户倾向于使用简洁明了的语言，善于表达自己的想法...",
  
  // 情感模式（字符串数组）
  emotional_patterns: ["情绪稳定", "积极乐观", ...],
  
  // 个性特征（对象数组）
  personalityTraits: [
    { trait: "责任感", score: 0.85 },
    { trait: "创造力", score: 0.75 },
    ...
  ],
  
  // 个性总结（字符串）
  personalitySummary: "你是一个富有创造力和责任感的人，喜欢探索新事物..."
}
```

## 五、注意事项

1. **API密钥管理**：
   - 使用环境变量存储智谱AI API密钥
   - 不要在代码中硬编码API密钥

2. **错误处理**：
   - 添加完善的错误处理机制
   - 在AI分析失败时，回退到现有的基于规则的方法

3. **性能优化**：
   - 考虑缓存用户画像结果，避免频繁调用AI API
   - 限制分析的对话数量，避免请求过大

4. **隐私保护**：
   - 确保用户数据的安全传输和处理
   - 遵循相关的隐私保护规定

## 六、测试计划

1. **单元测试**：
   - 测试`callZhipuAI`函数的正确性
   - 测试用户画像数据处理逻辑

2. **集成测试**：
   - 测试与智谱AI API的集成
   - 测试与现有系统的兼容性

3. **用户测试**：
   - 比较优化前后的用户画像准确性
   - 收集用户反馈，进一步优化

## 七、实施时间表

1. 开发准备（1天）：
   - 环境配置
   - API密钥获取和设置

2. 核心功能开发（2天）：
   - 实现智谱AI调用功能
   - 实现用户对话分析功能

3. 优化和集成（1天）：
   - 优化个性特征和总结生成
   - 与现有系统集成

4. 测试和调优（1天）：
   - 进行各项测试
   - 根据测试结果进行调优

5. 部署和监控（1天）：
   - 部署到生产环境
   - 监控系统运行情况

## 八、预期成果

1. 更准确、更个性化的用户画像
2. 更自然、更友好的个性总结描述
3. 提升用户体验和满意度
4. 为后续个性化功能开发奠定基础
