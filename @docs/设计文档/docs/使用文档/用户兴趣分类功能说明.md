# 用户兴趣分类功能说明

## 功能概述

HeartChat 微信小程序的用户兴趣分类功能是一个核心功能，它能够自动分析用户的对话内容，提取关键词并进行分类，从而构建用户的兴趣画像。这些分类后的兴趣数据被用于生成每日心情报告中的关注点分析，以及用户中心的兴趣标签云展示。

## 数据结构

### 数据库集合

用户兴趣数据存储在 `userInterests` 集合中，主要字段包括：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| userId | String | 用户ID，对应用户的openId |
| keywords | Array | 关键词数组，每个元素包含word、weight、category等字段 |
| categories | Array | 分类数组，每个元素包含name、count、firstSeen、lastUpdated等字段 |
| createTime | Date | 记录创建时间 |
| lastUpdated | Date | 记录最后更新时间 |

### 关键词对象结构

```javascript
{
  word: "计算机组成基础",  // 关键词文本
  weight: 0.8,            // 关键词权重
  category: "科技",        // 关键词分类
  emotionScore: 0,        // 情感分数
  source: "chat",         // 来源
  firstSeen: Date,        // 首次出现时间
  lastUpdated: Date,      // 最后更新时间
  occurrences: 2          // 出现次数
}
```

### 分类对象结构

```javascript
{
  name: "科技",           // 分类名称
  count: 5,              // 该分类下的关键词数量
  firstSeen: Date,       // 首次出现时间
  lastUpdated: Date      // 最后更新时间
}
```

## 工作流程

1. **关键词提取**：从用户对话中提取关键词，包括词语和权重
2. **关键词分类**：调用智谱AI对关键词进行分类，将每个关键词归类到预定义的类别中
3. **分类统计**：统计每个分类下的关键词数量，生成分类统计数据
4. **数据更新**：将分类后的关键词和分类统计数据更新到数据库中
5. **数据应用**：在用户画像、兴趣标签云和每日心情报告中使用这些数据

## 关键代码实现

### 1. 关键词分类

关键词分类通过调用云函数 `analysis` 的 `classify_keywords` 接口实现：

```javascript
// 调用云函数分类关键词
const result = await wx.cloud.callFunction({
  name: 'analysis',
  data: {
    type: 'classify_keywords',
    keywords: keywords.map(k => k.word),
    batch: true
  }
});

// 将分类结果转换为映射
const categoryMap = {};
result.result.data.classifications.forEach(item => {
  categoryMap[item.keyword] = item.category;
});

// 将分类结果合并到关键词中
const classifiedKeywords = keywords.map(keyword => ({
  word: keyword.word,
  weight: keyword.weight,
  category: categoryMap[keyword.word] || '未分类',
  emotionScore: 0
}));
```

### 2. 分类统计

分类统计通过遍历分类后的关键词实现：

```javascript
// 创建分类统计数据
const categoryStats = {};
classifiedKeywords.forEach(keyword => {
  if (keyword.category) {
    categoryStats[keyword.category] = (categoryStats[keyword.category] || 0) + 1;
  }
});

// 创建分类数组
const categoriesArray = Object.entries(categoryStats).map(([name, count]) => ({
  name,
  count,
  firstSeen: new Date(),
  lastUpdated: new Date()
}));
```

### 3. 数据更新

数据更新通过调用云函数 `user` 的 `batchUpdateUserInterests` 接口实现：

```javascript
// 批量更新用户兴趣
const updateResult = await userInterestsService.batchUpdateUserInterests(
  userId,
  classifiedKeywords,
  true, // 自动分类
  categoryStats, // 传递分类统计
  categoriesArray // 传递分类数组
);
```

## 最近修复的问题

在最近的更新中，我们修复了以下问题：

1. **categories 字段为空**：之前 categories 字段没有正确更新，导致分类统计数据丢失。现在已修复，确保每次更新关键词时也同时更新 categories 字段。

2. **数据类型不一致**：之前 categories 字段在某些情况下被存储为对象而非数组，现在已统一为数组格式，并添加了兼容性处理代码。

3. **参数传递不完整**：之前前端调用云函数时没有传递 categoryStats 和 categoriesArray 参数，现在已修复，确保这些参数正确传递。

4. **时间戳缺失**：之前分类对象中缺少时间戳字段，现在已添加 firstSeen 和 lastUpdated 字段，便于追踪分类的时间变化。

## 使用示例

### 在聊天页面中使用

```javascript
// 提取关键词并分类
const keywords = await keywordService.extractKeywords(text, 5);
if (keywords && keywords.length > 0) {
  // 分类关键词
  const result = await wx.cloud.callFunction({
    name: 'analysis',
    data: {
      type: 'classify_keywords',
      keywords: keywords.map(k => k.word),
      batch: true
    }
  });
  
  // 处理分类结果
  if (result.result && result.result.success) {
    // 创建分类映射
    const categoryMap = {};
    result.result.data.classifications.forEach(item => {
      categoryMap[item.keyword] = item.category;
    });
    
    // 更新关键词对象
    keywords.forEach(keyword => {
      keyword.category = categoryMap[keyword.word] || '未分类';
    });
    
    // 创建分类统计
    const categoryStats = {};
    keywords.forEach(keyword => {
      if (keyword.category) {
        categoryStats[keyword.category] = (categoryStats[keyword.category] || 0) + 1;
      }
    });
    
    // 创建分类数组
    const categoriesArray = Object.entries(categoryStats).map(([name, count]) => ({
      name,
      count,
      firstSeen: new Date(),
      lastUpdated: new Date()
    }));
    
    // 更新用户兴趣
    userInterestsService.batchUpdateUserInterests(
      openId, 
      keywords, 
      true, 
      categoryStats, 
      categoriesArray
    );
  }
}
```

### 在用户中心页面中显示兴趣标签

```html
<interest-tag-cloud
  id="interestTagCloud"
  userId="{{openId}}"
  maxTags="30"
  minFontSize="12"
  maxFontSize="20"
  showCategory="{{true}}"
  darkMode="{{darkMode}}"
  bind:tagclick="handleTagClick"
></interest-tag-cloud>
```

## 注意事项

1. **数据一致性**：确保 keywords 数组中的 category 字段与 categories 数组中的统计数据保持一致。

2. **数据类型**：categories 字段必须是数组，而不是对象。如果遇到旧数据是对象格式，需要进行转换。

3. **参数传递**：调用 batchUpdateUserInterests 函数时，必须传递 categoryStats 和 categoriesArray 参数，以确保分类数据正确更新。

4. **时间戳**：每次更新分类数据时，都应更新 lastUpdated 字段，以便追踪分类的时间变化。

5. **缓存处理**：更新用户兴趣数据后，应清除相关缓存，确保下次获取数据时能够获取到最新的数据。

## 相关文件

- `cloudfunctions/user/userInterests.js`：用户兴趣数据处理模块
- `cloudfunctions/analysis/keywordClassifier.js`：关键词分类模块
- `miniprogram/services/userInterestsService.js`：前端用户兴趣服务
- `miniprogram/services/keywordService.js`：前端关键词服务
- `miniprogram/components/interest-tag-cloud/interest-tag-cloud.js`：兴趣标签云组件

## 未来优化方向

1. **分类算法优化**：进一步优化关键词分类算法，提高分类准确率。
2. **用户反馈机制**：添加用户对分类结果的反馈功能，收集分类准确性数据。
3. **分类体系扩展**：扩展预定义分类体系，支持更多细分类别。
4. **时间衰减机制**：实现兴趣权重的时间衰减机制，使最近的兴趣有更高的权重。
5. **多维度分析**：结合情感分析结果，实现多维度的用户兴趣分析。
