# 云函数整合与使用文档

## 一、云函数整合概述

为了优化云函数结构，提高代码复用性和维护效率，我们对原有的多个分散云函数进行了整合，形成了以下四个核心云函数：

1. **chat** - 聊天相关功能
2. **analysis** - 情感分析功能
3. **user** - 用户管理功能
4. **role** - 角色管理功能

## 二、云函数详细说明

### 1. chat 云函数

**功能**：处理聊天相关的所有操作，包括保存聊天记录、获取聊天历史和生成AI回复。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

**支持的操作类型**：

| action | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `save` | 保存聊天记录 | `chatData`: 聊天基本信息<br>`messages`: 消息数组 | `success`: 是否成功<br>`chatId`: 聊天ID<br>`isNewChat`: 是否新对话 |
| `get` | 获取聊天历史 | `userId`: 用户ID<br>`roleId`: 角色ID(可选) | `success`: 是否成功<br>`data`: 聊天记录数组 |
| `reply` | 生成AI回复 | `message`: 用户消息<br>`history`: 历史消息<br>`roleInfo`: 角色信息 | `success`: 是否成功<br>`content`: 回复内容 |

**示例**：
```javascript
// 保存聊天记录
const result = await wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'save',
    chatData: {
      roleId: roleId,
      userId: userId,
      // 其他聊天数据
    },
    messages: messages
  }
});

// 获取聊天历史
const result = await wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'get',
    userId: userId,
    roleId: roleId
  }
});
```

### 2. analysis 云函数

**功能**：处理情感分析相关的所有操作，包括文本情感分析和关键词提取。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'analysis',
  data: {
    type: '分析类型', // 必填参数
    // 其他参数根据type不同而变化
  }
})
```

**支持的分析类型**：

| type | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| `emotion` | 情感分析 | `text`: 待分析文本<br>`saveRecord`: 是否保存记录<br>`roleId`: 角色ID(可选)<br>`chatId`: 聊天ID(可选) | `success`: 是否成功<br>`result`: 分析结果<br>`recordId`: 记录ID |
| `keywords` | 关键词提取 | `text`: 待分析文本<br>`title`: 标题(可选)<br>`num`: 关键词数量 | `success`: 是否成功<br>`keywords`: 关键词数组 |

**示例**：
```javascript
// 情感分析
const result = await wx.cloud.callFunction({
  name: 'analysis',
  data: {
    type: 'emotion',
    text: userMessage,
    saveRecord: true,
    roleId: currentRole._id
  }
});

// 关键词提取
const result = await wx.cloud.callFunction({
  name: 'analysis',
  data: {
    type: 'keywords',
    text: articleContent,
    num: 5
  }
});
```

### 3. user 云函数

**功能**：处理用户相关的所有操作，包括获取用户信息、更新用户资料、获取和更新用户统计数据。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'user',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

**支持的操作类型**：

| action | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `getInfo` | 获取用户信息 | `userId`: 用户ID | `success`: 是否成功<br>`data.user`: 用户信息 |
| `updateProfile` | 更新用户资料 | `userId`: 用户ID<br>`username`: 用户名<br>`avatarUrl`: 头像URL<br>其他用户资料字段 | `success`: 是否成功<br>`data.updatedUser`: 更新后的用户信息 |
| `getStats` | 获取用户统计 | `userId`: 用户ID | `success`: 是否成功<br>`data`: 统计数据 |
| `updateStats` | 更新用户统计 | `userId`: 用户ID<br>`statsType`: 统计类型<br>`value`: 统计值 | `success`: 是否成功<br>`data.stats`: 更新后的统计数据 |

**示例**：
```javascript
// 获取用户信息
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'getInfo',
    userId: userInfo.userId
  }
});

// 更新用户资料
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'updateProfile',
    userId: userInfo.userId,
    username: formData.username,
    avatarUrl: userInfo.avatarUrl,
    // 其他资料字段
  }
});
```

### 4. role 云函数

**功能**：处理角色相关的所有操作，包括获取角色消息统计、角色列表、角色详情和更新角色使用统计。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'role',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

**支持的操作类型**：

| action | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `getMessageStats` | 获取角色消息统计 | `roleIds`: 角色ID数组<br>`userId`: 用户ID | `success`: 是否成功<br>`stats`: 统计数据 |
| `getList` | 获取角色列表 | `userId`: 用户ID(可选)<br>`category`: 分类(可选)<br>`limit`: 限制数量<br>`skip`: 跳过数量 | `success`: 是否成功<br>`data`: 角色列表<br>`total`: 总数 |
| `getDetail` | 获取角色详情 | `roleId`: 角色ID | `success`: 是否成功<br>`data`: 角色详情 |
| `updateUsage` | 更新角色使用统计 | `roleId`: 角色ID<br>`userId`: 用户ID | `success`: 是否成功<br>`data`: 更新结果 |

**示例**：
```javascript
// 获取角色消息统计
const result = await wx.cloud.callFunction({
  name: 'role',
  data: {
    action: 'getMessageStats',
    roleIds: roleIds,
    userId: userId
  }
});

// 获取角色列表
const result = await wx.cloud.callFunction({
  name: 'role',
  data: {
    action: 'getList',
    userId: userId,
    category: 'family',
    limit: 20
  }
});
```

## 三、更改记录

### 2023-04-12 云函数整合

1. **新增云函数**：
   - 创建 `chat` 云函数，整合 `getChatHistory` 和 `saveChatHistory` 功能
   - 创建 `analysis` 云函数，整合 `textAnalysis` 功能
   - 创建 `user` 云函数，整合 `getUserInfo`、`updateUserProfile`、`getUserStats` 和 `updateUserStats` 功能
   - 创建 `role` 云函数，整合 `getRoleMessageStats` 功能

2. **前端调用修改**：
   - 修改 `miniprogram\pages\user\index.js` 中的云函数调用
   - 修改 `miniprogram\pages\user\profile\index.js` 中的云函数调用
   - 修改 `miniprogram\pages\emotionVault\emotionVault.js` 中的云函数调用
   - 修改 `miniprogram\utils\emotionAnalyzer.js` 中的云函数调用
   - 修改 `miniprogram\utils\stats.js` 中的云函数调用
   - 修改 `miniprogram\services\emotionService.js` 中的云函数调用
   - 修改 `miniprogram\utils\emotionHelper.js` 中的云函数调用
   - 修改 `miniprogram\packageA\pages\emotion\analysis.js` 中的云函数调用

3. **删除旧云函数**：
   - 删除 `getChatHistory` 云函数
   - 删除 `saveChatHistory` 云函数
   - 删除 `textAnalysis` 云函数
   - 删除 `getUserInfo` 云函数
   - 删除 `updateUserProfile` 云函数
   - 删除 `getUserStats` 云函数
   - 删除 `updateUserStats` 云函数
   - 删除 `getRoleMessageStats` 云函数
   - 删除 `quickstartFunctions` 云函数（示例云函数）

## 四、注意事项

1. **参数格式**：调用云函数时，必须提供正确的 `action` 或 `type` 参数，否则会返回错误。

2. **错误处理**：所有云函数调用都应该包含适当的错误处理，例如：
   ```javascript
   try {
     const result = await wx.cloud.callFunction({
       name: 'chat',
       data: { action: 'get', userId: userId }
     });
     
     if (!result.result.success) {
       throw new Error(result.result.error || '操作失败');
     }
     
     // 处理成功结果
   } catch (error) {
     console.error('云函数调用失败:', error);
     // 错误处理逻辑
   }
   ```

3. **返回值格式**：所有云函数都会返回包含 `success` 字段的对象，表示操作是否成功。如果失败，会包含 `error` 字段说明错误原因。

4. **权限控制**：确保在云函数中实现适当的权限控制，验证用户身份和操作权限。

5. **数据验证**：在云函数中对输入参数进行验证，确保数据的完整性和安全性。

## 五、未来优化方向

1. **缓存机制**：实现客户端缓存机制，减少云函数调用次数。

2. **批量操作**：支持批量数据操作，提高效率。

3. **实时更新**：集成云开发实时数据库功能，实现数据实时同步。

4. **错误日志**：完善错误日志记录和监控机制。

5. **性能优化**：优化云函数执行效率，减少响应时间。

---

本文档将持续更新，如有任何问题或建议，请联系开发团队。
