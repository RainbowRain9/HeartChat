# HeartChat 情绪分析云函数调用指南

## 1. 概述

HeartChat 微信小程序使用云函数来处理情绪分析相关的后端逻辑。本文档详细介绍了如何在前端调用情绪分析云函数，以及云函数的参数和返回值格式。

## 2. 情绪分析云函数简介

情绪分析云函数 `analysis` 是 HeartChat 的核心功能之一，它负责分析用户的对话内容，识别情绪状态，提取关键词，并生成个性化建议。该云函数基于大型语言模型（GLM-4-Flash）实现，能够提供高质量的情绪分析结果。

## 3. 云函数调用方法

### 3.1 基本调用方式

在小程序前端调用情绪分析云函数的基本方式如下：

```javascript
// 引入情绪分析服务
import { analyzeEmotion } from '../../services/emotionService';

// 调用情绪分析
async function performEmotionAnalysis(messages) {
  try {
    const result = await analyzeEmotion(messages);
    if (result.success) {
      // 处理成功的情况
      const emotionData = result.data;
      // 使用情绪数据...
    } else {
      // 处理失败的情况
      console.error('情绪分析失败:', result.error);
      wx.showToast({
        title: '情绪分析失败',
        icon: 'none'
      });
    }
  } catch (error) {
    console.error('情绪分析出错:', error);
    wx.showToast({
      title: '情绪分析出错',
      icon: 'none'
    });
  }
}
```

### 3.2 emotionService.js 实现

`emotionService.js` 文件封装了情绪分析相关的服务调用，简化了云函数的调用过程：

```javascript
// services/emotionService.js

/**
 * 分析情绪
 * @param {Array} messages 消息数组
 * @param {Object} options 可选参数
 * @returns {Promise} 情绪分析结果
 */
export function analyzeEmotion(messages, options = {}) {
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'analysis',
      data: {
        action: 'analyzeEmotion',
        messages: messages,
        options: options
      }
    })
    .then(res => {
      resolve(res.result);
    })
    .catch(err => {
      console.error('情绪分析云函数调用失败:', err);
      reject(err);
    });
  });
}

/**
 * 获取历史情绪数据
 * @param {String} userId 用户ID
 * @param {Number} days 天数，默认7天
 * @returns {Promise} 历史情绪数据
 */
export function getEmotionHistory(userId, days = 7) {
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'analysis',
      data: {
        action: 'getEmotionHistory',
        userId: userId,
        days: days
      }
    })
    .then(res => {
      resolve(res.result);
    })
    .catch(err => {
      console.error('获取情绪历史数据失败:', err);
      reject(err);
    });
  });
}

/**
 * 保存情绪记录
 * @param {Object} emotionData 情绪数据
 * @returns {Promise} 保存结果
 */
export function saveEmotionRecord(emotionData) {
  return new Promise((resolve, reject) => {
    wx.cloud.callFunction({
      name: 'analysis',
      data: {
        action: 'saveEmotionRecord',
        emotionData: emotionData
      }
    })
    .then(res => {
      resolve(res.result);
    })
    .catch(err => {
      console.error('保存情绪记录失败:', err);
      reject(err);
    });
  });
}
```

## 4. 云函数参数说明

### 4.1 analyzeEmotion 方法

**参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| messages | Array | 是 | 消息数组，每条消息包含 role（角色）和 content（内容）|
| options | Object | 否 | 可选参数 |

**options 参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| includeHistory | Boolean | 否 | 是否包含历史记录分析，默认 false |
| historyDays | Number | 否 | 历史记录天数，默认 7 |
| userId | String | 否 | 用户ID，当 includeHistory 为 true 时必填 |

**消息格式**：

```javascript
const messages = [
  {
    role: 'user', // 用户消息
    content: '今天我感觉很开心，因为完成了一个重要的项目。'
  },
  {
    role: 'assistant', // 助手消息
    content: '恭喜你完成了重要项目！这确实是值得开心的事情。'
  },
  // 更多消息...
];
```

### 4.2 getEmotionHistory 方法

**参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| userId | String | 是 | 用户ID |
| days | Number | 否 | 获取历史数据的天数，默认 7 |

### 4.3 saveEmotionRecord 方法

**参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| emotionData | Object | 是 | 情绪分析数据 |

**emotionData 格式**：

```javascript
const emotionData = {
  userId: 'user123',
  timestamp: Date.now(),
  primary_emotion: 'joy',
  secondary_emotions: ['excitement', 'satisfaction'],
  intensity: 0.85,
  valence: 0.75,
  arousal: 0.6,
  radar_dimensions: {
    trust: 0.8,
    openness: 0.7,
    control: 0.6,
    resistance: 0.3,
    stress: 0.4
  },
  topic_keywords: ['项目', '完成', '重要'],
  emotion_triggers: ['完成项目'],
  suggestions: [
    '继续保持这种积极的状态',
    '可以庆祝一下这个成就'
  ],
  summary: '您当前处于喜悦的情绪状态，主要源于完成了重要项目带来的成就感。'
};
```

## 5. 返回值说明

### 5.1 analyzeEmotion 返回值

**成功返回**：

```javascript
{
  success: true,
  data: {
    primary_emotion: 'joy', // 主要情绪
    secondary_emotions: ['excitement', 'satisfaction'], // 次要情绪
    intensity: 0.85, // 情绪强度，0-1
    valence: 0.75, // 情绪效价，-1到1，正值表示积极情绪
    arousal: 0.6, // 情绪唤醒度，0-1
    trend: 'rising', // 情绪趋势：rising（上升）、falling（下降）、stable（稳定）
    attention_level: 'high', // 注意力水平：low、medium、high
    
    // 雷达图维度
    radar_dimensions: {
      trust: 0.8, // 信任度
      openness: 0.7, // 开放度
      control: 0.6, // 控制感
      resistance: 0.3, // 抗拒度
      stress: 0.4 // 压力水平
    },
    
    // 关键词和触发词
    topic_keywords: ['项目', '完成', '重要'], // 话题关键词
    emotion_triggers: ['完成项目'], // 情绪触发词
    
    // 建议和总结
    suggestions: [
      '继续保持这种积极的状态',
      '可以庆祝一下这个成就'
    ],
    summary: '您当前处于喜悦的情绪状态，主要源于完成了重要项目带来的成就感。'
  }
}
```

**失败返回**：

```javascript
{
  success: false,
  error: '分析失败的原因'
}
```

### 5.2 getEmotionHistory 返回值

**成功返回**：

```javascript
{
  success: true,
  data: [
    {
      date: '2023-12-08', // 日期
      primary_emotion: 'calm', // 主要情绪
      intensity: 0.6, // 情绪强度
      valence: 0.3, // 情绪效价
      arousal: 0.4 // 情绪唤醒度
    },
    {
      date: '2023-12-09',
      primary_emotion: 'joy',
      intensity: 0.7,
      valence: 0.6,
      arousal: 0.5
    },
    // 更多历史数据...
  ]
}
```

**失败返回**：

```javascript
{
  success: false,
  error: '获取历史数据失败的原因'
}
```

### 5.3 saveEmotionRecord 返回值

**成功返回**：

```javascript
{
  success: true,
  data: {
    id: 'record123', // 记录ID
    message: '情绪记录保存成功'
  }
}
```

**失败返回**：

```javascript
{
  success: false,
  error: '保存记录失败的原因'
}
```

## 6. 使用示例

### 6.1 在聊天页面分析情绪

```javascript
// pages/chat/chat.js
import { analyzeEmotion } from '../../services/emotionService';

Page({
  data: {
    messages: [],
    emotionData: null
  },
  
  // 分析当前聊天的情绪
  analyzeCurrentEmotion: function() {
    wx.showLoading({
      title: '分析中...',
    });
    
    analyzeEmotion(this.data.messages)
      .then(result => {
        wx.hideLoading();
        if (result.success) {
          this.setData({
            emotionData: result.data
          });
          
          // 显示情绪分析面板
          this.selectComponent('#emotionDashboard').show(result.data);
        } else {
          wx.showToast({
            title: '分析失败: ' + result.error,
            icon: 'none'
          });
        }
      })
      .catch(error => {
        wx.hideLoading();
        wx.showToast({
          title: '分析出错',
          icon: 'none'
        });
        console.error('情绪分析出错:', error);
      });
  }
});
```

### 6.2 获取并显示情绪历史

```javascript
// pages/emotionHistory/emotionHistory.js
import { getEmotionHistory } from '../../services/emotionService';

Page({
  data: {
    historyData: [],
    loading: false
  },
  
  onLoad: function() {
    this.loadEmotionHistory();
  },
  
  loadEmotionHistory: function() {
    const userId = getApp().globalData.userInfo.userId;
    
    this.setData({ loading: true });
    
    getEmotionHistory(userId, 30) // 获取30天的历史数据
      .then(result => {
        this.setData({ loading: false });
        
        if (result.success) {
          this.setData({
            historyData: result.data
          });
          
          // 初始化历史图表
          this.initHistoryChart();
        } else {
          wx.showToast({
            title: '获取历史失败: ' + result.error,
            icon: 'none'
          });
        }
      })
      .catch(error => {
        this.setData({ loading: false });
        wx.showToast({
          title: '获取历史出错',
          icon: 'none'
        });
        console.error('获取情绪历史出错:', error);
      });
  },
  
  initHistoryChart: function() {
    // 初始化图表的代码...
  }
});
```

### 6.3 保存情绪记录

```javascript
// components/emotion-dashboard/emotion-dashboard.js
import { saveEmotionRecord } from '../../services/emotionService';

Component({
  methods: {
    // 保存情感记录
    saveEmotion: function() {
      const emotionData = this.data.emotion;
      const userId = getApp().globalData.userInfo.userId;
      
      // 添加用户ID和时间戳
      emotionData.userId = userId;
      emotionData.timestamp = Date.now();
      
      wx.showLoading({
        title: '保存中...',
      });
      
      saveEmotionRecord(emotionData)
        .then(result => {
          wx.hideLoading();
          
          if (result.success) {
            wx.showToast({
              title: '记录已保存',
              icon: 'success'
            });
            
            // 触发保存成功事件
            this.triggerEvent('saveSuccess', {
              recordId: result.data.id
            });
          } else {
            wx.showToast({
              title: '保存失败: ' + result.error,
              icon: 'none'
            });
          }
        })
        .catch(error => {
          wx.hideLoading();
          wx.showToast({
            title: '保存出错',
            icon: 'none'
          });
          console.error('保存情绪记录出错:', error);
        });
    }
  }
});
```

## 7. 错误处理

在调用情绪分析云函数时，可能会遇到各种错误。以下是常见错误及其处理方法：

### 7.1 网络错误

**症状**：云函数调用失败，返回网络相关错误。

**处理方法**：
1. 检查网络连接
2. 实现重试机制
3. 提供友好的错误提示

```javascript
function callWithRetry(fn, retries = 3, delay = 1000) {
  return new Promise((resolve, reject) => {
    fn()
      .then(resolve)
      .catch(error => {
        if (retries === 0) {
          return reject(error);
        }
        
        setTimeout(() => {
          callWithRetry(fn, retries - 1, delay)
            .then(resolve)
            .catch(reject);
        }, delay);
      });
  });
}

// 使用重试机制调用云函数
callWithRetry(() => analyzeEmotion(messages))
  .then(result => {
    // 处理结果
  })
  .catch(error => {
    wx.showToast({
      title: '网络错误，请稍后再试',
      icon: 'none'
    });
  });
```

### 7.2 参数错误

**症状**：云函数返回参数相关的错误。

**处理方法**：
1. 在调用前验证参数
2. 提供明确的错误信息

```javascript
function validateMessages(messages) {
  if (!Array.isArray(messages)) {
    return '消息必须是数组';
  }
  
  if (messages.length === 0) {
    return '消息数组不能为空';
  }
  
  for (const msg of messages) {
    if (!msg.role || !msg.content) {
      return '消息格式不正确，缺少role或content字段';
    }
  }
  
  return null; // 验证通过
}

// 调用前验证参数
const validationError = validateMessages(messages);
if (validationError) {
  wx.showToast({
    title: validationError,
    icon: 'none'
  });
  return;
}

// 验证通过后调用云函数
analyzeEmotion(messages)
  .then(result => {
    // 处理结果
  })
  .catch(error => {
    // 处理错误
  });
```

### 7.3 超时错误

**症状**：云函数调用超时。

**处理方法**：
1. 优化云函数执行时间
2. 对于耗时操作，考虑使用异步处理
3. 提供加载状态反馈

```javascript
// 显示加载状态
wx.showLoading({
  title: '分析中...',
  mask: true // 防止用户操作
});

// 设置超时处理
const timeout = setTimeout(() => {
  wx.hideLoading();
  wx.showToast({
    title: '分析超时，请稍后再试',
    icon: 'none'
  });
}, 30000); // 30秒超时

// 调用云函数
analyzeEmotion(messages)
  .then(result => {
    clearTimeout(timeout); // 清除超时
    wx.hideLoading();
    // 处理结果
  })
  .catch(error => {
    clearTimeout(timeout); // 清除超时
    wx.hideLoading();
    // 处理错误
  });
```

## 8. 性能优化建议

1. **减少不必要的调用**：只在需要时调用情绪分析，避免频繁调用
2. **优化消息数据**：只传递必要的消息，减少数据量
3. **实现缓存机制**：缓存最近的分析结果，避免重复分析
4. **分批处理大量数据**：对于大量历史数据，考虑分页或分批获取
5. **优化用户体验**：使用骨架屏、加载动画等提升感知性能

## 9. 安全注意事项

1. **敏感信息处理**：避免在消息中包含敏感个人信息
2. **数据验证**：在前端和云函数中都进行数据验证
3. **错误信息安全**：避免在错误信息中暴露敏感信息
4. **权限控制**：确保只有授权用户能访问自己的情绪数据
5. **数据加密**：考虑对敏感数据进行加密存储

## 10. 参考资源

- [微信小程序云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云函数开发指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/getting-started.html)
- [GLM-4 API 文档](https://open.bigmodel.cn/dev/api)

---

*本文档最后更新于：2023年12月15日*
