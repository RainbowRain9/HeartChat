# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

HeartChat 是一个基于微信小程序云开发的 AI 情感陪伴与情商提升应用。主要功能包括：
- 与可定制的 AI 角色进行对话
- 实时情感分析和情绪跟踪
- 用户画像和兴趣分析
- 每日心情报告生成
- 角色管理和个性化体验

## 开发环境设置

### 必要条件
- 微信开发者工具
- Node.js 14+
- npm 或 yarn
- 微信开发者账号（已开通云开发）

### 云开发环境配置
- **环境ID**: `cloud1-9gpfk3ie94d8630a`
- **环境名称**: `heartchat-prod`
- **环境变量**: 参考docs/云开发配置指南.md

### 本地开发启动
```bash
# 安装依赖
npm install

# 开发模式（微信小程序需要在开发者工具中打开）
npm run dev

# 构建生产版本
npm run build

# 运行测试
npm test

# 代码检查
npm run lint

# 自动修复代码格式
npm run lint:fix

# 格式化代码
npm run format

# 清理构建文件
npm run clean
```

## 项目架构

### 技术栈
- **前端**: 微信小程序原生框架 (JavaScript)
- **后端**: 微信云开发 (Node.js 云函数)
- **数据库**: 云数据库 (MongoDB 风格)
- **AI服务**: 智谱AI (GLM-4-Flash, Embedding-3)
- **图表**: ECharts
- **UI组件**: Vant Weapp

### 目录结构
```
HeartChat/
├── cloudfunctions/           # 云函数目录
│   ├── analysis/             # 情感分析云函数
│   ├── chat/                 # 聊天相关云函数
│   ├── roles/                # 角色管理云函数
│   ├── login/                # 用户登录云函数
│   └── user/                 # 用户管理云函数
├── miniprogram/              # 小程序前端代码
│   ├── components/           # 公共组件
│   ├── pages/                # 页面
│   ├── packageA/             # 分包A - 情感相关
│   ├── packageB/             # 分包B - 组件相关
│   ├── packageChat/          # 聊天分包
│   ├── services/             # 业务服务
│   ├── utils/                # 工具函数
│   └── models/               # 数据模型
├── docs/                     # 项目文档
└── scripts/                  # 构建脚本
```

### 核心云函数

#### analysis - 情感分析云函数
- **功能**: 基于智谱AI的情感分析、关键词提取、用户兴趣分析
- **主要接口**:
  - `emotion`: 情感分析
  - `keywords`: 关键词提取
  - `user_interests`: 用户兴趣分析
  - `daily_report`: 生成每日报告

#### chat - 聊天云函数
- **功能**: 处理聊天消息、AI回复生成、消息分段输出
- **主要接口**:
  - `sendMessage`: 发送消息并获取AI回复
  - `getChatHistory`: 获取聊天历史
  - `saveChatHistory`: 保存聊天记录

#### roles - 角色管理云函数
- **功能**: 角色的创建、查询、更新、删除、提示词生成
- **主要接口**:
  - `getRoles`: 获取角色列表
  - `createRole`: 创建角色
  - `updateRole`: 更新角色
  - `generatePrompt`: 生成角色提示词

### 数据库设计

#### 主要集合
- `users`: 用户基础信息
- `roles`: 角色信息
- `chats`: 聊天会话信息
- `messages`: 消息详情
- `emotionRecords`: 情感分析记录
- `userReports`: 用户每日报告
- `userInterests`: 用户兴趣数据

### 前端组件架构

#### 核心组件
- `chat-bubble`: 聊天气泡组件
- `chat-input`: 聊天输入组件
- `emotion-analysis`: 情感分析组件
- `emotion-panel`: 情感面板组件
- `interest-tag-cloud`: 兴趣标签云组件
- `role-card`: 角色卡片组件

#### 页面结构
- `role-select`: 角色选择页面（原心情树洞）
- `user/`: 用户中心相关页面
- `emotionVault/`: 聊天页面
- `packageA/emotion/`: 情感分析相关页面

## 开发规范

### 代码规范
- 使用 ESLint 进行代码检查
- 使用 Prettier 进行代码格式化
- 采用 JavaScript 标准规范
- 使用 Husky 和 lint-staged 进行提交前检查

### 命名规范
- 文件名：小写字母，用连字符连接（如 `emotion-panel.js`）
- 变量名：驼峰命名法（如 `userInfo`）
- 常量：全大写，用下划线连接（如 `MAX_COUNT`）
- 函数名：驼峰命名法（如 `getUserInfo`）
- 组件名：大驼峰命名法（如 `EmotionPanel`）

### 注释规范
- 文件头部添加描述注释
- 函数头部添加功能描述、参数和返回值注释
- 复杂逻辑添加行内注释
- 使用 JSDoc 风格的注释

### Git 提交规范
提交信息格式：`[类型] 简短描述`
- 类型包括：feat(新功能)、fix(修复)、docs(文档)、style(格式)、refactor(重构)、test(测试)、chore(构建/工具)
- 每次提交尽量只做一件事

## 关键功能实现

### 聊天系统
- 消息分段输出：AI回复按自然段落分段显示
- 智能欢迎语：根据角色关系类型生成个性化欢迎语
- 历史记录加载：支持分页加载和缓存机制
- 键盘弹出优化：动态调整布局，确保消息不被遮挡

### 情感分析系统
- 多维度情绪分析：识别情绪类型、强度和变化趋势
- 关键词提取：智能提取用户关注的话题
- 情感可视化：使用 ECharts 展示情绪数据
- 实时分析：消息发送后自动进行情感分析

### 角色系统
- 角色分类：情感支持、心理咨询、生活伙伴、职场导师
- 提示词生成：基于角色特征自动生成个性化提示词
- 角色使用统计：记录用户与各角色的交互数据
- 自定义角色：用户可以创建和编辑自己的角色

### 用户画像系统
- 兴趣分析：基于对话内容分析用户兴趣
- 性格特征：生成用户性格特征雷达图
- 情绪概览：展示用户情绪变化趋势
- 个性化建议：基于用户特征提供个性化建议

## 调试与测试

### 本地调试
1. 使用微信开发者工具打开项目
2. 开启调试模式
3. 使用 Console 面板查看日志
4. 使用 Network 面板监控网络请求
5. 使用云开发控制台查看云函数和数据库

### 测试策略
- 单元测试：测试核心算法和工具函数
- 集成测试：测试云函数和页面交互
- 使用 Jest 进行测试，配置文件：`jest.config.js`
- 测试覆盖率要求：80% 以上

### 性能优化
- 消息分段加载，避免一次性加载过多内容
- 本地缓存机制，减少网络请求
- 图表懒加载，提高页面加载速度
- 云函数结果缓存，避免重复计算

## 部署说明

### 云函数部署
1. 在微信开发者工具中，选择云开发环境
2. 右键点击 `cloudfunctions` 目录中的云函数
3. 选择"云函数：上传并部署"
4. 确保所有依赖已正确安装

### 数据库初始化
1. 在云开发控制台创建所需集合
2. 创建必要的索引
3. 初始化系统角色数据
4. 配置系统参数

### 环境配置
- 开发环境：使用开发环境的云开发 ID
- 生产环境：使用生产环境的云开发 ID
- 环境变量：配置智谱AI API 密钥等敏感信息

## 常见问题

### 开发问题
1. **云函数调用失败**: 检查云环境 ID 和权限配置
2. **图表不显示**: 确保 ECharts 组件正确引入和初始化
3. **样式问题**: 检查 CSS 选择器和样式优先级
4. **数据加载失败**: 检查网络请求和数据库权限

### 性能问题
1. **页面加载慢**: 优化图片资源和代码分包
2. **消息发送延迟**: 检查云函数性能和网络状况
3. **内存占用高**: 及时清理不需要的数据和监听器

## 注意事项

- 敏感信息（如 API 密钥）必须存储在云函数环境变量中
- 遵循微信小程序开发规范和平台政策
- 定期备份重要数据和代码
- 保持代码和文档的同步更新
- 监控云开发资源使用量，避免超出免费额度
- 合理使用缓存策略，优化云函数性能
- 定期检查和优化数据库索引