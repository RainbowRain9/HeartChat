# 🚀 HeartChat 云开发重新部署计划

## 📋 部署概览

**预计完成时间：** 1-2天  
**部署难度：** 中等  
**风险等级：** 低  

## 🎯 部署前准备

### 1. 环境准备清单
- [ ] 微信开发者工具已安装并登录
- [ ] 微信小程序账号已开通云开发
- [ ] 智谱AI API密钥已申请
- [ ] 项目代码已准备就绪

### 2. 资源需求
- **云开发环境：** 1个新环境
- **云函数：** 13个主要云函数
- **数据库集合：** 9个主要集合
- **存储桶：** 1个用于图片和文件存储

## 🛠️ 详细部署步骤

### 第一步：创建云开发环境

#### 1.1 创建新环境
```bash
# 在微信开发者工具中操作
1. 点击工具栏"云开发"按钮
2. 选择"开通云开发"
3. 选择环境创建（建议选择按量付费）
4. 记录环境ID（格式：cloud1-xxxxxxxxxxxxx）
5. 环境名称：heartchat-prod
```

#### 1.2 配置环境变量
```javascript
// 在云开发控制台 -> 设置 -> 环境变量中添加
ZHIPUAI_API_KEY = "your_zhipuai_api_key"
ZHIPUAI_BASE_URL = "https://open.bigmodel.cn/api/paas/v4/"
ENVIRONMENT = "production"
```

#### 1.3 更新项目配置
```javascript
// miniprogram/app.js 更新环境ID
App({
  onLaunch() {
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力')
    } else {
      wx.cloud.init({
        env: 'cloud1-9gpfk3ie94d8630a', // 替换为新的环境ID
        traceUser: true,
      })
    }
  }
})
```

### 第二步：部署云函数

#### 2.1 核心云函数部署（按优先级排序）

**优先级1：基础服务**
```bash
# 1. login 云函数
# 路径：cloudfunctions/login
npm install --save wx-server-sdk axios
# 右键点击 login 目录 -> 云函数：上传并部署：云端安装依赖

# 2. user 云函数
# 路径：cloudfunctions/user
npm install --save wx-server-sdk axios
# 右键点击 user 目录 -> 云函数：上传并部署：云端安装依赖
```

**优先级2：核心业务**
```bash
# 3. analysis 云函数（最重要）
# 路径：cloudfunctions/analysis
npm install --save wx-server-sdk axios
# 右键点击 analysis 目录 -> 云函数：上传并部署：云端安装依赖

# 4. chat 云函数
# 路径：cloudfunctions/chat
npm install --save wx-server-sdk axios
# 右键点击 chat 目录 -> 云函数：上传并部署：云端安装依赖
```

**优先级3：辅助功能**
```bash
# 5. roles 云函数
# 路径：cloudfunctions/roles
npm install --save wx-server-sdk

# 6. emotion 云函数
# 路径：cloudfunctions/emotion
npm install --save wx-server-sdk

# 7. generateDailyReports 云函数
# 路径：cloudfunctions/generateDailyReports
npm install --save wx-server-sdk axios

# 8. 其他云函数...
# getEmotionRecords, getRoleInfo, quickstartFunctions 等
```

#### 2.2 云函数配置优化

```javascript
// analysis 云函数内存配置（512MB）
// 在云开发控制台 -> 云函数 -> analysis -> 编辑
{
  "memorySize": 512,
  "timeout": 20,
  "environment": {
    "ZHIPUAI_API_KEY": "your_api_key"
  }
}

// chat 云函数配置（256MB）
{
  "memorySize": 256,
  "timeout": 15
}
```

### 第三步：数据库初始化

#### 3.1 创建数据库集合

```javascript
// 在云开发控制台 -> 数据库 中创建以下集合

// 1. users - 用户信息
db.createCollection('users', {
  // 用户基础信息
  // _id, openid, nickname, avatar, create_time, update_time
})

// 2. roles - 角色信息
db.createCollection('roles', {
  // 角色定义
  // _id, name, description, avatar, prompt, category
})

// 3. chats - 聊天会话
db.createCollection('chats', {
  // 会话信息
  // _id, user_id, role_id, title, create_time, update_time
})

// 4. messages - 消息记录
db.createCollection('messages', {
  // 消息详情
  // _id, chat_id, user_id, content, type, timestamp
})

// 5. emotionRecords - 情感分析记录
db.createCollection('emotionRecords', {
  // 情感分析结果
  // _id, user_id, message_id, emotion_data, analysis_time
})

// 6. userReports - 用户报告
db.createCollection('userReports', {
  // 每日报告
  // _id, user_id, report_data, report_date
})

// 7. userInterests - 用户兴趣
db.createCollection('userInterests', {
  // 兴趣标签
  // _id, user_id, interests, update_time
})

// 8. roleUsage - 角色使用统计
db.createCollection('roleUsage', {
  // 使用统计
  // _id, user_id, role_id, usage_count, last_use_time
})

// 9. sys_config - 系统配置
db.createCollection('sys_config', {
  // 系统配置
  // _id, config_key, config_value, description
})
```

#### 3.2 创建数据库索引

```javascript
// messages 集合索引
db.collection('messages').addIndex({
  "chat_id": 1,
  "timestamp": -1
})

// emotionRecords 集合索引
db.collection('emotionRecords').addIndex({
  "user_id": 1,
  "analysis_time": -1
})

// userReports 集合索引
db.collection('userReports').addIndex({
  "user_id": 1,
  "report_date": -1
})
```

#### 3.3 初始化基础数据

```javascript
// 初始化预设角色数据
const initialRoles = [
  {
    name: "情感倾听者",
    description: "温柔体贴的情感支持伙伴",
    avatar: "/assets/roles/emotional.png",
    category: "emotional",
    prompt: "你是一位温柔体贴的情感倾听者...",
    is_default: true
  },
  {
    name: "心理咨询师",
    description: "专业的心理咨询顾问",
    avatar: "/assets/roles/therapist.png", 
    category: "therapy",
    prompt: "你是一位专业的心理咨询师...",
    is_default: true
  },
  {
    name: "生活伙伴",
    description: "贴心的生活陪伴者",
    avatar: "/assets/roles/companion.png",
    category: "companion",
    prompt: "你是一位贴心的生活伙伴...",
    is_default: true
  },
  {
    name: "职场导师",
    description: "经验丰富的职场指导者",
    avatar: "/assets/roles/mentor.png",
    category: "career",
    prompt: "你是一位经验丰富的职场导师...",
    is_default: true
  }
]

// 批量插入角色数据
await db.collection('roles').add(initialRoles)
```

### 第四步：测试验证计划

#### 4.1 功能测试清单

**基础功能测试**
- [ ] 小程序启动正常
- [ ] 用户登录授权正常
- [ ] 云函数调用正常
- [ ] 数据库读写正常

**核心功能测试**
- [ ] 角色选择页面显示正常
- [ ] 聊天功能正常（发送消息、接收回复）
- [ ] 情感分析功能正常
- [ ] 用户报告生成正常

**AI服务测试**
- [ ] 智谱AI API调用正常
- [ ] 情感分析结果准确
- [ ] 聊天回复质量正常

#### 4.2 性能测试

```javascript
// 测试用例1：聊天响应时间
// 预期：消息发送到接收回复 < 5秒

// 测试用例2：情感分析响应时间
// 预期：分析结果返回 < 3秒

// 测试用例3：并发用户测试
// 预期：支持10个并发用户同时聊天
```

#### 4.3 错误处理测试

```javascript
// 测试场景1：网络中断
// 模拟网络断开，检查错误提示

// 测试场景2：AI API调用失败
// 模拟API返回错误，检查降级处理

// 测试场景3：数据库连接失败
// 模拟数据库异常，检查错误处理
```

### 第五步：监控和优化

#### 5.1 设置监控告警

```javascript
// 在云开发控制台设置告警
1. 云函数监控
   - 执行成功率 < 95%
   - 执行时间 > 10秒
   
2. 数据库监控
   - 查询响应时间 > 1秒
   - 存储空间使用率 > 80%
   
3. API调用监控
   - 智谱AI API调用失败率 > 5%
```

#### 5.2 成本优化策略

```javascript
// 1. 实现AI结果缓存
// 对相同的情感分析结果进行缓存，减少重复调用

// 2. 优化数据库查询
// 添加合适的索引，避免全表扫描

// 3. 数据清理策略
// 定期清理过期的聊天记录和分析数据
```

## 📊 部署时间表

| 时间 | 任务 | 预计用时 | 负责人 |
|------|------|----------|--------|
| Day 1 上午 | 环境创建和配置 | 2小时 | 开发者 |
| Day 1 下午 | 云函数部署 | 4小时 | 开发者 |
| Day 2 上午 | 数据库初始化 | 2小时 | 开发者 |
| Day 2 下午 | 功能测试 | 3小时 | 测试者 |
| Day 2 晚上 | 性能优化 | 2小时 | 开发者 |

## 🚨 常见问题处理

### 问题1：云函数部署失败
```javascript
// 解决方案：
1. 检查 package.json 依赖是否正确
2. 确保网络连接正常
3. 检查云开发环境是否正确配置
4. 重启微信开发者工具
```

### 问题2：数据库连接失败
```javascript
// 解决方案：
1. 检查环境ID是否正确
2. 确认数据库集合已创建
3. 检查数据库权限设置
4. 验证小程序是否已正确初始化云开发
```

### 问题3：AI API调用失败
```javascript
// 解决方案：
1. 检查API密钥是否正确配置
2. 确认API密钥是否有效
3. 检查网络连接是否正常
4. 验证API调用格式是否正确
```

## 📝 部署检查清单

### 部署前检查
- [ ] 微信开发者工具版本 >= 1.05.2111300
- [ ] 小程序基础库版本 >= 2.2.3
- [ ] 智谱AI API密钥已申请
- [ ] 项目代码已完整准备

### 部署中检查
- [ ] 云开发环境创建成功
- [ ] 环境变量配置正确
- [ ] 云函数部署无错误
- [ ] 数据库集合创建成功
- [ ] 基础数据初始化完成

### 部署后检查
- [ ] 小程序启动正常
- [ ] 用户登录功能正常
- [ ] 聊天功能正常
- [ ] 情感分析功能正常
- [ ] 性能指标符合预期

## 🎯 总结

这个部署计划涵盖了HeartChat项目重新部署到云开发环境的所有关键步骤。按照这个计划执行，您可以在1-2天内完成整个部署过程。

**关键成功因素：**
1. **环境配置准确**：确保环境ID和API密钥配置正确
2. **云函数完整部署**：按优先级顺序部署，核心功能优先
3. **数据库结构正确**：确保集合和索引创建正确
4. **测试验证充分**：进行全面的功能和性能测试

---

**文档版本：** v1.0  
**创建时间：** 2025-01-09  
**最后更新：** 2025-01-09  
**作者：** HeartChat开发团队