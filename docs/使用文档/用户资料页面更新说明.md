# 用户资料页面更新说明

## 更新内容概述

本次更新主要针对用户资料页面进行了全面优化，解决了云函数返回错误时的处理问题，并改进了数据加载和保存逻辑。主要更新内容如下：

1. 优化了用户资料页面的数据加载逻辑，直接使用本地缓存中的 `userInfo` 数据填充页面
2. 修改了用户资料保存逻辑，确保昵称（nickName）用于修改数据库 `user_base` 表的 `username` 字段
3. 改进了数据库交互方式，直接更新数据库中的两个表（`user_base` 和 `user_profile`），而不是调用云函数
4. 增强了错误处理和日志输出，提供了更详细的错误信息
5. 优化了本地缓存管理，确保缓存中的数据与数据库保持一致

## 详细修改说明

### 1. 用户资料页面数据加载优化

修改了 `profile.js` 中的 `loadUserData` 函数，使其直接从本地缓存中获取用户信息，而不是从数据库或云函数获取：

```javascript
loadUserData: function () {
  try {
    // 直接从本地缓存获取用户信息
    const loginInfo = wx.getStorageSync('loginInfo') || {};
    let userInfo = loginInfo.userInfo || {};
    
    // 如果没有loginInfo，尝试使用userInfo
    if (!userInfo || Object.keys(userInfo).length === 0) {
      userInfo = wx.getStorageSync('userInfo') || {};
    }
    
    console.log('从本地缓存获取的用户信息:', userInfo);
    
    // 确保有用户ID
    const userId = userInfo.userId || '6457751';
    
    // 处理昵称和username，确保两者一致
    if (!userInfo.nickName && userInfo.username) {
      userInfo.nickName = userInfo.username;
    } else if (!userInfo.username && userInfo.nickName) {
      userInfo.username = userInfo.nickName;
    } else if (!userInfo.nickName && !userInfo.username) {
      userInfo.nickName = '微信用户';
      userInfo.username = '微信用户';
    }
    
    // 确保有默认值
    userInfo = {
      nickName: userInfo.nickName || '微信用户',
      username: userInfo.username || userInfo.nickName || '微信用户',
      avatarUrl: userInfo.avatarUrl || '',
      gender: userInfo.gender || 1,
      age: userInfo.age || 25,
      bio: userInfo.bio || '',
      ...userInfo
    };
    
    // 更新本地缓存
    wx.setStorageSync('userInfo', userInfo);
    
    // 其他代码...
  } catch (error) {
    // 错误处理...
  }
}
```

### 2. 昵称与用户名同步处理

修改了 `handleNicknameInput` 函数，确保昵称（nickName）和用户名（username）保持一致：

```javascript
handleNicknameInput: function (e) {
  const userInfo = this.data.userInfo;
  userInfo.nickName = e.detail.value;
  userInfo.username = e.detail.value; // 同时更新username字段
  
  this.setData({
    userInfo: userInfo
  });
}
```

### 3. 数据库交互优化

修改了 `userService.js` 中的 `saveUserProfile` 函数，直接更新数据库中的两个表（`user_base` 和 `user_profile`），而不是调用云函数：

```javascript
async function saveUserProfile(userId, profileData) {
  try {
    console.log('开始保存用户资料:', userId, profileData);
    
    if (!userId || !profileData) {
      console.warn('保存用户资料失败: 参数不完整');
      return false;
    }

    // 提取基本信息和详细资料
    const { nickName, avatarUrl, username } = profileData;
    const { gender, age, bio } = profileData;
    
    // 确保 username 和 nickName 一致
    const finalUsername = username || nickName || '微信用户';
    
    const db = wx.cloud.database();
    let success = true;
    
    // 1. 更新 user_base 表
    try {
      console.log('更新user_base表');
      const userBaseResult = await db.collection('user_base')
        .where({ user_id: userId })
        .update({
          data: {
            username: finalUsername,
            avatar_url: avatarUrl,
            updated_at: db.serverDate()
          }
        });
      
      // 如果没有更新任何记录，可能是因为记录不存在
      if (userBaseResult.stats && userBaseResult.stats.updated === 0) {
        // 尝试添加新记录...
      }
    } catch (error) {
      console.error('更新user_base表失败:', error);
      success = false;
    }
    
    // 2. 更新 user_profile 表
    try {
      console.log('更新user_profile表');
      const userProfileResult = await db.collection('user_profile')
        .where({ user_id: userId })
        .update({
          data: {
            username: finalUsername,
            avatar_url: avatarUrl,
            gender: gender,
            age: age,
            bio: bio,
            country: profileData.country || '',
            province: profileData.province || '',
            city: profileData.city || '',
            updated_at: db.serverDate()
          }
        });
      
      // 如果没有更新任何记录，可能是因为记录不存在
      if (userProfileResult.stats && userProfileResult.stats.updated === 0) {
        // 尝试添加新记录...
      }
    } catch (error) {
      console.error('更新user_profile表失败:', error);
      success = false;
    }
    
    if (success) {
      // 更新缓存
      cacheUserProfile(userId, profileData);
      
      // 更新本地存储的userInfo
      updateLocalUserInfo(profileData);
      
      console.log('用户资料保存成功');
      return true;
    } else {
      console.warn('保存用户资料失败');
      return false;
    }
  } catch (error) {
    console.error('保存用户资料异常:', error);
    return false;
  }
}
```

### 4. 错误处理和日志输出增强

在 `getUserProfileFromDB` 函数中增加了更多的错误处理和日志输出，并提供了默认值：

```javascript
async function getUserProfileFromDB(userId) {
  try {
    console.log('从数据库获取用户详细资料, userId:', userId);

    const db = wx.cloud.database();
    let userBaseData = null;
    
    // 首先查询user_base集合获取用户名和头像
    try {
      const userBaseResult = await db.collection('user_base')
        .where({ user_id: userId })
        .get();
      
      console.log('user_base查询结果:', userBaseResult);
      
      if (userBaseResult.data && userBaseResult.data.length > 0) {
        userBaseData = userBaseResult.data[0];
      }
    } catch (error) {
      console.error('查询user_base表失败:', error);
    }

    // 然后查询user_profile集合获取详细资料
    const profileResult = await db.collection('user_profile')
      .where({ user_id: userId })
      .get();

    console.log('user_profile查询结果:', profileResult);
    
    // 如果找到了记录，处理数据
    if (profileResult.data && profileResult.data.length > 0) {
      const profileData = profileResult.data[0];
      
      // 优先使用user_base表中的username和avatar_url
      const username = userBaseData ? userBaseData.username : profileData.username || '';
      const avatarUrl = userBaseData ? userBaseData.avatar_url : profileData.avatar_url || '';

      // 构建用户资料
      return {
        username: username,
        avatarUrl: avatarUrl,
        userId: profileData.user_id || userId,
        nickName: username, // 使用username作为nickName
        gender: profileData.gender || 1,
        age: profileData.age || 25,
        bio: profileData.bio || ''
      };
    }
    
    // 如果仍然没有找到记录，但有user_base数据
    if (userBaseData) {
      return {
        username: userBaseData.username || '微信用户',
        avatarUrl: userBaseData.avatar_url || '',
        userId: userId,
        nickName: userBaseData.username || '微信用户',
        gender: 1,
        age: 25,
        bio: ''
      };
    }
    
    // 如果什么都没有，返回默认值
    return {
      username: '微信用户',
      avatarUrl: '',
      userId: userId,
      nickName: '微信用户',
      gender: 1,
      age: 25,
      bio: ''
    };
  } catch (error) {
    console.error('从数据库获取用户详细资料失败:', error);
    // 返回默认值...
  }
}
```

### 5. 本地缓存管理优化

修改了 `updateLocalUserInfo` 函数，确保缓存中的数据与数据库保持一致：

```javascript
function updateLocalUserInfo(profileData) {
  try {
    // 获取当前存储的用户信息
    const userInfo = wx.getStorageSync('userInfo') || {};

    // 确保 username 和 nickName 一致
    const finalNickName = profileData.nickName || userInfo.nickName || '微信用户';
    const finalUsername = profileData.username || finalNickName;

    // 更新用户信息
    const updatedUserInfo = {
      ...userInfo,
      nickName: finalNickName,
      username: finalUsername,
      avatarUrl: profileData.avatarUrl || userInfo.avatarUrl,
      gender: profileData.gender || userInfo.gender,
      age: profileData.age || userInfo.age,
      bio: profileData.bio || userInfo.bio
    };

    // 保存到本地存储
    wx.setStorageSync('userInfo', updatedUserInfo);

    // 更新全局状态
    const app = getApp();
    if (app && app.globalData) {
      app.globalData.userInfo = {
        ...app.globalData.userInfo,
        ...updatedUserInfo
      };
    }
  } catch (error) {
    console.error('更新本地用户信息失败:', error);
  }
}
```

## 使用说明

### 用户资料页面

1. 用户资料页面现在会直接从本地缓存中加载用户信息，无需等待数据库查询
2. 修改昵称时，会同时更新 `nickName` 和 `username` 字段，确保两者保持一致
3. 保存资料时，会直接更新数据库中的 `user_base` 和 `user_profile` 表，无需调用云函数
4. 如果数据库查询失败，会使用本地缓存中的数据或默认值，确保页面正常显示

### 数据库结构

用户资料数据分别存储在两个表中：

1. `user_base` 表：存储用户基本信息，包括 `username` 和 `avatar_url` 等字段
2. `user_profile` 表：存储用户详细资料，包括 `gender`、`age`、`bio` 等字段

修改昵称时，会同时更新这两个表中的 `username` 字段。

## 注意事项

1. 本次更新主要针对用户资料页面的数据加载和保存逻辑进行了优化，不涉及页面 UI 的修改
2. 如果用户资料页面的 UI 需要进一步优化，可以参考 Material Design 3 设计规范进行改进
3. 本次更新确保了昵称（nickName）和用户名（username）保持一致，避免了数据不一致的问题
4. 如果需要进一步优化用户资料页面的性能，可以考虑使用分包加载和懒加载技术
