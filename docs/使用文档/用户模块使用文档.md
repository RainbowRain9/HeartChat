# HeartChat 用户模块使用文档

## 一、概述

HeartChat 用户模块负责用户信息管理、用户画像分析和用户统计数据展示。本文档详细介绍用户模块的功能、数据结构和使用方法。

## 二、数据库结构

### 1. 用户基础信息表 (user_base)

存储用户的基本信息。

| 字段名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| _id | String | 系统自动生成的唯一ID | "60d5ec7f0a0b7c001f3d56a8" |
| user_id | String | 用户ID (与openid关联) | "user_123456" |
| openid | String | 微信OpenID | "oABC123XYZ" |
| username | String | 用户昵称 | "心语用户" |
| avatar_url | String | 头像URL | "cloud://xxx.jpg" |
| user_type | Number | 用户类型 (1普通/2企业/3管理员) | 1 |
| status | Number | 账号状态 (0禁用/1启用) | 1 |
| created_at | Date | 创建时间 | "2023-01-01T12:00:00Z" |
| updated_at | Date | 更新时间 | "2023-01-10T08:30:00Z" |

### 2. 用户详细信息表 (user_profile)

存储用户的详细个人信息。

| 字段名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| _id | String | 系统自动生成的唯一ID | "60d5ec7f0a0b7c001f3d56a9" |
| user_id | String | 用户ID (与user_base关联) | "user_123456" |
| gender | Number | 性别 (0未知/1男/2女) | 1 |
| country | String | 国家 | "中国" |
| province | String | 省份 | "广东" |
| city | String | 城市 | "深圳" |
| bio | String | 个人简介 | "探索自我，提升情商" |
| tags | Array | 用户标签 | ["科技", "阅读"] |
| created_at | Date | 创建时间 | "2023-01-01T12:00:00Z" |
| updated_at | Date | 更新时间 | "2023-01-10T08:30:00Z" |

### 3. 用户统计信息表 (user_stats)

存储用户的使用统计数据。

| 字段名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| _id | String | 系统自动生成的唯一ID | "60d5ec7f0a0b7c001f3d56aa" |
| stats_id | String | 统计ID | "stats_123456" |
| user_id | String | 用户ID (与user_base关联) | "user_123456" |
| openid | String | 微信OpenID | "oABC123XYZ" |
| chat_count | Number | 对话次数 | 28 |
| solved_count | Number | 解决问题数 | 15 |
| rating_avg | Number | 平均评分 | 4.8 |
| active_days | Number | 活跃天数 | 14 |
| last_active | Date | 最后活跃时间 | "2023-01-10T08:30:00Z" |
| daily_report_count | Number | 每日报告数 | 8 |
| created_at | Date | 创建时间 | "2023-01-01T12:00:00Z" |
| updated_at | Date | 更新时间 | "2023-01-10T08:30:00Z" |

### 4. 用户配置表 (user_config)

存储用户的个性化配置。

| 字段名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| _id | String | 系统自动生成的唯一ID | "60d5ec7f0a0b7c001f3d56ab" |
| user_id | String | 用户ID (与user_base关联) | "user_123456" |
| dark_mode | Boolean | 是否启用暗黑模式 | true |
| notification_enabled | Boolean | 是否启用通知 | true |
| language | String | 语言设置 | "zh_CN" |
| created_at | Date | 创建时间 | "2023-01-01T12:00:00Z" |
| updated_at | Date | 更新时间 | "2023-01-10T08:30:00Z" |

### 5. 用户兴趣表 (user_interests)

存储用户的兴趣标签和兴趣向量。

| 字段名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| _id | String | 系统自动生成的唯一ID | "60d5ec7f0a0b7c001f3d56ac" |
| user_id | String | 用户ID (与user_base关联) | "user_123456" |
| interests | Array | 兴趣标签数组 | [{"tag": "科技", "score": 0.8}, {"tag": "阅读", "score": 0.7}] |
| aggregated_interest_vector | Array | 用户聚合兴趣向量 | [0.8, 0.7, 0.5, ...] |
| created_at | Date | 创建时间 | "2023-01-01T12:00:00Z" |
| updated_at | Date | 更新时间 | "2023-01-10T08:30:00Z" |

## 三、云函数接口

### 1. user 云函数

**功能**：处理用户相关的所有操作，包括获取用户信息、更新用户资料、获取和更新用户统计数据。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'user',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

**支持的操作类型**：

| action | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `getInfo` | 获取用户信息 | `userId`: 用户ID | `success`: 是否成功<br>`data.user`: 用户信息 |
| `updateProfile` | 更新用户资料 | `userId`: 用户ID<br>`username`: 用户名<br>`avatarUrl`: 头像URL<br>其他用户资料字段 | `success`: 是否成功<br>`data.updatedUser`: 更新后的用户信息 |
| `getStats` | 获取用户统计 | `userId`: 用户ID | `success`: 是否成功<br>`data`: 统计数据 |
| `updateStats` | 更新用户统计 | `userId`: 用户ID<br>`statsType`: 统计类型<br>`value`: 统计值 | `success`: 是否成功<br>`data.stats`: 更新后的统计数据 |
| `getUserPerception` | 获取用户画像 | `userId`: 用户ID | `success`: 是否成功<br>`data`: 用户画像数据 |
| `getUserInterests` | 获取用户兴趣 | `userId`: 用户ID | `success`: 是否成功<br>`interests`: 用户兴趣数据 |

**示例**：
```javascript
// 获取用户信息
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'getInfo',
    userId: userInfo.userId
  }
});

// 更新用户资料
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'updateProfile',
    userId: userInfo.userId,
    username: formData.username,
    avatarUrl: userInfo.avatarUrl,
    gender: formData.gender,
    country: formData.country,
    province: formData.province,
    city: formData.city,
    bio: formData.bio,
    settings: {
      darkMode: formData.darkMode,
      notificationEnabled: formData.notificationEnabled,
      language: formData.language
    }
  }
});

// 获取用户画像
const result = await wx.cloud.callFunction({
  name: 'user',
  data: {
    action: 'getUserPerception',
    userId: userInfo.userId
  }
});
```

### 2. emotion 云函数

**功能**：处理情绪相关的操作，包括获取情绪概览和情绪历史。

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'emotion',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

**支持的操作类型**：

| action | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `getEmotionOverview` | 获取情绪概览 | `userId`: 用户ID | `success`: 是否成功<br>`data`: 情绪概览数据 |
| `getEmotionHistory` | 获取情绪历史 | `userId`: 用户ID<br>`days`: 天数 (默认30)<br>`limit`: 记录数量限制 (默认100) | `success`: 是否成功<br>`data`: 情绪历史数据 |

**示例**：
```javascript
// 获取情绪概览
const result = await wx.cloud.callFunction({
  name: 'emotion',
  data: {
    action: 'getEmotionOverview',
    userId: userInfo.userId
  }
});

// 获取情绪历史
const result = await wx.cloud.callFunction({
  name: 'emotion',
  data: {
    action: 'getEmotionHistory',
    userId: userInfo.userId,
    days: 30,
    limit: 100
  }
});
```

## 四、页面说明

### 1. 用户中心页面 (pages/user/user)

**功能**：
- 显示用户基本信息 (头像、昵称、个人简介)
- 展示用户统计数据 (对话次数、活跃天数、心情报告数)
- 显示情绪概览 (情绪分布饼图、主要情绪描述)
- 显示个性分析 (个性特征雷达图、个性总结)
- 提供功能入口 (角色管理、情绪历史、系统设置)
- 提供退出登录功能

**使用方法**：
1. 通过底部导航栏的"我的"选项进入用户中心页面
2. 点击头像区域可进入个人资料页面
3. 点击"情绪概览"中的"查看详情"可进入情绪历史页面
4. 点击功能列表中的选项可进入相应功能页面

### 2. 个人资料页面 (pages/user/profile/index)

**功能**：
- 显示并允许编辑用户详细信息 (昵称、性别、地区、个人简介)
- 显示用户性格分析 (性格特征评分、性格总结)
- 显示用户兴趣标签
- 提供头像上传功能
- 提供设置选项 (暗黑模式、通知设置、语言设置)

**使用方法**：
1. 在用户中心页面点击头像区域进入个人资料页面
2. 点击头像可上传新头像
3. 填写或修改个人信息
4. 点击"保存"按钮保存修改

## 五、用户画像系统

为了收集用户信息并构建用户画像，我们实现了：

1. **对话分析**：
   - 在每次对话后，分析用户的表达方式、情感倾向和提到的兴趣爱好
   - 更新角色的 `user_perception` 字段

2. **用户画像反馈**：
   - 生成用户画像摘要
   - 让角色在对话中自然地反馈这些观察

3. **个性化互动**：
   - 基于用户画像调整角色的回应方式
   - 在用户情绪低落时提供安慰，在用户需要建议时提供批评性意见

**用户画像数据结构**：
```javascript
{
  // 用户兴趣
  interests: ["用户兴趣1", "用户兴趣2"],
  
  // 个性特征
  personalityTraits: [
    { trait: "责任感", score: 0.85 },
    { trait: "完美主义", score: 0.80 },
    { trait: "同理心", score: 0.70 },
    { trait: "创造力", score: 0.65 },
    { trait: "社交性", score: 0.50 },
    { trait: "冒险精神", score: 0.40 },
    { trait: "耐心", score: 0.60 }
  ],
  
  // 个性总结
  personalitySummary: "根据你的对话内容和情绪反应，我们分析出你是一个责任感强、追求完美的人，同时也具有同理心和创造力。",
  
  // 情绪模式
  emotionPatterns: {
    emotionPercentages: {
      "快乐": 25,
      "平静": 20,
      "焦虑": 15,
      "压力": 40
    },
    emotionTrends: {
      trend: "消极下降"
    },
    dominantEmotions: [
      { emotion: "压力", percentage: 40 },
      { emotion: "快乐", percentage: 25 }
    ]
  }
}
```

## 六、常见问题

### 1. 用户信息无法加载

**问题**：用户中心页面显示加载失败或无法获取用户信息。

**解决方案**：
- 检查网络连接是否正常
- 确认用户是否已登录
- 尝试重新登录
- 检查云函数是否正常运行

### 2. 头像上传失败

**问题**：在个人资料页面上传头像时失败。

**解决方案**：
- 检查网络连接是否正常
- 确认图片大小是否超过限制 (建议小于2MB)
- 尝试使用不同格式的图片 (JPG, PNG)
- 检查云存储权限设置

### 3. 个性分析数据不准确

**问题**：用户画像中的个性分析数据与用户实际情况不符。

**解决方案**：
- 个性分析需要足够的对话数据才能准确，建议多进行对话
- 在对话中表达真实情感和想法，有助于提高分析准确性
- 系统会随着使用时间的增加不断优化分析结果

## 七、更新日志

### 2024-04-16 更新

- 完全重构了用户中心页面
- 新增了情绪概览和个性分析模块
- 优化了用户统计数据展示
- 新增了用户画像功能
- 新增了情绪云函数
- 完善了用户数据库设计
