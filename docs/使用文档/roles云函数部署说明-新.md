# roles 云函数部署说明

## 概述

`roles` 云函数是 HeartChat 小程序的核心功能之一，用于管理角色数据、生成提示词、管理角色记忆和用户画像。本文档提供了部署和配置 `roles` 云函数的详细步骤。

## 部署步骤

### 1. 准备工作

确保您已经安装了微信开发者工具，并且已经创建了云开发环境。

### 2. 上传云函数

1. 在微信开发者工具中，打开 HeartChat 项目
2. 在左侧文件树中，找到 `cloudfunctions/roles` 目录
3. 确保目录中包含以下文件：
   - `index.js`：主函数入口
   - `promptGenerator.js`：提示词生成模块
   - `memoryManager.js`：记忆管理模块
   - `userPerception.js`：用户画像模块
   - `init-roles.js`：初始角色数据
   - `package.json`：依赖配置
4. 检查 `package.json` 文件，确保包含以下依赖：
   ```json
   {
     "dependencies": {
       "wx-server-sdk": "~2.6.3"
     }
   }
   ```
5. 右键点击 `roles` 目录，选择"上传并部署：云端安装依赖"
6. 等待部署完成，控制台会显示"上传成功"的消息

### 3. 部署 httpRequest 云函数

由于 `roles` 云函数依赖于 `httpRequest` 云函数来调用智谱AI接口，因此需要先部署 `httpRequest` 云函数。

1. 在左侧文件树中，找到 `cloudfunctions/httpRequest` 目录
2. 确保目录中包含以下文件：
   - `index.js`：主函数入口
   - `package.json`：依赖配置
3. 检查 `package.json` 文件，确保包含以下依赖：
   ```json
   {
     "dependencies": {
       "wx-server-sdk": "~2.6.3",
       "got": "^11.8.5"
     }
   }
   ```
4. 右键点击 `httpRequest` 目录，选择"上传并部署：云端安装依赖"
5. 等待部署完成，控制台会显示"上传成功"的消息

### 4. 配置智谱AI接口密钥

1. 在微信开发者工具中，点击"云开发"按钮
2. 选择"云函数"选项卡
3. 点击 `roles` 云函数
4. 选择"详情"选项卡
5. 点击"配置"按钮
6. 在"环境变量"部分，添加以下变量：
   - 变量名：`ZHIPU_API_KEY`
   - 变量值：您的智谱AI API密钥
7. 点击"保存"按钮

### 5. 创建数据库集合

1. 在微信开发者工具中，点击"云开发"按钮
2. 选择"数据库"选项卡
3. 创建以下集合（如果尚未创建）：
   - `roles`：存储角色信息
   - `roleUsage`：存储角色使用统计
   - `messages`：存储对话消息

### 6. 设置数据库权限

1. 在"数据库"选项卡中，点击 `roles` 集合
2. 点击"权限设置"
3. 设置为"所有用户可读，仅创建者可写"
4. 对 `roleUsage` 和 `messages` 集合重复上述步骤

### 7. 初始化角色数据

1. 在微信开发者工具中，点击"云开发"按钮
2. 选择"云函数"选项卡
3. 点击 `roles` 云函数
4. 选择"测试"选项卡
5. 在测试参数输入框中输入：`{"action": "initialize"}`
6. 点击"执行函数"按钮
7. 检查返回结果，确认初始化成功
8. 在数据库中查看 `roles` 集合，确认预设角色已添加

### 8. 上传角色头像

1. 在微信开发者工具中，点击"云开发"按钮
2. 选择"存储"选项卡
3. 创建 `avatars` 目录
4. 上传默认角色头像图片
5. 记录头像的云存储路径，并在 `init-roles.js` 文件中更新头像路径

### 9. 修改前端代码

1. 修改角色选择页面，使用新的 `roles` 云函数
2. 修改角色编辑页面，使用新的 `roles` 云函数
3. 修改聊天页面，集成记忆和用户画像功能：
   - 在对话开始前调用 `generatePrompt` 接口
   - 在对话结束后调用 `extractMemories` 和 `updateUserPerception` 接口

## 测试功能

### 1. 基础功能测试

1. 测试获取角色列表 (`getRoles`)
2. 测试获取角色详情 (`getRoleDetail`)
3. 测试创建角色 (`createRole`)
4. 测试更新角色 (`updateRole`)
5. 测试删除角色 (`deleteRole`)
6. 测试角色使用统计 (`updateUsage`)

### 2. 高级功能测试

1. 测试生成角色提示词 (`generatePrompt`)
2. 测试提取对话记忆 (`extractMemories`)
3. 测试获取相关记忆 (`getRelevantMemories`)
4. 测试更新用户画像 (`updateUserPerception`)
5. 测试获取用户画像摘要 (`getUserPerceptionSummary`)

## 常见问题

### 云函数部署失败

**问题**：云函数部署时报错"安装依赖失败"。

**解决方案**：
1. 检查 `package.json` 文件中的依赖版本是否兼容
2. 尝试手动安装依赖后再部署
3. 检查云开发环境是否有足够的资源配额

### 智谱AI接口调用失败

**问题**：调用智谱AI接口时报错。

**解决方案**：
1. 检查 `ZHIPU_API_KEY` 环境变量是否正确设置
2. 确认 `httpRequest` 云函数是否正确部署
3. 检查网络连接是否正常
4. 查看智谱AI官方文档，确认接口参数是否正确

### 记忆和用户画像功能不工作

**问题**：记忆和用户画像功能不工作。

**解决方案**：
1. 检查 `memoryManager.js` 和 `userPerception.js` 文件是否正确上传
2. 确认在对话结束后是否调用了 `extractMemories` 和 `updateUserPerception` 接口
3. 检查数据库中是否存在相关记录
4. 查看云函数日志，检查是否有错误信息

## 注意事项

1. 云函数部署后，需要等待几分钟才能正常调用
2. 智谱AI接口调用需要消耗API额度，请合理使用
3. 记忆和用户画像功能会增加数据库存储量，请定期清理不必要的数据
4. 在生产环境中，应该设置适当的访问控制和数据备份策略
5. 定期检查云函数日志，及时发现和解决问题
