# 情绪历史页面功能增强文档

## 一、功能概述

情绪历史页面（`packageEmotion/pages/emotion-history/`）是 HeartChat 应用中用于展示用户情绪历史记录的重要页面。本次更新对该页面进行了多项功能增强，主要包括：

1. **数据获取优化**：从数据库获取真实数据，不再使用模拟数据
2. **本地缓存机制**：实现数据本地缓存，提高页面加载速度
3. **角色名称显示**：在情绪记录中显示对应的角色名称
4. **角色页面跳转**：点击情绪记录可跳转到对应的角色聊天页面

## 二、数据获取优化

### 2.1 数据库查询

- 使用 `userId` 字段查询 `emotionRecords` 集合，其中 `userId` 的值为用户的 `openId`
- 支持按时间范围筛选数据
- 支持按角色 ID 筛选数据
- 支持分页加载数据

```javascript
// 查询条件示例
const query = {
  userId: openId, // 使用 openId 作为 userId 字段的值
  // 可选的角色 ID 筛选
  roleId: roleId // 如果需要按角色筛选
};

// 查询记录
const result = await db.collection('emotionRecords')
  .where(query)
  .orderBy('createTime', 'desc')
  .limit(limit)
  .get();
```

### 2.2 数据处理

- 处理 `analysis` 字段，确保 `primary_emotion` 和 `topic_keywords` 字段存在
- 支持多种情绪类型格式，包括英文和中文
- 处理 `createTime` 字段，支持多种时间格式

```javascript
// 处理数据示例
const processedData = records.map(record => {
  // 处理 analysis 字段
  if (record.analysis) {
    // 确保有 primary_emotion 字段
    if (!record.analysis.primary_emotion && record.analysis.type) {
      record.analysis.primary_emotion = record.analysis.type;
    }
    
    // 确保有 topic_keywords 字段
    if (!record.analysis.topic_keywords && record.analysis.keywords) {
      record.analysis.topic_keywords = record.analysis.keywords;
    }
  }
  
  return record;
});
```

## 三、本地缓存机制

### 3.1 缓存策略

- 使用 `wx.setStorageSync` 和 `wx.getStorageSync` 实现本地缓存
- 缓存键格式：`emotionHistory_${userId}_${timeRange}`
- 缓存内容包括数据和时间戳
- 缓存过期时间为 30 分钟

```javascript
// 存入缓存
const cacheKey = `emotionHistory_${userId}_${timeRange}`;
wx.setStorageSync(cacheKey, {
  timestamp: Date.now(),
  data: records
});

// 从缓存读取
const cachedData = wx.getStorageSync(cacheKey);
if (cachedData && cachedData.data && cachedData.timestamp) {
  // 检查缓存是否过期（超过30分钟）
  const now = Date.now();
  const cacheAge = now - cachedData.timestamp;
  const cacheExpiry = 30 * 60 * 1000; // 30分钟
  
  if (cacheAge < cacheExpiry) {
    // 使用缓存数据
    return cachedData.data;
  }
}
```

### 3.2 缓存刷新

- 下拉刷新时清除当前时间范围的缓存，强制从数据库获取最新数据
- 切换时间范围时，优先使用缓存数据，同时在后台从数据库获取最新数据
- 当数据库中没有数据时，尝试从其他时间范围的缓存中获取数据

## 四、角色名称显示

### 4.1 角色名称获取

- 优先使用记录中的 `roleName` 或 `role_name` 字段
- 如果记录中没有角色名称，则通过 `roleId` 从 `roles` 集合中查询
- 使用云函数 `getRoleInfo` 或直接查询数据库获取角色信息
- 将角色信息缓存到本地，提高后续查询效率

```javascript
// 批量查询角色信息
if (roleIdsToQueryFromDB.length > 0) {
  const db = wx.cloud.database();
  const _ = db.command;
  
  const result = await db.collection('roles')
    .where({
      _id: _.in(roleIdsToQueryFromDB)
    })
    .get();
  
  if (result && result.data && result.data.length > 0) {
    // 将查询结果存入映射和缓存
    for (const role of result.data) {
      roleInfoMap[role._id] = role;
      roleCache[role._id] = role;
    }
    
    // 更新缓存
    wx.setStorageSync('roleCache', roleCache);
  }
}

// 获取角色名称
let roleName = record.roleName || record.role_name || '';

// 如果没有角色名称，尝试从角色信息中获取
if (!roleName && record.roleId && roleInfoMap[record.roleId]) {
  const roleInfo = roleInfoMap[record.roleId];
  roleName = roleInfo.name || roleInfo.role_name || '';
}
```

### 4.2 角色名称显示

- 在情绪记录列表中显示角色名称
- 使用特殊样式突出显示角色名称
- 支持暗黑模式下的样式适配

```html
<!-- WXML 示例 -->
<view class="record-meta">
  <text>{{item.time}}</text>
  <text wx:if="{{item.roleName}}" class="record-role"> · 与 {{item.roleName}} 的对话</text>
  <text wx:else> · 对话记录</text>
</view>
```

```css
/* WXSS 示例 */
.record-role {
  color: #5e72e4;
  font-weight: 500;
}

.dark-mode .record-role {
  color: #7986cb;
}
```

## 五、角色页面跳转

### 5.1 跳转逻辑

- 点击情绪记录时，获取记录的 `roleId` 和 `chatId`
- 如果有 `roleId`，尝试跳转到聊天页面
- 如果没有 `roleId` 或跳转失败，跳转到情绪分析详情页

```javascript
viewRecordDetail: function (e) {
  const recordId = e.currentTarget.dataset.id;
  const roleId = e.currentTarget.dataset.roleId;
  const chatId = e.currentTarget.dataset.chatId;
  
  if (!recordId) return;
  
  // 如果有角色ID，先跳转到角色页面
  if (roleId) {
    // 尝试获取角色信息
    try {
      const roleCache = wx.getStorageSync('roleCache') || {};
      const role = roleCache[roleId];
      
      if (role) {
        // 跳转到聊天页面
        wx.navigateTo({
          url: `/pages/chat/chat?roleId=${roleId}${chatId ? '&chatId=' + chatId : ''}`,
          success: () => {
            // 跳转成功
          },
          fail: (error) => {
            // 如果跳转失败，尝试跳转到情绪分析页面
            this.navigateToEmotionAnalysis(recordId);
          }
        });
        return;
      }
    } catch (error) {
      // 忽略错误
    }
  }
  
  // 如果没有角色ID或跳转失败，跳转到情绪分析详情页
  this.navigateToEmotionAnalysis(recordId);
}
```

### 5.2 数据传递

- 在 WXML 中为每个记录项添加 `data-role-id` 和 `data-chat-id` 属性
- 在生成记录列表时，将 `roleId` 和 `chatId` 添加到记录对象中

```html
<!-- WXML 示例 -->
<view class="record-item" 
      wx:for="{{recentRecords}}" 
      wx:key="id"
      bindtap="viewRecordDetail"
      data-id="{{item.id}}"
      data-role-id="{{item.roleId}}"
      data-chat-id="{{item.chatId}}">
  <!-- 记录内容 -->
</view>
```

```javascript
// 生成记录对象示例
return {
  id: record._id,
  emotions: [emotionLabel],
  time: time,
  source: source,
  roleName: roleName,  // 角色名称
  roleId: record.roleId || '',  // 角色ID
  chatId: record.chatId || '',  // 聊天ID
  iconBg: iconInfo.bg,
  iconName: iconInfo.icon
};
```

## 六、使用说明

### 6.1 查看情绪历史

1. 进入情绪历史页面
2. 选择时间范围（一周、一个月、三个月、半年、一年）
3. 查看情绪趋势图、情绪分布图和情绪波动指数
4. 查看最近情绪记录列表

### 6.2 查看记录详情

1. 点击最近情绪记录列表中的记录
2. 如果记录有关联的角色，将跳转到与该角色的聊天页面
3. 如果记录没有关联的角色或跳转失败，将跳转到情绪分析详情页

### 6.3 刷新数据

1. 下拉页面可刷新数据，强制从数据库获取最新数据
2. 切换时间范围也会刷新数据，但会优先使用缓存数据

## 七、注意事项

1. 情绪历史页面需要用户登录后才能使用
2. 页面加载时会优先从数据库获取数据，如果没有数据则尝试从缓存加载
3. 缓存数据有 30 分钟的过期时间，过期后会自动从数据库重新获取
4. 角色名称显示依赖于 `roles` 集合中的数据，如果角色被删除，可能无法显示角色名称
5. 跳转到聊天页面需要角色仍然存在，否则会跳转到情绪分析详情页

## 八、技术实现

### 8.1 云函数

- `getEmotionHistory`: 获取情绪历史记录
- `getRoleInfo`: 获取角色信息

### 8.2 数据库

- `emotionRecords`: 存储情绪分析记录
- `roles`: 存储角色信息

### 8.3 本地缓存

- `emotionHistory_${userId}_${timeRange}`: 缓存情绪历史记录
- `roleCache`: 缓存角色信息

### 8.4 组件

- `emotion-dashboard`: 情绪分析面板组件
- `ec-canvas`: 图表组件

## 九、未来优化方向

1. **数据库索引优化**：为 `emotionRecords` 集合的 `userId`、`createTime` 和 `roleId` 字段添加索引，提高查询性能
2. **数据聚合分析**：实现更复杂的数据聚合分析，如情绪变化趋势、关键词聚类等
3. **UI/UX 优化**：优化页面布局和交互，提升用户体验
4. **性能优化**：优化数据加载和处理逻辑，减少页面加载时间
5. **数据可视化增强**：增加更多的数据可视化图表，如情绪雷达图、关键词云等
