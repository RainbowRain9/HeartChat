# 云开发配置指南

## 环境配置

### 云开发环境信息
- **环境ID**: `cloud1-9gpfk3ie94d8630a`
- **环境名称**: `heartchat-prod`
- **环境状态**: 生产环境

### 环境变量配置

在云开发控制台中配置以下环境变量：

#### 智谱AI配置
```
ZHIPUAI_API_KEY=your_zhipuai_api_key_here
ZHIPUAI_BASE_URL=https://open.bigmodel.cn/api/paas/v4
```

#### 微信配置
```
WECHAT_APPID=wx3b23ed9a8ff5f5c6
WECHAT_SECRET=your_wechat_secret_here
```

#### 其他配置
```
NODE_ENV=production
LOG_LEVEL=info
CACHE_EXPIRE=1800000
```

## 云函数配置

### 内存和超时配置

| 云函数名称 | 内存大小(MB) | 超时时间(秒) | 说明 |
|-----------|-------------|-------------|------|
| analysis | 512 | 20 | 情感分析，需要较大内存 |
| chat | 256 | 15 | 聊天功能，中等内存需求 |
| roles | 256 | 10 | 角色管理，较小内存需求 |
| login | 128 | 5 | 登录功能，较小内存需求 |
| user | 256 | 10 | 用户管理，中等内存需求 |

### 云函数依赖

#### analysis 云函数
```json
{
  "dependencies": {
    "wx-server-sdk": "~2.6.3",
    "axios": "^1.6.0"
  }
}
```

#### chat 云函数
```json
{
  "dependencies": {
    "wx-server-sdk": "~2.6.3",
    "axios": "^1.6.0"
  }
}
```

## 数据库配置

### 集合和索引

#### 必须创建的集合
- `users` - 用户信息
- `roles` - 角色信息
- `chats` - 聊天会话
- `messages` - 消息记录
- `emotionRecords` - 情感分析记录
- `userReports` - 用户报告
- `userInterests` - 用户兴趣
- `sys_config` - 系统配置

#### 关键索引配置

```javascript
// users 集合
{
  "field": "openid",
  "unique": true
}

// emotionRecords 集合
{
  "field": "userId",
  "props": {
    "createTime": -1
  }
}

// messages 集合
{
  "field": "chatId",
  "props": {
    "timestamp": -1
  }
}
```

## 存储配置

### 存储桶配置
- **名称**: `heartchat-assets`
- **权限**: 公开读
- **域名**: 默认域名

### 文件类型限制
- **图片**: jpg, png, gif, webp (最大 2MB)
- **音频**: mp3, wav (最大 5MB)
- **文档**: pdf, txt (最大 1MB)

## 安全配置

### 数据库权限
- **读写权限**: 仅创建者可读写
- **管理员权限**: 通过云函数验证
- **公开数据**: 通过云函数控制访问

### 云函数安全
- **API密钥**: 使用环境变量存储
- **输入验证**: 所有输入参数必须验证
- **错误处理**: 不暴露敏感信息

## 监控和日志

### 日志级别
- **ERROR**: 错误信息
- **WARN**: 警告信息
- **INFO**: 一般信息
- **DEBUG**: 调试信息

### 监控指标
- 云函数调用次数
- 云函数执行时间
- 数据库查询次数
- 存储使用量
- 网络请求次数

## 性能优化

### 缓存策略
- **前端缓存**: 30分钟
- **云函数缓存**: 10分钟
- **数据库缓存**: 使用索引优化

### 查询优化
- 使用分页查询
- 避免全表扫描
- 合理使用索引
- 批量操作优化

## 成本控制

### 免费额度使用
- 云函数：每月 10 万次调用
- 数据库：每月 2GB 存储
- 存储：每月 5GB
- CDN：每月 5GB 流量

### 成本优化建议
- 合理设置缓存时间
- 优化数据库查询
- 控制文件大小
- 监控资源使用

## 部署流程

### 云函数部署
1. 在微信开发者工具中右键点击云函数目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
4. 测试云函数功能

### 数据库初始化
1. 在云开发控制台创建集合
2. 配置集合权限
3. 创建必要索引
4. 导入初始数据

### 文件上传
1. 将静态资源上传到云存储
2. 配置文件权限
3. 获取文件访问地址

## 故障排除

### 常见问题
1. **云函数调用失败**: 检查环境变量和依赖
2. **数据库查询失败**: 检查权限和索引
3. **文件上传失败**: 检查文件大小和格式
4. **性能问题**: 检查缓存和查询优化

### 应急处理
1. 监控告警设置
2. 数据备份策略
3. 故障恢复流程
4. 用户通知机制