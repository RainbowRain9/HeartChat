# 角色选择页面详细文档

## 一、功能概述

角色选择页面是HeartChat微信小程序中的核心功能页面，用于展示、选择和管理AI对话角色。用户可以在此页面浏览所有可用角色，选择一个角色开始对话，也可以创建、编辑和删除自定义角色。该页面支持高度自定义的角色管理，使用户能够创建符合个人需求的对话角色。

页面遵循iOS设计规范，采用卡片式布局、圆角元素和适当的投影效果，确保视觉体验现代简洁。同时，页面支持下拉刷新、角色分类筛选、搜索功能和角色详情查看，提供了全面而友好的用户体验。

## 二、页面结构

角色选择页面由以下几个主要部分组成：

1. **页面标题栏**：显示页面标题和返回按钮
2. **搜索框**：用于搜索角色
3. **角色分类**：用于按类别筛选角色
4. **角色列表**：以卡片形式展示角色
5. **底部按钮区**：包含"创建新角色"和"开始对话"按钮

## 三、功能详解

### 1. 角色浏览与筛选

#### 1.1 分类筛选

角色选择页面支持按以下分类筛选角色：

- **全部**：显示所有角色
- **情感支持**：显示情感支持类角色
- **心理咨询**：显示心理咨询类角色
- **生活伙伴**：显示生活伙伴类角色
- **职场导师**：显示职场导师类角色

用户可以点击顶部的分类标签切换不同分类，当前选中的分类会高亮显示。

#### 1.2 搜索功能

搜索框支持按角色名称和描述搜索角色：

- 用户在搜索框中输入关键词，系统会实时过滤出名称或描述中包含该关键词的角色
- 搜索框右侧的清除按钮可以快速清空搜索内容
- 搜索结果会与分类筛选结合，只显示同时满足两个条件的角色

#### 1.3 角色展示

角色以卡片形式展示，每个角色卡片包含以下信息：

- **头像**：角色的头像图片
- **名称**：角色的名称
- **描述**：角色的简短描述
- **使用次数**：该角色被使用的次数

如果是推荐角色，会在"推荐角色"区域单独展示。

### 2. 角色选择与对话

#### 2.1 选择角色

用户可以通过点击角色卡片选择一个角色：

- 被选中的角色卡片会有高亮边框
- 同一时间只能选中一个角色
- 再次点击已选中的角色可以取消选择

#### 2.2 开始对话

选中角色后，用户可以点击底部的"开始对话"按钮进入聊天界面：

- 如果未选择角色，系统会提示"请先选择一个角色"
- 选择角色后，点击"开始对话"按钮会跳转到聊天页面，并传递所选角色的ID
- 聊天页面会根据角色ID加载对应的角色信息和历史聊天记录

### 3. 角色管理

#### 3.1 创建新角色

用户可以通过点击底部的"创建新角色"按钮创建自定义角色：

- 点击按钮会跳转到角色编辑页面
- 用户可以在角色编辑页面设置角色的各种属性，包括：
  - **基本信息**：名称、与用户的关系、年龄、性别
  - **详细背景**：职业、教育背景、爱好、生活经历
  - **性格特点**：性格特点、说话风格、情感倾向、禁忌话题
- 创建成功后会返回角色选择页面，并自动刷新角色列表

#### 3.2 角色操作菜单

用户可以通过长按角色卡片打开操作菜单，包含以下选项：

- **查看详情**：查看角色的详细信息
- **编辑角色**：编辑角色的属性
- **删除角色**：删除角色

##### 3.2.1 查看详情

选择"查看详情"选项会显示角色的详细信息，包括：

- 角色名称
- 角色描述
- 角色的详细背景和性格特点
- 角色的使用统计信息

##### 3.2.2 编辑角色

选择"编辑角色"选项会跳转到角色编辑页面，预填充当前角色的信息：

- 用户可以修改角色的各种属性
- 修改完成后点击"保存"按钮更新角色信息
- 更新成功后会返回角色选择页面，并自动刷新角色列表

##### 3.2.3 删除角色

选择"删除角色"选项会弹出确认对话框：

- 用户需要确认是否删除该角色
- 确认删除后，系统会从数据库中删除该角色
- 删除成功后会自动刷新角色列表

## 四、数据结构

### 1. 角色数据结构

角色数据结构包含以下字段：

```javascript
{
  _id: "角色ID",
  name: "角色名称",
  avatar: "头像URL",

  // 基本信息
  relationship: "与用户的关系", // 家人、情侣、老师、朋友等
  age: 25, // 年龄
  gender: "性别", // 男/女/其他
  category: "角色分类", // emotion, psychology, life, career - 根据relationship自动推荐

  // 详细背景
  background: "生活经历和背景故事",
  education: "教育背景",
  occupation: "职业",
  hobbies: ["爱好1", "爱好2"],

  // 性格特点
  personality_traits: ["性格特点1", "性格特点2"],
  communication_style: "说话方式", // 例如：直接、温和、幽默、严肃等
  emotional_tendency: "情感倾向", // 例如：乐观、悲观、理性、感性等

  // 简短描述和欢迎语
  description: "角色简短描述",
  welcome: "角色欢迎语",

  // AI提示词相关
  prompt: "系统提示词",

  // 使用统计
  usage: {
    usageCount: 0, // 使用次数
    lastUsedTime: Date // 最后使用时间
  },

  // 记忆与发展
  memories: [
    {
      content: "记忆内容",
      importance: 0.8, // 重要性评分（0-1）
      timestamp: Date,
      context: "记忆上下文"
    }
  ],

  // 用户画像感知
  user_perception: {
    interests: ["用户兴趣1", "用户兴趣2"],
    preferences: ["用户偏好1", "用户偏好2"],
    communication_style: "用户说话方式",
    emotional_patterns: ["用户情感模式1", "用户情感模式2"]
  },

  // 基础字段
  creator: "创建者ID",
  createTime: Date,
  updateTime: Date,
  status: 1 // 1:启用 0:禁用
}
```

### 2. 页面数据结构

角色选择页面的数据结构包含以下字段：

```javascript
{
  roles: [], // 角色列表
  selectedRoleId: '', // 当前选中的角色ID
  loading: true, // 是否正在加载
  categories: [ // 角色分类
    { id: 'all', name: '全部' },
    { id: 'emotion', name: '情感支持' },
    { id: 'psychology', name: '心理咨询' },
    { id: 'life', name: '生活伙伴' },
    { id: 'career', name: '职场导师' }
  ],
  activeCategory: 'all', // 当前选中的分类
  searchValue: '' // 搜索关键词
}
```

## 五、交互流程

### 1. 页面加载流程

1. 页面加载时，显示加载动画
2. 调用`roles`云函数的`getRoles`操作获取角色列表
3. 获取成功后，隐藏加载动画，显示角色列表
4. 如果获取失败，显示错误提示

### 2. 角色选择流程

1. 用户点击角色卡片选中一个角色
2. 被选中的角色卡片显示高亮边框
3. 用户点击"开始对话"按钮
4. 如果未选择角色，显示提示"请先选择一个角色"
5. 如果已选择角色，跳转到聊天页面，并传递所选角色的ID

### 3. 角色创建流程

1. 用户点击"创建新角色"按钮
2. 跳转到角色编辑页面
3. 用户填写角色信息，包括基本信息、详细背景和性格特点
4. 用户点击"保存"按钮
5. 系统调用`roles`云函数的`createRole`操作创建角色
6. 创建成功后，显示成功对话框
7. 用户点击"返回列表"按钮返回角色选择页面
8. 角色选择页面自动刷新角色列表，显示新创建的角色

### 4. 角色编辑流程

1. 用户长按角色卡片
2. 系统显示操作菜单
3. 用户选择"编辑角色"选项
4. 跳转到角色编辑页面，预填充当前角色的信息
5. 用户修改角色信息
6. 用户点击"保存"按钮
7. 系统调用`roles`云函数的`updateRole`操作更新角色
8. 更新成功后，显示成功对话框
9. 用户点击"返回列表"按钮返回角色选择页面
10. 角色选择页面自动刷新角色列表，显示更新后的角色信息

### 5. 角色删除流程

1. 用户长按角色卡片
2. 系统显示操作菜单
3. 用户选择"删除角色"选项
4. 系统显示确认对话框
5. 用户点击"确定"按钮
6. 系统调用`roles`云函数的`deleteRole`操作删除角色
7. 删除成功后，显示成功提示
8. 角色选择页面自动刷新角色列表，移除已删除的角色

## 六、角色分类系统

角色选择页面支持按分类筛选角色，分类系统的设计既考虑了用户的思维习惯，又满足了系统对分类的需求。

### 1. 分类体系

我们定义了四个主要的角色分类：

- **情感支持（emotion）**：提供情感陶伴和支持的角色
- **心理咨询（psychology）**：提供心理咨询和辅导的角色
- **生活伙伴（life）**：日常生活中的伙伴和家人角色
- **职场导师（career）**：提供职业指导和建议的角色

### 2. 关系与分类的映射

为了简化用户创建角色的流程，我们建立了关系与分类的默认映射关系：

| 关系类型 | 默认分类 |
|---------|--------|
| 家人 | 生活伙伴（life） |
| 情侣 | 情感支持（emotion） |
| 朋友 | 生活伙伴（life） |
| 老师 | 心理咨询（psychology） |
| 同事 | 职场导师（career） |
| 心理咨询师 | 心理咨询（psychology） |
| 职业导师 | 职场导师（career） |
| 情感顾问 | 情感支持（emotion） |

### 3. 分类实现机制

- 在角色编辑页面，用户选择“与用户的关系”后，系统会自动推荐对应的分类
- 用户可以修改系统推荐的分类，也可以保持默认设置
- 如果用户未选择分类，系统会在保存时根据关系自动设置默认分类

### 4. 分类筛选

在角色选择页面，用户可以通过点击顶部的分类标签切换不同分类：

- 当选择“全部”时，显示所有角色
- 当选择其他分类时，只显示对应分类的角色
- 分类筛选可以与搜索功能结合使用

## 七、角色记忆与用户画像系统

### 1. 角色记忆系统

角色记忆系统使角色能够在多次对话中"记住"之前的对话内容和用户提供的信息：

1. **记忆提取**：
   - 在每次对话结束后，系统分析对话内容
   - 提取重要信息并存储到角色的`memories`数组中
   - 为每条记忆分配重要性评分

2. **记忆检索**：
   - 在新对话开始时，系统根据上下文相关性和重要性，选择最相关的记忆
   - 将这些记忆融合到系统提示词中，使角色能够"记住"之前的对话

3. **记忆管理**：
   - 系统自动合并和淘汰记忆，避免记忆过多导致提示词过长
   - 用户可以在角色详情页面查看和管理角色的记忆

### 2. 用户画像系统

用户画像系统使角色能够了解用户的兴趣、偏好和情感模式：

1. **对话分析**：
   - 在每次对话后，系统分析用户的表达方式、情感倾向和提到的兴趣爱好
   - 更新角色的`user_perception`字段

2. **用户画像反馈**：
   - 角色在对话中自然地反馈这些观察
   - 用户可以在个人信息页面查看系统生成的用户画像

3. **个性化互动**：
   - 角色根据用户画像调整回应方式
   - 在用户情绪低落时提供安慰，在用户需要建议时提供批评性意见

## 七、UI设计规范

角色选择页面的UI设计遵循iOS设计规范，具有以下特点：

1. **卡片式布局**：
   - 角色以卡片形式展示
   - 卡片有圆角和适当的阴影效果
   - 卡片内容布局清晰，信息层次分明

2. **色彩方案**：
   - 主色调：#4A90E2（蓝色）
   - 辅助色：#F5A623（橙色）、#7ED321（绿色）
   - 背景色：#F9F9F9（浅灰色）
   - 文字颜色：#333333（深灰色）、#666666（中灰色）、#999999（浅灰色）

3. **字体规范**：
   - 标题：18px，粗体
   - 副标题：16px，常规
   - 正文：14px，常规
   - 说明文字：12px，常规

4. **图标规范**：
   - 线性图标，统一风格
   - 图标大小：24px x 24px
   - 图标颜色与文字颜色保持一致

5. **交互反馈**：
   - 点击效果：透明度变化
   - 选中状态：边框高亮
   - 加载状态：旋转动画
   - 空状态：友好提示

## 八、开发指南

### 1. 文件结构

角色选择页面的文件结构如下：

```
miniprogram/pages/role-select/
├── role-select.js        # 页面逻辑
├── role-select.wxml      # 页面结构
├── role-select.wxss      # 页面样式
└── role-select.json      # 页面配置
```

### 2. 组件依赖

角色选择页面依赖以下组件：

- **role-card**：角色卡片组件，用于展示角色信息
- **loading-spinner**：加载动画组件，用于显示加载状态

### 3. API调用

角色选择页面调用以下API：

- **wx.cloud.callFunction**：调用云函数
- **wx.navigateTo**：页面跳转
- **wx.showToast**：显示提示
- **wx.showModal**：显示对话框
- **wx.showActionSheet**：显示操作菜单

### 4. 云函数依赖

角色选择页面依赖`roles`云函数的以下操作：

- **getRoles**：获取角色列表
- **createRole**：创建角色
- **updateRole**：更新角色
- **deleteRole**：删除角色

## 九、使用场景

### 1. 首次使用

1. 用户首次进入小程序，完成登录后
2. 系统引导用户进入角色选择页面
3. 用户浏览预设角色，选择一个感兴趣的角色
4. 用户点击"开始对话"按钮，进入聊天界面
5. 系统根据所选角色生成欢迎语，开始对话

### 2. 日常使用

1. 用户进入小程序，点击"心情树洞"或"开始聊天"
2. 系统显示角色选择页面
3. 用户选择之前使用过的角色或新角色
4. 用户点击"开始对话"按钮，进入聊天界面
5. 系统加载角色信息和历史聊天记录，继续之前的对话

### 3. 创建自定义角色

1. 用户进入角色选择页面
2. 用户点击"创建新角色"按钮
3. 系统显示角色编辑页面
4. 用户填写角色信息，包括基本信息、详细背景和性格特点
5. 用户点击"保存"按钮，创建角色
6. 系统返回角色选择页面，显示新创建的角色
7. 用户选择新创建的角色，开始对话

## 十、注意事项

### 1. 角色名称唯一性

- 每个用户的角色名称必须是唯一的
- 如果创建角色时使用了已存在的名称，系统会提示"角色名称已存在，请使用其他名称"
- 遇到此提示时，只需修改角色名称后重新保存即可

### 2. 角色数据同步

- 角色列表会在每次进入页面时自动刷新
- 创建、编辑或删除角色后，角色列表会自动更新
- 如果角色列表未更新，可以下拉刷新页面

### 3. 网络连接

- 角色管理功能需要稳定的网络连接
- 如果遇到网络错误，请检查网络连接后重试

### 4. 角色记忆限制

- 每个角色的记忆数量有限，系统会自动管理记忆
- 重要的记忆会被保留，不重要的记忆会被淘汰
- 如果需要角色记住特定信息，可以在对话中多次强调该信息

### 5. 角色提示词

- 角色的提示词决定了角色的行为和回应方式
- 提示词过长可能会影响角色的响应速度
- 提示词过于复杂可能会导致角色行为不一致

## 十一、常见问题解答

1. **问**：为什么我无法创建同名角色？
   **答**：为了避免混淆，系统不允许同一用户创建同名角色。如果需要创建类似的角色，可以在名称后添加数字或其他标识，如"胡桃2"或"胡桃(工作)"。

2. **问**：我创建的角色在哪里可以看到？
   **答**：创建成功后，新角色会立即显示在角色选择页面的列表中。如果没有显示，可以尝试下拉刷新页面。

3. **问**：如何区分系统预设角色和我自己创建的角色？
   **答**：系统预设角色通常会有专业的头像和详细的描述，而自定义角色会显示您上传的头像和自定义的描述。

4. **问**：我可以创建多少个自定义角色？
   **答**：目前系统没有限制用户创建的角色数量，您可以根据需要创建多个不同的角色。

5. **问**：为什么我的角色创建/编辑成功后会有确认对话框？
   **答**：这是为了确保您知道操作已成功完成，避免因为不确定而重复提交，特别是在网络不稳定的情况下。

6. **问**：角色能记住我们之前的对话吗？
   **答**：是的，角色会记住您之前的对话内容，特别是重要的信息。这些记忆会影响角色在未来对话中的回应方式。

7. **问**：如何让角色更好地了解我？
   **答**：在对话中自然地分享您的兴趣、偏好和经历，系统会自动分析这些信息并更新用户画像。您也可以直接告诉角色您的喜好和期望。

8. **问**：为什么有时候角色的回应方式会变化？
   **答**：角色会根据对话上下文、您的情绪状态和之前的交互历史调整回应方式。这是为了提供更自然、更个性化的对话体验。

## 十二、未来扩展

### 1. 角色社区

- 允许用户分享自己创建的角色
- 提供角色评分和评论功能
- 创建角色排行榜和推荐系统

### 2. 多模态交互

- 支持语音输入和输出
- 支持图片识别和生成
- 支持表情和动画效果

### 3. 角色进化

- 基于用户反馈自动调整角色的性格和行为
- 实现角色的长期记忆和成长
- 角色能够主动学习和适应用户的需求

### 4. 情感分析增强

- 更精细的情感分析，识别用户的情绪状态
- 根据用户情绪调整角色的回应方式
- 提供情绪跟踪和分析报告

### 5. 角色互动

- 支持多角色同时参与对话
- 角色之间可以互相交流和互动
- 创建角色关系网络，模拟真实的社交环境
