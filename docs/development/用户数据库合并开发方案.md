# HeartChat 用户数据库合并开发方案

## 项目概述

### 项目名称
HeartChat 用户数据库结构优化项目

### 项目目标
将现有的 7 个用户相关集合合并为 3 个集合，优化数据结构，提升性能和可维护性。

### 预期收益
- **性能提升**: 减少 60-70% 的数据库查询
- **维护简化**: 减少 80% 的用户相关集合
- **一致性改善**: 消除跨集合数据不一致
- **扩展性增强**: 为未来功能提供更好的数据结构

## 技术方案

### 1. 数据库结构设计

#### 1.1 合并后的集合结构
- **users**: 用户核心信息（合并 user_base, user_profile, user_config, user_stats）
- **userInterests**: 用户兴趣数据（保持独立）
- **userReports**: 用户报告数据（保持独立）

#### 1.2 users 集合字段结构
```javascript
{
  _id: ObjectId,
  
  // 基础认证信息
  openid: String,                   // 微信openid (唯一索引)
  user_id: String,                  // 用户ID (与openid相同)
  username: String,                 // 用户昵称
  avatar_url: String,               // 头像URL
  
  // 用户类型和状态
  user_type: Number,                // 1-普通用户, 2-VIP用户, 3-管理员
  status: Number,                   // 1-正常, 0-禁用
  
  // 详细个人信息
  profile: {
    gender: Number,                 // 0-未知, 1-男, 2-女
    age: Number,                    // 年龄
    birthday: Date,                 // 生日
    country: String,                // 国家
    province: String,               // 省份
    city: String,                   // 城市
    bio: String                     // 个人简介
  },
  
  // 用户配置
  config: {
    dark_mode: Boolean,             // 深色模式
    notification_enabled: Boolean,  // 通知设置
    language: String,               // 语言: 'zh-CN'/'en-US'
    theme: String,                  // 主题设置
    font_size: Number               // 字体大小
  },
  
  // 统计信息
  stats: {
    chat_count: Number,             // 对话次数
    solved_count: Number,           // 解决问题次数
    rating_avg: Number,             // 平均评分
    rating_count: Number,           // 评分次数
    active_days: Number,            // 活跃天数
    last_active: Date,              // 最后活跃时间
    consecutive_days: Number,       // 连续活跃天数
    total_session_time: Number     // 总会话时长(分钟)
  },
  
  // 系统信息
  created_at: Date,                 // 创建时间
  updated_at: Date                  // 更新时间
}
```

#### 1.3 索引设计
```javascript
// 主键索引
{ _id: 1 }

// 唯一索引
{ openid: 1 },                    // 微信openid唯一索引
{ user_id: 1 }                    // 用户ID唯一索引

// 复合索引
{ user_type: 1, status: 1 },        // 用户类型和状态
{ status: 1, created_at: -1 },      // 状态和创建时间
{ "stats.last_active": -1 },        // 最后活跃时间
{ user_type: 1, "stats.active_days": -1 }  // 用户类型和活跃天数
```

### 2. 开发任务分解

#### 2.1 云函数开发
1. **数据迁移云函数** (`migrateUserData`)
   - 创建新的 users 集合结构
   - 执行数据迁移和合并
   - 数据验证和错误处理

2. **用户管理云函数更新** (`user`)
   - 更新用户查询逻辑
   - 更新用户创建和更新逻辑
   - 兼容性处理

3. **登录云函数更新** (`login`)
   - 更新用户登录逻辑
   - 更新用户信息获取逻辑

4. **统计分析云函数更新** (`analysis`)
   - 更新用户统计逻辑
   - 更新数据分析查询

#### 2.2 前端代码更新
1. **用户服务层更新** (`services/user-service.js`)
   - 更新数据模型
   - 更新API调用逻辑

2. **用户页面更新** (`pages/user/`)
   - 更新数据绑定
   - 更新表单处理

3. **组件更新** (`components/`)
   - 更新用户信息显示组件
   - 更新配置组件

### 3. 开发时间安排

#### 第1周：准备阶段
- **Day 1-2**: 详细数据分析和结构设计
- **Day 3-4**: 编写迁移脚本和测试
- **Day 5-7**: 准备回滚方案和监控

#### 第2周：开发阶段
- **Day 1-3**: 开发迁移云函数
- **Day 4-5**: 开发数据验证工具
- **Day 6-7**: 单元测试和集成测试

#### 第3周：测试阶段
- **Day 1-3**: 使用测试数据完整迁移测试
- **Day 4-5**: 性能测试和优化
- **Day 6-7**: 回滚测试和应急预案验证

#### 第4周：生产部署
- **Day 1**: 生产环境数据备份
- **Day 2**: 执行数据迁移
- **Day 3**: 数据验证和监控
- **Day 4-5**: 应用代码更新和测试
- **Day 6-7**: 稳定性观察和优化

### 4. 技术实现细节

#### 4.1 数据迁移云函数
```javascript
// cloudfunctions/migrateUserData/index.js
const cloud = require('wx-server-sdk')
cloud.init()

const db = cloud.database()
const _ = db.command
const $ = _.aggregate

exports.main = async (event, context) => {
  const { action, batch = 100 } = event
  
  switch (action) {
    case 'prepare':
      return await prepareMigration()
    case 'migrate':
      return await migrateBatch(batch)
    case 'validate':
      return await validateMigration()
    case 'cleanup':
      return await cleanupMigration()
    default:
      return { code: -1, message: '未知操作' }
  }
}

// 准备迁移环境
async function prepareMigration() {
  try {
    // 创建临时集合
    await db.createCollection('users_temp')
    
    // 创建索引
    await db.collection('users_temp').addIndex({
      key: { openid: 1 },
      unique: true
    })
    
    return { code: 0, message: '迁移环境准备完成' }
  } catch (error) {
    console.error('准备迁移失败:', error)
    return { code: -1, message: '准备迁移失败', error }
  }
}

// 执行批量迁移
async function migrateBatch(batchSize) {
  try {
    // 获取源数据
    const usersResult = await db.collection('users').get()
    const userBaseResult = await db.collection('user_base').get()
    const userProfileResult = await db.collection('user_profile').get()
    const userConfigResult = await db.collection('user_config').get()
    const userStatsResult = await db.collection('user_stats').get()
    
    // 构建数据映射
    const userBaseMap = new Map(userBaseResult.data.map(item => [item.user_id, item]))
    const userProfileMap = new Map(userProfileResult.data.map(item => [item.user_id, item]))
    const userConfigMap = new Map(userConfigResult.data.map(item => [item.user_id, item]))
    const userStatsMap = new Map(userStatsResult.data.map(item => [item.user_id, item]))
    
    // 合并数据
    const mergedUsers = usersResult.data.map(user => {
      const baseInfo = userBaseMap.get(user.user_id) || {}
      const profileInfo = userProfileMap.get(user.user_id) || {}
      const configInfo = userConfigMap.get(user.user_id) || {}
      const statsInfo = userStatsMap.get(user.user_id) || {}
      
      return {
        openid: user.openid || baseInfo.openid,
        user_id: user.user_id,
        username: user.username || baseInfo.username,
        avatar_url: user.avatar_url || baseInfo.avatar_url,
        user_type: user.user_type || baseInfo.user_type || 1,
        status: user.status || baseInfo.status || 1,
        profile: {
          gender: profileInfo.gender || 0,
          age: profileInfo.age || 0,
          birthday: profileInfo.birthday || null,
          country: profileInfo.country || '',
          province: profileInfo.province || '',
          city: profileInfo.city || '',
          bio: profileInfo.bio || ''
        },
        config: {
          dark_mode: configInfo.dark_mode || false,
          notification_enabled: configInfo.notification_enabled || true,
          language: configInfo.language || 'zh-CN',
          theme: configInfo.theme || 'default',
          font_size: configInfo.font_size || 16
        },
        stats: {
          chat_count: statsInfo.chat_count || 0,
          solved_count: statsInfo.solved_count || 0,
          rating_avg: statsInfo.rating_avg || 0,
          rating_count: statsInfo.rating_count || 0,
          active_days: statsInfo.active_days || 0,
          last_active: statsInfo.last_active || new Date(),
          consecutive_days: statsInfo.consecutive_days || 0,
          total_session_time: statsInfo.total_session_time || 0
        },
        created_at: user.created_at || new Date(),
        updated_at: new Date()
      }
    })
    
    // 批量插入
    const chunks = chunkArray(mergedUsers, batchSize)
    let migrated = 0
    
    for (const chunk of chunks) {
      await db.collection('users_temp').add({
        data: chunk
      })
      migrated += chunk.length
    }
    
    return { 
      code: 0, 
      message: '批量迁移完成', 
      data: { 
        total: mergedUsers.length, 
        migrated,
        chunks: chunks.length 
      } 
    }
  } catch (error) {
    console.error('批量迁移失败:', error)
    return { code: -1, message: '批量迁移失败', error }
  }
}

// 验证迁移结果
async function validateMigration() {
  try {
    // 验证记录数
    const originalCount = await db.collection('users').count()
    const tempCount = await db.collection('users_temp').count()
    
    // 验证关键字段
    const tempUsers = await db.collection('users_temp').limit(100).get()
    const validationResults = tempUsers.data.map(user => ({
      user_id: user.user_id,
      has_openid: !!user.openid,
      has_profile: !!user.profile,
      has_config: !!user.config,
      has_stats: !!user.stats
    }))
    
    return {
      code: 0,
      message: '验证完成',
      data: {
        originalCount: originalCount.total,
        tempCount: tempCount.total,
        validationResults
      }
    }
  } catch (error) {
    console.error('验证失败:', error)
    return { code: -1, message: '验证失败', error }
  }
}

// 清理迁移
async function cleanupMigration() {
  try {
    // 重命名原集合
    await db.collection('users').rename('users_backup')
    await db.collection('user_base').rename('user_base_backup')
    await db.collection('user_profile').rename('user_profile_backup')
    await db.collection('user_config').rename('user_config_backup')
    await db.collection('user_stats').rename('user_stats_backup')
    
    // 重命名新集合
    await db.collection('users_temp').rename('users')
    
    return { code: 0, message: '清理完成' }
  } catch (error) {
    console.error('清理失败:', error)
    return { code: -1, message: '清理失败', error }
  }
}

// 工具函数：数组分块
function chunkArray(array, size) {
  const chunks = []
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size))
  }
  return chunks
}
```

#### 4.2 用户管理云函数更新
```javascript
// cloudfunctions/user/index.js
const cloud = require('wx-server-sdk')
cloud.init()

const db = cloud.database()

exports.main = async (event, context) => {
  const { action, data } = event
  
  switch (action) {
    case 'getUserInfo':
      return await getUserInfo(data.userId)
    case 'updateUserInfo':
      return await updateUserInfo(data.userId, data.userInfo)
    case 'updateUserConfig':
      return await updateUserConfig(data.userId, data.config)
    case 'updateUserStats':
      return await updateUserStats(data.userId, data.stats)
    case 'getUserList':
      return await getUserList(data.filters)
    default:
      return { code: -1, message: '未知操作' }
  }
}

// 获取用户信息
async function getUserInfo(userId) {
  try {
    const userResult = await db.collection('users')
      .doc(userId)
      .get()
    
    return {
      code: 0,
      message: '获取成功',
      data: userResult.data
    }
  } catch (error) {
    console.error('获取用户信息失败:', error)
    return { code: -1, message: '获取用户信息失败', error }
  }
}

// 更新用户信息
async function updateUserInfo(userId, userInfo) {
  try {
    const updateData = {
      ...userInfo,
      updated_at: new Date()
    }
    
    await db.collection('users')
      .doc(userId)
      .update({
        data: updateData
      })
    
    return {
      code: 0,
      message: '更新成功'
    }
  } catch (error) {
    console.error('更新用户信息失败:', error)
    return { code: -1, message: '更新用户信息失败', error }
  }
}

// 更新用户配置
async function updateUserConfig(userId, config) {
  try {
    await db.collection('users')
      .doc(userId)
      .update({
        data: {
          config: config,
          updated_at: new Date()
        }
      })
    
    return {
      code: 0,
      message: '配置更新成功'
    }
  } catch (error) {
    console.error('更新用户配置失败:', error)
    return { code: -1, message: '更新用户配置失败', error }
  }
}

// 更新用户统计
async function updateUserStats(userId, stats) {
  try {
    await db.collection('users')
      .doc(userId)
      .update({
        data: {
          'stats': stats,
          updated_at: new Date()
        }
      })
    
    return {
      code: 0,
      message: '统计更新成功'
    }
  } catch (error) {
    console.error('更新用户统计失败:', error)
    return { code: -1, message: '更新用户统计失败', error }
  }
}

// 获取用户列表
async function getUserList(filters = {}) {
  try {
    let query = db.collection('users')
    
    // 应用过滤条件
    if (filters.user_type) {
      query = query.where({ user_type: filters.user_type })
    }
    if (filters.status) {
      query = query.where({ status: filters.status })
    }
    
    // 分页
    const page = filters.page || 1
    const pageSize = filters.pageSize || 20
    const skip = (page - 1) * pageSize
    
    const result = await query
      .skip(skip)
      .limit(pageSize)
      .orderBy('created_at', 'desc')
      .get()
    
    return {
      code: 0,
      message: '获取成功',
      data: {
        list: result.data,
        page,
        pageSize,
        total: result.data.length
      }
    }
  } catch (error) {
    console.error('获取用户列表失败:', error)
    return { code: -1, message: '获取用户列表失败', error }
  }
}
```

### 5. 测试方案

#### 5.1 单元测试
- 数据迁移逻辑测试
- 用户管理功能测试
- 配置更新测试
- 统计更新测试

#### 5.2 集成测试
- 完整数据迁移流程测试
- 前后端数据一致性测试
- 性能基准测试
- 并发访问测试

#### 5.3 验收测试
- 功能完整性验证
- 数据一致性验证
- 性能指标验证
- 用户体验验证

### 6. 部署方案

#### 6.1 部署环境
- **开发环境**: 用于开发和测试
- **测试环境**: 用于集成测试和性能测试
- **生产环境**: 用于正式上线

#### 6.2 部署步骤
1. **环境准备**: 安装依赖和配置
2. **代码部署**: 部署云函数和前端代码
3. **数据迁移**: 执行数据迁移脚本
4. **验证测试**: 功能和性能验证
5. **上线发布**: 切换流量到新系统

### 7. 监控和维护

#### 7.1 监控指标
- **性能监控**: 查询响应时间、并发数
- **数据监控**: 数据完整性、一致性
- **错误监控**: 错误率、异常情况
- **业务监控**: 用户活跃度、功能使用情况

#### 7.2 维护计划
- **日常维护**: 日志分析、性能优化
- **定期维护**: 数据备份、索引优化
- **应急维护**: 故障处理、快速恢复

### 8. 风险评估

#### 8.1 技术风险
- **数据丢失风险**: 通过完整备份和回滚方案降低
- **性能下降风险**: 通过索引优化和查询优化降低
- **兼容性风险**: 通过充分测试和兼容性处理降低

#### 8.2 业务风险
- **服务中断风险**: 通过分批迁移和灰度发布降低
- **用户体验风险**: 通过充分测试和用户反馈降低

#### 8.3 风险应对
- **回滚方案**: 准备完整的回滚方案
- **应急预案**: 制定详细的应急预案
- **监控告警**: 建立完善的监控告警机制

### 9. 项目交付物

#### 9.1 代码交付
- 数据迁移云函数
- 更新后的用户管理云函数
- 更新后的前端代码
- 测试代码和脚本

#### 9.2 文档交付
- 技术设计文档
- 部署操作手册
- 维护手册
- 测试报告

#### 9.3 培训交付
- 技术培训
- 运维培训
- 用户培训

## 项目团队

### 角色分工
- **项目经理**: 负责项目整体协调
- **后端开发**: 负责云函数开发和数据迁移
- **前端开发**: 负责前端代码更新
- **测试工程师**: 负责测试方案执行
- **运维工程师**: 负责部署和监控

### 沟通机制
- **每日站会**: 同步进度和问题
- **周例会**: 总结进展和调整计划
- **技术评审**: 评审技术方案和代码质量
- **项目汇报**: 向 stakeholders 汇报项目进展

## 项目预算

### 人力资源
- 后端开发: 2人 × 4周
- 前端开发: 1人 × 2周
- 测试工程师: 1人 × 2周
- 项目经理: 1人 × 4周

### 技术资源
- 云开发资源
- 测试环境资源
- 监控和日志服务

### 预算总计
- 人力成本: 约 X 万元
- 技术资源: 约 Y 万元
- 其他成本: 约 Z 万元

## 总结

本开发方案详细描述了 HeartChat 用户数据库合并的完整实施计划，包括技术方案、开发任务、时间安排、测试方案、部署策略、风险评估等内容。通过这个方案的实施，将显著提升系统的性能和可维护性，为用户提供更好的服务体验。

项目成功的关键在于：
1. **充分的技术准备**: 详细的数据分析和结构设计
2. **严格的测试验证**: 全面的功能测试和性能测试
3. **谨慎的部署策略**: 分批迁移和灰度发布
4. **完善的风险控制**: 备份方案和应急预案

通过团队的协作和努力，相信这个项目能够顺利实施并达到预期目标。