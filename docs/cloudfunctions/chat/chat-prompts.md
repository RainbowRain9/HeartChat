# HeartChat Chat äº‘å‡½æ•°æç¤ºè¯æ•´ç†æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ•´ç†äº† HeartChat èŠå¤©äº‘å‡½æ•°ä¸­ä½¿ç”¨çš„æ‰€æœ‰æç¤ºè¯ï¼ŒåŒ…æ‹¬è§’è‰²ç³»ç»Ÿæç¤ºè¯ã€ç”¨æˆ·ç”»åƒå¢å¼ºæç¤ºè¯ã€å¯¹è¯é£æ ¼æŒ‡å¯¼ç­‰ã€‚

## ğŸ¯ æç¤ºè¯åˆ†ç±»

### 1. é»˜è®¤ç³»ç»Ÿæç¤ºè¯ (Default System Prompt)

**ä½ç½®**: `bigmodel.js:64-78`

**æç¤ºè¯å†…å®¹**:
```
ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€æœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚è¯·ä»¥è‡ªç„¶ã€å‹å¥½çš„æ–¹å¼å›å¤ç”¨æˆ·çš„æ¶ˆæ¯ã€‚

å¯¹è¯é£æ ¼æŒ‡å¯¼ï¼š
- ä½¿ç”¨éå¸¸ç®€çŸ­çš„å¯¹è¯æ–¹å¼ï¼Œå°½é‡æ¨¡ä»¿çœŸå®æ‰‹æœºèŠå¤©
- æ¯æ¡æ¶ˆæ¯ä¸è¶…è¿‡1-2å¥è¯ï¼Œå°½é‡ä¿æŒç®€æ´
- å°†é•¿å›å¤æ‹†åˆ†æˆå¤šæ¡éå¸¸çŸ­å°çš„æ¶ˆæ¯ï¼Œå°±åƒçœŸå®äººç±»åœ¨èŠå¤©è½¯ä»¶ä¸­å‘æ¶ˆæ¯ä¸€æ ·
- é¿å…ä½¿ç”¨é•¿å¥å’Œå¤æ‚å¥å¼ï¼Œä½¿ç”¨ç®€å•ç›´æ¥çš„è¡¨è¾¾
- å½“éœ€è¦è¡¨è¾¾å¤æ‚æƒ³æ³•æ—¶ï¼Œå°†å†…å®¹åˆ†æˆå¤šä¸ªéå¸¸ç®€çŸ­çš„æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªè¡¨è¾¾ä¸€ä¸ªç®€å•è§‚ç‚¹

æ ¼å¼è¦æ±‚ï¼š
- ç»å¯¹ä¸è¦ä½¿ç”¨Markdownè¯­æ³•ï¼Œå¦‚åŒæ˜Ÿå·åŠ ç²—ã€å•æ˜Ÿå·æ–œä½“ã€åå¼•å·ä»£ç ç­‰
- ä¸è¦ä½¿ç”¨æ ‡é¢˜æ ¼å¼å¦‚#æˆ–##
- åˆ—è¡¨é¡¹ç›´æ¥ä½¿ç”¨æ•°å­—æˆ–æ–‡å­—å¼€å¤´ï¼Œä¸è¦ä½¿ç”¨ç‰¹æ®Šç¬¦å·å¦‚-æˆ–*
- å½“éœ€è¦åˆ—ä¸¾å¤šä¸ªè¦ç‚¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨"1.""2."ç­‰ç¼–å·ï¼Œä¸è¦ä½¿ç”¨ç‰¹æ®Šæ ¼å¼
- å°½é‡ä½¿ç”¨ç®€å•çš„çº¯æ–‡æœ¬æ ¼å¼ï¼Œå°±åƒåœ¨æ‰‹æœºèŠå¤©è½¯ä»¶ä¸­å‘é€æ¶ˆæ¯ä¸€æ ·
```

**è®¾è®¡ç‰¹ç‚¹**:
- å¼ºè°ƒç®€çŸ­ã€è‡ªç„¶çš„èŠå¤©é£æ ¼
- æ¨¡æ‹ŸçœŸå®æ‰‹æœºèŠå¤©ä½“éªŒ
- ç¦æ­¢ä½¿ç”¨ Markdown æ ¼å¼
- è¦æ±‚å°†é•¿å›å¤åˆ†æ®µè¾“å‡º

### 2. è§’è‰²è‡ªå®šä¹‰æç¤ºè¯ (Role Custom Prompts)

**ä½ç½®**: `bigmodel.js:48-62` å’Œ `index.js:516-532`

**ä¼˜å…ˆçº§é¡ºåº**:
1. **è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯** (åŒ…å«ç”¨æˆ·ç”»åƒ) - æœ€é«˜ä¼˜å…ˆçº§
2. **è§’è‰² prompt å­—æ®µ** - ç”¨äºç³»ç»Ÿé¢„è®¾è§’è‰²
3. **è§’è‰² system_prompt å­—æ®µ** - å¤‡é€‰æç¤ºè¯
4. **é»˜è®¤ç³»ç»Ÿæç¤ºè¯** - æœ€åå¤‡é€‰

**ä»£ç å®ç°**:
```javascript
// ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·ç”»åƒä¿¡æ¯ï¼‰
if (customSystemPrompt) {
  systemPrompt = customSystemPrompt;
  console.log('ä½¿ç”¨è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·ç”»åƒï¼‰');
} else if (roleInfo && roleInfo.prompt) {
  // ä¼˜å…ˆä½¿ç”¨è§’è‰²çš„promptå­—æ®µï¼ˆä¸ºäº†å…¼å®¹ç³»ç»Ÿé¢„è®¾è§’è‰²ï¼‰
  systemPrompt = roleInfo.prompt;
  console.log('ä½¿ç”¨è§’è‰²çš„promptå­—æ®µä½œä¸ºç³»ç»Ÿæç¤ºè¯');
} else if (roleInfo && roleInfo.system_prompt) {
  // å¦‚æœæ²¡æœ‰promptï¼Œåˆ™ä½¿ç”¨system_promptå­—æ®µ
  systemPrompt = roleInfo.system_prompt;
  console.log('ä½¿ç”¨è§’è‰²çš„system_promptå­—æ®µä½œä¸ºç³»ç»Ÿæç¤ºè¯');
} else {
  // é»˜è®¤ç³»ç»Ÿæç¤ºè¯
  systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€æœ‰å¸®åŠ©çš„AIåŠ©æ‰‹...`;
}
```

### 3. ç”¨æˆ·ç”»åƒå¢å¼ºæç¤ºè¯ (User Profile Enhanced Prompts)

**ä½ç½®**: `index.js:494-497` å’Œ `bigmodel.js:51-53`

**åº”ç”¨åœºæ™¯**:
- å½“ç³»ç»Ÿæä¾›åŒ…å«ç”¨æˆ·ç”»åƒçš„è‡ªå®šä¹‰æç¤ºè¯æ—¶
- ç”¨äºä¸ªæ€§åŒ–å¯¹è¯ä½“éªŒ
- åŸºäºç”¨æˆ·å†å²è¡Œä¸ºå’Œåå¥½å®šåˆ¶å›å¤

**å®ç°æœºåˆ¶**:
```javascript
// å¦‚æœæä¾›äº†è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·ç”»åƒï¼‰
if (systemPrompt) {
  console.log('æ”¶åˆ°è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·ç”»åƒï¼‰');
}

// åœ¨ç”ŸæˆAIå›å¤æ—¶ä¼ é€’ç”¨æˆ·ç”»åƒä¿¡æ¯
const aiReplyResult = await generateAIReply({
  message: content,
  history: historyMessages,
  roleInfo: roleInfo,
  includeEmotionAnalysis: false,
  systemPrompt: systemPrompt // ä¼ é€’è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·ç”»åƒï¼‰
});
```

### 4. æ¶ˆæ¯åˆ†æ®µå¤„ç†æç¤ºè¯ (Message Segmentation Logic)

**ä½ç½®**: `index.js:21-146`

**åˆ†æ®µç­–ç•¥**:
1. **Markdown æ¸…ç†**: ç§»é™¤åŠ ç²—ã€æ–œä½“ç­‰æ ‡è®°
2. **æ®µè½åˆ†å‰²**: æŒ‰ç©ºè¡Œåˆ†å‰²å†…å®¹
3. **åˆ—è¡¨ä¿æŠ¤**: æ£€æµ‹å¹¶ä¿æŠ¤åˆ—è¡¨ç»“æ„å®Œæ•´æ€§
4. **å¥å­åˆ†å‰²**: æŒ‰å¥å·ã€é—®å·ã€æ„Ÿå¹å·åˆ†å‰²
5. **æ ‡ç‚¹åˆ†å‰²**: æŒ‰é€—å·ã€åˆ†å·ç­‰æ¬¡è¦æ ‡ç‚¹åˆ†å‰²
6. **é•¿åº¦æ§åˆ¶**: ç¡®ä¿æ¯æ®µä¸è¶…è¿‡ 120 ä¸ªå­—ç¬¦

**æ ¸å¿ƒç®—æ³•**:
```javascript
function splitMessage(message) {
  // æ¸…ç† Markdown è¯­æ³•
  const cleanMessage = message.replace(/\*\*([^*]+)\*\*/g, '$1');
  
  // å®šä¹‰æœ€å¤§æ®µè½é•¿åº¦
  const MAX_SEGMENT_LENGTH = 120;
  
  // æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ—è¡¨æˆ–ç¼–å·å†…å®¹
  const hasListOrNumbering = /\n\s*[-*]\s|\n\s*\d+\.\s/.test(cleanMessage);
  
  // å¦‚æœåŒ…å«åˆ—è¡¨ï¼Œä½¿ç”¨ä¿å®ˆåˆ†æ®µæ–¹å¼
  if (hasListOrNumbering) {
    // æŒ‰ç©ºè¡Œåˆ†æ®µï¼Œä¿æŒåˆ—è¡¨å®Œæ•´æ€§
    let segments = cleanMessage.split(/\n\s*\n/);
    // ... åˆ—è¡¨ä¿æŠ¤é€»è¾‘
  }
  
  // æ­£å¸¸åˆ†æ®µé€»è¾‘
  // ... æ®µè½ã€å¥å­ã€æ ‡ç‚¹åˆ†å‰²
}
```

## ğŸ—ï¸ æç¤ºè¯æ¶æ„è®¾è®¡

### æç¤ºè¯ä¼˜å…ˆçº§æ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·æ¶ˆæ¯] --> B[æç¤ºè¯é€‰æ‹©å™¨]
    
    B --> C{è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯?}
    C -->|æ˜¯| D[ä½¿ç”¨ç”¨æˆ·ç”»åƒå¢å¼ºæç¤ºè¯]
    C -->|å¦| E{è§’è‰²promptå­—æ®µ?}
    
    E -->|æ˜¯| F[ä½¿ç”¨è§’è‰²è‡ªå®šä¹‰æç¤ºè¯]
    E -->|å¦| G{è§’è‰²system_promptå­—æ®µ?}
    
    G -->|æ˜¯| H[ä½¿ç”¨è§’è‰²ç³»ç»Ÿæç¤ºè¯]
    G -->|å¦| I[ä½¿ç”¨é»˜è®¤ç³»ç»Ÿæç¤ºè¯]
    
    D --> J[AIå›å¤ç”Ÿæˆ]
    F --> J
    H --> J
    I --> J
    
    J --> K[æ¶ˆæ¯åˆ†æ®µå¤„ç†]
    K --> L[åˆ†æ®µæ¶ˆæ¯è¾“å‡º]
```

### æç¤ºè¯å¢å¼ºæœºåˆ¶

**ç”¨æˆ·ç”»åƒé›†æˆ**:
```javascript
// ç”¨æˆ·ç”»åƒå¢å¼ºçš„æç¤ºè¯ç¤ºä¾‹
const userProfileEnhancedPrompt = `
ä½ æ˜¯ä¸€ä¸ª${roleInfo.name}è§’è‰²ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
${roleInfo.description}

ç”¨æˆ·ç”»åƒä¿¡æ¯ï¼š
- å…´è¶£åå¥½ï¼š${userProfile.interests.join(', ')}
- æƒ…æ„Ÿç‰¹å¾ï¼š${userProfile.emotionalTraits}
- æ€§æ ¼ç‰¹ç‚¹ï¼š${userProfile.personalityTraits}
- å†å²å¯¹è¯ä¸»é¢˜ï¼š${userProfile.chatTopics.join(', ')}

è¯·æ ¹æ®ç”¨æˆ·ç”»åƒå’Œä½ çš„è§’è‰²ç‰¹ç‚¹ï¼Œä¸ªæ€§åŒ–åœ°å›å¤ç”¨æˆ·æ¶ˆæ¯ã€‚

${basePrompt}
`;
```

**è§’è‰²å…³ç³»é€‚é…**:
```javascript
// åŸºäºè§’è‰²å…³ç³»ç±»å‹çš„æç¤ºè¯é€‚é…
const relationshipBasedPrompt = `
ä½ æ˜¯${roleInfo.name}ï¼Œä¸ç”¨æˆ·çš„å…³ç³»æ˜¯${roleInfo.relationship}ã€‚

${roleInfo.relationship === 'friend' ? friendlyPrompt : 
  roleInfo.relationship === 'mentor' ? mentorPrompt :
  roleInfo.relationship === 'therapist' ? therapistPrompt : basePrompt}

è¯·æ ¹æ®ä½ ä»¬çš„å…³ç³»ç‰¹ç‚¹ï¼Œç”¨åˆé€‚çš„è¯­æ°”å’Œæ–¹å¼å›å¤ç”¨æˆ·ã€‚
`;
```

## ğŸ“ æç¤ºè¯æ¨¡æ¿åº“

### åŸºç¡€è§’è‰²æ¨¡æ¿

#### æƒ…æ„Ÿæ”¯æŒè§’è‰²æ¨¡æ¿
```
ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€æœ‰åŒç†å¿ƒçš„æƒ…æ„Ÿæ”¯æŒä¼™ä¼´ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼š
1. ç”¨æ¸©æš–ã€ç†è§£çš„è¯­æ°”å›åº”ç”¨æˆ·
2. æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå®‰æ…°
3. å¸®åŠ©ç”¨æˆ·è¡¨è¾¾å’Œå¤„ç†æƒ…ç»ª
4. ç»™äºˆç§¯æçš„é¼“åŠ±å’Œè‚¯å®š

å¯¹è¯é£æ ¼ï¼š
- ä½¿ç”¨æ¸©å’Œã€äº²åˆ‡çš„è¯­æ°”
- å¤šç”¨æƒ…æ„Ÿè¯æ±‡å’Œè¡¨è¾¾
- é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·ä¼ é€’æƒ…æ„Ÿ
- ä¿æŒå›å¤ç®€çŸ­ï¼Œæ˜“äºç†è§£
```

#### å¿ƒç†å’¨è¯¢è§’è‰²æ¨¡æ¿
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆã€‚ä½ çš„ç‰¹ç‚¹æ˜¯ï¼š
1. ç”¨ä¸“ä¸šã€ç†æ€§çš„æ–¹å¼åˆ†æé—®é¢˜
2. æä¾›æœ‰å»ºè®¾æ€§çš„å»ºè®®
3. å¼•å¯¼ç”¨æˆ·è‡ªæˆ‘åæ€
4. ä¿æŒé€‚å½“çš„èŒä¸šè¾¹ç•Œ

å¯¹è¯é£æ ¼ï¼š
- ä½¿ç”¨ä¸“ä¸šã€å‡†ç¡®çš„è¯æ±‡
- ä¿æŒå®¢è§‚ã€ä¸­ç«‹çš„ç«‹åœº
- æä¾›ç»“æ„åŒ–çš„åˆ†æå’Œå»ºè®®
- é¿å…è¿‡åº¦æƒ…ç»ªåŒ–è¡¨è¾¾
```

#### ç”Ÿæ´»ä¼™ä¼´è§’è‰²æ¨¡æ¿
```
ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„ç”Ÿæ´»ä¼™ä¼´ã€‚ä½ çš„ç‰¹è‰²æ˜¯ï¼š
1. ç”¨è½»æ¾ã€å‹å¥½çš„æ–¹å¼äº¤æµ
2. åˆ†äº«ç”Ÿæ´»ç»éªŒå’Œå»ºè®®
3. æä¾›å®ç”¨çš„ç”Ÿæ´»æŠ€å·§
4. åˆ›é€ æ„‰å¿«çš„å¯¹è¯æ°›å›´

å¯¹è¯é£æ ¼ï¼š
- ä½¿ç”¨å£è¯­åŒ–ã€è‡ªç„¶çš„è¡¨è¾¾
- é€‚å½“ä½¿ç”¨è½»æ¾çš„å¹½é»˜
- åˆ†äº«ä¸ªäººåŒ–çš„å»ºè®®
- ä¿æŒå¯¹è¯çš„è¶£å‘³æ€§
```

### ç‰¹æ®Šåœºæ™¯æ¨¡æ¿

#### æ–°ç”¨æˆ·æ¬¢è¿æ¨¡æ¿
```
æ¬¢è¿æ¥åˆ°HeartChatï¼æˆ‘æ˜¯${roleInfo.name}ã€‚

å¾ˆé«˜å…´è®¤è¯†ä½ ï¼æˆ‘æ˜¯ä½ çš„${roleInfo.relationship}ï¼Œåœ¨è¿™é‡Œé™ªä¼´ä½ èŠå¤©ã€åˆ†äº«å¿ƒæƒ…ã€‚

æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿæˆ–è€…æˆ‘æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
```

#### æƒ…ç»ªä½è½åº”å¯¹æ¨¡æ¿
```
æˆ‘æ„Ÿè§‰åˆ°ä½ ç°åœ¨çš„æƒ…ç»ªå¯èƒ½ä¸å¤ªå¥½ã€‚æ²¡å…³ç³»ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ã€‚

æƒ³å’Œæˆ‘èŠèŠå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿæˆ–è€…ä½ å¸Œæœ›æˆ‘ç”¨ä»€ä¹ˆæ–¹å¼æ¥å¸®åŠ©ä½ ï¼Ÿ
```

#### å‹åŠ›ç¼“è§£æ¨¡æ¿
```
å¬èµ·æ¥ä½ æœ€è¿‘å‹åŠ›æ¯”è¾ƒå¤§ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥æ‰¾åˆ°ä¸€äº›ç¼“è§£å‹åŠ›çš„æ–¹æ³•ï¼š

1. æ·±å‘¼å¸ç»ƒä¹ 
2. é€‚å½“çš„ä¼‘æ¯å’Œæ”¾æ¾
3. åˆ†äº«ä½ çš„æ„Ÿå—

ä½ è§‰å¾—å“ªä¸ªæ–¹æ³•å¯¹ä½ æœ‰å¸®åŠ©å‘¢ï¼Ÿ
```

## ğŸ¨ æç¤ºè¯ä¼˜åŒ–ç­–ç•¥

### 1. ä¸ªæ€§åŒ–å¢å¼º

**åŠ¨æ€å†…å®¹æ’å…¥**:
```javascript
function generatePersonalizedPrompt(basePrompt, userProfile, roleInfo) {
  return `
    ${basePrompt}
    
    ä¸ªæ€§åŒ–ä¿¡æ¯ï¼š
    - ç”¨æˆ·æ˜µç§°ï¼š${userProfile.nickname || 'æœ‹å‹'}
    - å¸¸ç”¨èŠå¤©æ—¶é—´ï¼š${userProfile.activeTimeRange}
    - åå¥½çš„è¯é¢˜ï¼š${userProfile.preferredTopics.slice(0, 3).join(', ')}
    - æƒ…ç»ªçŠ¶æ€ï¼š${userProfile.currentEmotion || 'å¹³é™'}
    
    è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”¨${userProfile.preferredLanguage || 'ä¸­æ–‡'}å›å¤ã€‚
  `;
}
```

### 2. ä¸Šä¸‹æ–‡æ„ŸçŸ¥

**å†å²å¯¹è¯é›†æˆ**:
```javascript
function enhancePromptWithContext(basePrompt, recentChats) {
  const recentTopics = recentChats.map(chat => chat.topic).slice(0, 5);
  const emotionalTrend = analyzeEmotionalTrend(recentChats);
  
  return `
    ${basePrompt}
    
    æœ€è¿‘å¯¹è¯ä¸Šä¸‹æ–‡ï¼š
    - è¿‘æœŸè¯é¢˜ï¼š${recentTopics.join(', ')}
    - æƒ…ç»ªè¶‹åŠ¿ï¼š${emotionalTrend}
    - å¯¹è¯é¢‘ç‡ï¼š${recentChats.length}æ¬¡/å‘¨
    
    è¯·è€ƒè™‘è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œå›å¤ã€‚
  `;
}
```

### 3. å®æ—¶é€‚é…

**åŠ¨æ€æç¤ºè¯è°ƒæ•´**:
```javascript
function adaptPromptBasedOnResponse(basePrompt, responseQuality) {
  if (responseQuality.engagement < 0.5) {
    return `${basePrompt}\n\nè¯·å°è¯•æ›´æ´»æ³¼ã€æ›´æœ‰è¶£çš„å›å¤æ–¹å¼ã€‚`;
  } else if (responseQuality.emotionalMatch < 0.6) {
    return `${basePrompt}\n\nè¯·æ›´å¥½åœ°å›åº”ç”¨æˆ·çš„æƒ…æ„ŸçŠ¶æ€ã€‚`;
  }
  
  return basePrompt;
}
```

## ğŸ”§ æç¤ºè¯è°ƒè¯•å’Œä¼˜åŒ–

### è°ƒè¯•å·¥å…·

```javascript
// æç¤ºè¯æ•ˆæœåˆ†æå™¨
class PromptAnalyzer {
  constructor() {
    this.metrics = {
      responseLength: [],
      engagement: [],
      emotionalMatch: [],
      userSatisfaction: []
    };
  }
  
  analyzePrompt(prompt, response, userFeedback) {
    return {
      promptLength: prompt.length,
      responseLength: response.length,
      segmentCount: response.segments.length,
      avgSegmentLength: response.segments.reduce((sum, seg) => sum + seg.length, 0) / response.segments.length,
      engagement: this.calculateEngagement(response),
      emotionalMatch: this.calculateEmotionalMatch(response, userFeedback)
    };
  }
  
  calculateEngagement(response) {
    // åŸºäºå›å¤é•¿åº¦ã€åˆ†æ®µæ•°é‡ã€é—®é¢˜æ•°é‡ç­‰è®¡ç®—å‚ä¸åº¦
    const questionCount = (response.content.match(/\?/g) || []).length;
    const segmentCount = response.segments.length;
    const avgLength = response.segments.reduce((sum, seg) => sum + seg.length, 0) / segmentCount;
    
    return Math.min(1, (questionCount * 0.3 + segmentCount * 0.4 + (100 - avgLength) * 0.3) / 100);
  }
}
```

### ä¼˜åŒ–å»ºè®®

1. **é•¿åº¦æ§åˆ¶**: ç¡®ä¿æç¤ºè¯ç®€æ´æ˜äº†ï¼Œé¿å…å†—é•¿
2. **ç»“æ„æ¸…æ™°**: ä½¿ç”¨æ¸…æ™°çš„åˆ†æ®µå’Œæ ‡é¢˜
3. **ç¤ºä¾‹ä¸°å¯Œ**: æä¾›å…·ä½“çš„å›å¤ç¤ºä¾‹
4. **çº¦æŸæ˜ç¡®**: æ˜ç¡®æŒ‡å‡ºåº”è¯¥é¿å…çš„è¡Œä¸º
5. **ä¸ªæ€§åŒ–**: èå…¥ç”¨æˆ·ç”»åƒå’Œä¸Šä¸‹æ–‡ä¿¡æ¯

## ğŸ“Š æç¤ºè¯æ•ˆæœç›‘æ§

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ |
|---------|----------|--------|----------|
| **å›å¤è´¨é‡** | ç”¨æˆ·æ»¡æ„åº¦ | > 85% | ç”¨æˆ·åé¦ˆ |
| **å¯¹è¯æµç•…åº¦** | å¯¹è¯ç»§ç»­ç‡ | > 70% | å¯¹è¯æ—¥å¿—åˆ†æ |
| **æƒ…æ„ŸåŒ¹é…** | æƒ…ç»ªè¯†åˆ«å‡†ç¡®ç‡ | > 80% | æƒ…æ„Ÿåˆ†æå¯¹æ¯” |
| **ä¸ªæ€§åŒ–** | ä¸ªæ€§åŒ–æ„ŸçŸ¥åº¦ | > 75% | ç”¨æˆ·è°ƒç ” |
| **æŠ€æœ¯æ€§èƒ½** | å“åº”æ—¶é—´ | < 2s | æ€§èƒ½ç›‘æ§ |

### A/B æµ‹è¯•æ¡†æ¶

```javascript
// æç¤ºè¯ A/B æµ‹è¯•
class PromptABTest {
  constructor() {
    this.testGroups = {
      A: 'current_prompt',
      B: 'optimized_prompt'
    };
    this.results = {};
  }
  
  async runTest(userGroup, promptVersion) {
    const prompt = this.testGroups[promptVersion];
    const response = await generateResponse(prompt, userGroup);
    
    // æ”¶é›†åé¦ˆæŒ‡æ ‡
    const metrics = await collectMetrics(response, userGroup);
    
    this.results[`${userGroup}_${promptVersion}`] = metrics;
  }
  
  analyzeResults() {
    // åˆ†ææµ‹è¯•ç»“æœï¼Œç¡®å®šæœ€ä½³æç¤ºè¯ç‰ˆæœ¬
    const analysis = {};
    
    for (const [group, metrics] of Object.entries(this.results)) {
      analysis[group] = {
        avgSatisfaction: metrics.satisfaction.reduce((a, b) => a + b, 0) / metrics.satisfaction.length,
        avgEngagement: metrics.engagement.reduce((a, b) => a + b, 0) / metrics.engagement.length,
        conversionRate: metrics.continuedConversations / metrics.totalConversations
      };
    }
    
    return analysis;
  }
}
```

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æ™ºèƒ½æç¤ºè¯ç”Ÿæˆ
- åŸºäºç”¨æˆ·è¡Œä¸ºè‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ–æç¤ºè¯
- ä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–æç¤ºè¯æ•ˆæœ
- åŠ¨æ€è°ƒæ•´æç¤ºè¯ç­–ç•¥

### 2. å¤šæ¨¡æ€æç¤ºè¯
- é›†æˆå›¾åƒã€è¯­éŸ³ç­‰å¤šæ¨¡æ€ä¿¡æ¯
- æ”¯æŒ richer çš„äº¤äº’ä½“éªŒ
- å¢å¼ºæƒ…æ„Ÿç†è§£å’Œè¡¨è¾¾

### 3. å®æ—¶ä¼˜åŒ–
- åŸºäºå®æ—¶åé¦ˆè°ƒæ•´æç¤ºè¯
- åŠ¨æ€é€‚åº”ç”¨æˆ·éœ€æ±‚å˜åŒ–
- æŒç»­å­¦ä¹ ç”¨æˆ·åå¥½

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-01-09  
**ç»´æŠ¤å›¢é˜Ÿ**: HeartChat å¼€å‘å›¢é˜Ÿ