# HeartChat Chat 云函数流程图

## 🏗️ 系统架构概览

```mermaid
graph TB
    subgraph "前端层 (微信小程序)"
        A[用户界面] --> B[聊天页面]
        B --> C[消息输入组件]
        C --> D[消息显示组件]
    end
    
    subgraph "云函数层 (Cloud Functions)"
        E[chat 云函数] --> F[index.js 主入口]
        F --> G[bigmodel.js AI模块]
        F --> H[roles 云函数]
        F --> I[analysis 云函数]
    end
    
    subgraph "数据库层 (Database)"
        J[chats 集合] --> K[messages 集合]
        K --> L[users 集合]
        L --> M[roles 集合]
    end
    
    subgraph "外部服务"
        N[智谱AI API] --> G
        O[微信云开发] --> E
    end
    
    A --> E
    E --> J
    E --> K
    E --> L
    E --> M
    G --> N
```

## 🔄 核心功能流程

### 1. 发送消息完整流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端小程序
    participant C as chat云函数
    participant R as roles云函数
    participant B as bigmodel模块
    participant A as 智谱AI
    participant DB as 数据库
    participant AN as analysis云函数

    U->>F: 输入消息并发送
    F->>C: sendMessage({content, roleId})
    
    C->>C: 验证参数
    C->>C: 获取OPENID
    
    C->>R: getRoleDetail(roleId)
    R-->>C: 返回角色信息
    
    C->>DB: 查询或创建聊天会话
    DB-->>C: 返回chatId
    
    C->>DB: 获取历史消息(最近10条)
    DB-->>C: 返回历史消息
    
    C->>DB: 保存用户消息
    DB-->>C: 保存成功
    
    C->>B: generateAIReply()
    B->>A: 发送API请求
    A-->>B: 返回AI回复
    B-->>C: 返回分段后的回复
    
    C->>DB: 保存分段AI消息
    DB-->>C: 保存成功
    
    C->>DB: 更新会话信息
    DB-->>C: 更新成功
    
    C->>AN: 触发情感分析
    AN-->>C: 分析完成
    
    C->>C: 更新用户统计
    C-->>F: 返回完整响应
    F-->>U: 显示分段消息
```

### 2. AI回复生成流程

```mermaid
graph TD
    A[用户消息] --> B[消息验证]
    B --> C[获取角色信息]
    C --> D[构建系统提示词]
    
    D --> E{提示词选择}
    E -->|自定义| F[用户画像增强提示词]
    E -->|角色prompt| G[角色自定义提示词]
    E -->|默认| H[默认系统提示词]
    
    F --> I[构建消息数组]
    G --> I
    H --> I
    
    I --> J[添加历史消息]
    J --> K[添加当前消息]
    K --> L[调用智谱AI API]
    
    L --> M{API调用成功?}
    M -->|是| N[解析回复内容]
    M -->|否| O[返回错误]
    
    N --> P[消息分段处理]
    P --> Q[清理Markdown语法]
    Q --> R[按段落分割]
    R --> S[保护列表结构]
    S --> T[按句子分割]
    T --> U[按标点分割]
    U --> V[长度控制]
    V --> W[合并短段落]
    W --> X[返回分段消息]
    
    O --> Y[生成错误回复]
    Y --> X
```

### 3. 消息分段处理流程

```mermaid
flowchart TD
    A[原始AI回复] --> B[清理Markdown语法]
    B --> C{包含列表或编号?}
    
    C -->|是| D[按空行分段]
    D --> E{段落过长?}
    E -->|是| F[按列表项分割]
    E -->|否| G[保持段落完整性]
    
    C -->|否| H[按段落分割]
    H --> I{段落过长?}
    I -->|是| J[按句子分割]
    I -->|否| K[直接使用]
    
    F --> L[过滤空段落]
    G --> L
    J --> L
    K --> L
    
    L --> M{句子过长?}
    M -->|是| N[按标点分割]
    M -->|否| O[保持句子]
    
    N --> P{子段落过长?}
    P -->|是| Q[按字符分割]
    P -->|否| R[合并子段落]
    
    Q --> S[生成分段数组]
    R --> S
    O --> S
    
    S --> T{段落过短?}
    T -->|是| U[合并相邻短段落]
    T -->|否| V[保持独立]
    
    U --> W[最终分段消息]
    V --> W
    
    W --> X[返回分段结果]
```

### 4. 提示词选择流程

```mermaid
graph TD
    A[生成AI回复请求] --> B{有自定义系统提示词?}
    
    B -->|是| C[使用用户画像增强提示词]
    B -->|否| D{角色有prompt字段?}
    
    D -->|是| E[使用角色自定义提示词]
    D -->|否| F{角色有system_prompt字段?}
    
    F -->|是| G[使用角色系统提示词]
    F -->|否| H[使用默认系统提示词]
    
    C --> I[构建消息数组]
    E --> I
    G --> I
    H --> I
    
    I --> J[添加历史消息]
    J --> K[调用AI模型]
    K --> L[返回AI回复]
```

### 5. 数据存储流程

```mermaid
graph LR
    subgraph "聊天会话管理"
        A[用户发送消息] --> B[查询现有会话]
        B --> C{会话存在?}
        C -->|是| D[更新现有会话]
        C -->|否| E[创建新会话]
        
        D --> F[更新会话信息]
        E --> F
        F --> G[记录会话ID]
    end
    
    subgraph "消息存储"
        H[保存用户消息] --> I[生成消息ID]
        I --> J[存储到messages集合]
        
        K[AI回复分段] --> L[遍历分段]
        L --> M[为每段生成消息]
        M --> N[设置分段标记]
        N --> O[存储分段消息]
        O --> P[更新消息关联]
    end
    
    subgraph "用户统计更新"
        Q[新会话?] --> R{是新会话?}
        R -->|是| S[更新用户对话次数]
        R -->|否| T[跳过统计更新]
        
        S --> U[更新角色使用统计]
        T --> V[流程完成]
        U --> V
    end
    
    G --> H
    P --> Q
    J --> K
```

### 6. 历史消息获取流程

```mermaid
sequenceDiagram
    participant F as 前端
    participant C as chat云函数
    participant DB as 数据库
    
    F->>C: getChatHistory({userId, roleId})
    
    C->>C: 构建查询条件
    C->>DB: 查询chats集合
    DB-->>C: 返回聊天记录
    
    C->>C{聊天记录有消息?}
    C-->>C: 无，跳转消息查询
    C->>DB: 查询messages集合
    DB-->>C: 返回消息列表
    
    C->>C: 按时间排序消息
    C->>C: 整理消息格式
    C-->>F: 返回完整聊天历史
```

### 7. 错误处理流程

```mermaid
graph TD
    A[API请求] --> B{请求成功?}
    B -->|是| C{数据有效?}
    B -->|否| D[记录错误日志]
    
    C -->|是| E[正常处理]
    C -->|否| D
    
    D --> F{错误类型?}
    F -->|参数错误| G[返回400错误]
    F -->|认证错误| H[返回401错误]
    F -->|权限错误| I[返回403错误]
    F -->|服务错误| J[返回500错误]
    
    G --> K[记录错误详情]
    H --> K
    I --> K
    J --> K
    
    K --> L[生成用户友好错误信息]
    L --> M[返回错误响应]
    
    E --> N[正常处理流程]
    N --> O[返回成功响应]
```

### 8. 情感分析触发流程

```mermaid
graph LR
    A[消息发送完成] --> B{需要情感分析?}
    B -->|否| C[跳过分析]
    B -->|是| D[调用analysis云函数]
    
    D --> E{analysis可用?}
    E -->|是| F[发送分析请求]
    E -->|否| G[记录不可用日志]
    
    F --> H{分析成功?}
    H -->|是| I[保存分析结果]
    H -->|否| J[记录失败日志]
    
    I --> K[更新用户情感档案]
    J --> L[继续后续流程]
    
    G --> L
    C --> L
    K --> L
```

## 📊 性能优化流程

### 缓存策略流程

```mermaid
graph TD
    A[数据请求] --> B{检查缓存?}
    B -->|缓存命中| C[返回缓存数据]
    B -->|缓存未命中| D[查询数据库]
    
    D --> E{查询成功?}
    E -->|是| F[更新缓存]
    E -->|否| G[返回错误]
    
    F --> H[返回数据]
    G --> I[记录错误]
    
    C --> J[记录缓存命中]
    H --> K[更新缓存统计]
    I --> L[流程结束]
    J --> L
    K --> L
```

### 并发控制流程

```mermaid
graph TD
    A[并发请求到达] --> B[请求队列]
    B --> C{队列长度限制?}
    C -->|未超限| D[处理请求]
    C -->|超限| E[返回限流错误]
    
    D --> F{资源可用?}
    F -->|可用| G[正常处理]
    F -->|不可用| H[等待资源]
    
    H --> I{等待超时?}
    I -->|否| G
    I -->|是| E
    
    G --> J[释放资源]
    J --> K[更新队列]
    
    E --> L[记录限流日志]
    L --> M[返回错误响应]
    
    K --> N[处理下一个请求]
    M --> O[流程结束]
```

## 🔄 系统状态流转

### 聊天会话状态机

```mermaid
stateDiagram-v2
    [*] --> 创建中: 用户发起聊天
    创建中 --> 活跃中: 会话创建成功
    活跃中 --> 消息发送中: 用户发送消息
    消息发送中 --> AI回复生成中: 调用AI服务
    AI回复生成中 --> 消息分段处理中: 收到AI回复
    消息分段处理中 --> 活跃中: 分段消息保存完成
    活跃中 --> 暂停中: 用户离开
    暂停中 --> 活跃中: 用户返回
    活跃中 --> 已结束: 用户主动结束
    暂停中 --> 已结束: 超时自动结束
    已结束 --> [*]: 清理资源
```

### 消息处理状态机

```mermaid
stateDiagram-v2
    [*] --> 待发送: 消息创建
    待发送 --> 发送中: 开始发送流程
    发送中 --> AI处理中: 调用AI服务
    AI处理中 --> 分段处理中: AI回复完成
    分段处理中 --> 保存中: 开始保存分段
    保存中 --> 已发送: 保存完成
    保存中 --> 发送失败: 保存错误
    发送失败 --> 重试中: 自动重试
    重试中 --> 保存中: 重试发送
    重试中 --> 已失败: 重试超限
    已发送 --> [*]: 流程完成
    已失败 --> [*]: 错误处理
```

---

**文档版本**: v1.0  
**最后更新**: 2024-01-09  
**维护团队**: HeartChat 开发团队