# HeartChat项目流程图（重构版）

本文档使用Mermaid语法绘制HeartChat项目的主要流程图，包括用户交互流程、心情树洞功能流程、情感分析流程、每日心情报告流程以及数据处理流程。

## 1. 用户交互总体流程

```mermaid
flowchart TD
    A[开始] --> B[用户登录/注册]
    B --> C{选择功能}
    C -->|选择心情树洞| D[心情树洞聊天界面]
    C -->|选择用户中心| E[用户中心]
    C -->|选择情感测试| F[情感测试]
    
    D --> G[选择角色开始对话]
    E --> H[查看/编辑个人资料]
    E --> I[角色管理]
    F --> J[查看情感分析结果]
    
    G --> K[结束]
    H --> K
    I --> K
    J --> K
```

## 2. 心情树洞功能流程

```mermaid
flowchart TD
    A[进入心情树洞] --> B[选择/切换角色]
    B --> C[查看历史对话]
    C --> D[开始新对话]
    
    D --> E[用户发送消息]
    E --> F[后台情感分析]
    F --> G[保存消息到数据库]
    G --> H[AI生成回复]
    H --> I[显示回复消息]
    I --> J{继续对话?}
    
    J -->|是| E
    J -->|否| K[结束对话]
    K --> L[保存对话状态]
    L --> M[更新用户统计]
    M --> N[退出或切换角色]
```

## 3. 情感分析流程

```mermaid
flowchart TD
    A[用户输入文本消息] --> B[文本预处理]
    B --> C[调用analysis云函数]
    C --> D[调用百度AI情感分析API]
    
    D --> E[情感分类处理]
    E --> F[情感类型识别7种情绪]
    E --> G[情感强度计算]
    E --> H[关键词提取]
    
    F --> I[生成情感报告]
    G --> I
    H --> I
    
    I --> J[返回分析结果]
    J --> K{是否保存记录?}
    
    K -->|是| L[保存到emotionRecords集合]
    K -->|否| M[仅返回结果]
    
    L --> N[更新用户情感统计]
    L --> O[前端展示情感分析]
    M --> O
    
    O --> P[情感饼图展示]
    O --> Q[情感强度展示]
    O --> R[关键词展示]
```

## 4. 每日心情报告流程

```mermaid
flowchart TD
    A[触发报告生成] --> B{触发方式}
    B -->|定时触发| C[系统定时任务]
    B -->|用户请求| D[用户手动请求]
    
    C --> E[获取活跃用户列表]
    D --> F[获取指定用户数据]
    
    E --> G[循环处理用户]
    F --> H[处理单个用户]
    
    G --> H
    H --> I[收集用户当日数据]
    I --> J[获取用户消息记录]
    I --> K[获取情感分析记录]
    
    J --> L[提取关键词]
    K --> M[计算情绪总结]
    
    L --> N[关键词权重计算]
    N --> O[合并同义词]
    O --> P[获取词向量]
    P --> Q[兴趣聚类]
    
    M --> R[生成情绪波动指数]
    M --> S[计算主要情绪]
    
    Q --> T[生成图表数据]
    R --> T
    S --> T
    
    T --> U[调用LLM生成文本描述]
    U --> V[创建完整报告]
    V --> W[存储报告]
    W --> X[更新用户兴趣数据]
    X --> Y[发送通知]
    Y --> Z[结束]
```

## 5. 数据处理流程

```mermaid
flowchart TD
    A[用户交互产生数据] --> B{数据类型}
    
    B -->|聊天消息| C[聊天数据]
    B -->|用户信息| D[用户数据]
    B -->|情感记录| E[情感分析数据]
    
    C --> F[保存到chats和messages集合]
    D --> G[保存到users和user_stats集合]
    E --> H[保存到emotionRecords集合]
    
    F --> I[数据统计与分析]
    G --> I
    H --> I
    
    I --> J[生成用户画像]
    I --> K[更新角色使用统计]
    I --> L[更新情感趋势]
    
    J --> M[个性化推荐]
    K --> N[角色匹配建议]
    L --> O[情感健康建议]
    
    M --> P[结束]
    N --> P
    O --> P
```

## 6. 关键词提取与兴趣聚类流程

```mermaid
flowchart TD
    A[用户对话内容] --> B[文本预处理分词、去停用词]
    B --> C[关键词提取百度AI API]
    
    C --> D[关键词权重计算]
    D --> E[自定义算法:词频-逆文档频率TF-IDF]
    E --> F[情感关联因子]
    F --> G[时间衰减因子]
    G --> H[上下文重要性因子]
    H --> I[领域相关性因子]
    
    I --> J[获取词向量]
    J --> K[计算相似度矩阵]
    K --> L[基于相似度聚类]
    
    L --> M[为兴趣簇生成领域标签]
    M --> N[结合用户历史兴趣微调]
    N --> O[生成用户兴趣画像]
    
    O --> P[结束]
```

## 7. 云函数调用流程

```mermaid
sequenceDiagram
    participant 小程序前端
    participant 云函数
    participant 云数据库
    participant 外部API
    
    小程序前端->>云函数: 调用login云函数
    云函数->>云数据库: 查询/创建用户
    云数据库-->>云函数: 返回用户数据
    云函数-->>小程序前端: 返回登录结果
    
    小程序前端->>云函数: 调用chat云函数
    云函数->>云数据库: 保存/获取聊天记录
    云数据库-->>云函数: 返回聊天数据
    云函数-->>小程序前端: 返回聊天结果
    
    小程序前端->>云函数: 调用analysis云函数
    云函数->>外部API: 请求百度AI情感分析
    外部API-->>云函数: 返回分析结果
    云函数->>云数据库: 保存分析结果
    云函数-->>小程序前端: 返回分析数据
    
    小程序前端->>云函数: 调用user云函数
    云函数->>云数据库: 更新用户信息
    云数据库-->>云函数: 返回更新结果
    云函数-->>小程序前端: 返回用户数据
```

## 8. 数据库关系图

```mermaid
erDiagram
    USERS ||--o{ USER_STATS : has
    USERS ||--o{ CHATS : creates
    USERS ||--o{ USER_REPORTS : receives
    ROLES ||--o{ CHATS : used_in
    CHATS ||--o{ MESSAGES : contains
    MESSAGES ||--o{ EMOTION_RECORDS : analyzed_as
    ROLES ||--o{ ROLE_USAGE : tracked_by
    USERS ||--o{ ROLE_USAGE : generates
    EMOTION_RECORDS }|--o{ USER_REPORTS : contributes_to
    
    USERS {
        string _id
        int user_id
        string openid
        string username
        string avatar_url
        int user_type
        int status
        date created_at
        date updated_at
    }
    
    USER_STATS {
        string _id
        int stats_id
        int user_id
        string openid
        int chat_count
        int solved_count
        float rating_avg
        int active_days
        date last_active
        date created_at
        date updated_at
    }
    
    ROLES {
        string _id
        string name
        string avatar
        string description
        string category
        string prompt
        int status
        date created_at
        date updated_at
    }
    
    CHATS {
        string _id
        string openId
        int userId
        string roleId
        string title
        int messageCount
        date createTime
        date updateTime
    }
    
    MESSAGES {
        string _id
        string chatId
        string content
        string role
        date createTime
        int messageType
    }
    
    EMOTION_RECORDS {
        string _id
        string messageId
        string chatId
        string userId
        string roleId
        string text
        string emotion_type
        float emotion_score
        array keywords
        date created_at
    }
    
    ROLE_USAGE {
        string _id
        string roleId
        int userId
        int message_count
        int chat_count
        date last_used
        date created_at
        date updated_at
    }
    
    USER_REPORTS {
        string _id
        string userId
        date date
        object emotionSummary
        array keywords
        array interests
        object fortune
        object chartData
        date generatedAt
        boolean isRead
        date readAt
    }
```
