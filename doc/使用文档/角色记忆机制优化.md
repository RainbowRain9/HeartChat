# 角色记忆机制优化

## 一、功能概述

角色记忆机制是HeartChat微信小程序中的一项重要功能，它使AI角色能够记住与用户的对话内容，从而提供更加连贯、个性化的对话体验。本次优化主要针对记忆提取的触发机制进行了改进，实现了三种自动触发记忆提取的方式，使记忆提取更加及时、高效。

## 二、优化内容

### 1. 自动记忆提取触发机制

#### 1.1 对话结束时提取记忆

当用户离开聊天页面时（即页面的`onUnload`生命周期函数被触发时），系统会自动触发记忆提取。这确保了每次对话结束后，重要的信息都能被保存为角色记忆。

```javascript
/**
 * 生命周期函数--监听页面卸载
 */
onUnload() {
  // 保存聊天记录到云端
  this.saveChatHistory();
  
  // 提取对话记忆
  this.extractChatMemories();

  // 保存聊天记录到本地缓存
  if (this.data.chatId && this.data.messages.length > 0) {
    chatCacheService.saveMessagesToCache(
      this.data.chatId,
      this.data.messages,
      true,
      null,
      this.data.role
    );
  }

  // 移除键盘监听
  this.unwatchKeyboard();
  
  // 清除定时提取记忆的定时器
  if (this.memoryExtractionTimer) {
    clearInterval(this.memoryExtractionTimer);
    this.memoryExtractionTimer = null;
  }
}
```

#### 1.2 对话达到一定长度时提取记忆

当对话消息数量达到特定阈值（每10条消息）时，系统会在AI消息显示完毕后自动触发记忆提取。这确保了在长时间对话中，重要信息能够及时被保存为记忆。

```javascript
// 在showNextAiMessage函数中，当所有消息显示完毕后
// 所有消息已显示完毕
this.setData({
  sending: false,
  pendingAiMessages: null,
  currentAiMessageIndex: 0
});

// 所有消息显示完毕后，再次强制滚动到底部
wx.nextTick(() => {
  this.scrollToBottom(100, true);
});

// 检查消息数量，当达到一定阈值时提取记忆
// 每10条消息提取一次记忆
if (this.data.messages.length % 10 === 0) {
  if (isDev) {
    console.log('消息数量达到阈值，触发记忆提取');
  }
  this.extractChatMemories();
}
```

#### 1.3 定期触发记忆提取

系统会每隔一定时间（5分钟）自动触发一次记忆提取，确保即使在长时间对话中也能定期保存重要信息。这是通过在页面加载时启动一个定时器实现的。

```javascript
/**
 * 启动定期记忆提取定时器
 * 每5分钟触发一次记忆提取
 */
startMemoryExtractionTimer() {
  // 清除可能存在的旧定时器
  if (this.memoryExtractionTimer) {
    clearInterval(this.memoryExtractionTimer);
  }
  
  // 设置定时器，每5分钟（300000毫秒）触发一次
  const MEMORY_EXTRACTION_INTERVAL = 5 * 60 * 1000; // 5分钟
  
  this.memoryExtractionTimer = setInterval(() => {
    if (isDev) {
      console.log('定时触发记忆提取');
    }
    
    // 只有当消息数量足够且不在发送状态时才提取记忆
    if (this.data.messages.length >= 5 && !this.data.sending) {
      this.extractChatMemories();
    }
  }, MEMORY_EXTRACTION_INTERVAL);
}
```

### 2. 记忆提取功能增强

#### 2.1 通用记忆提取函数

新增了一个通用的记忆提取函数，支持静默提取和显示提示，增强了系统的灵活性和可用性。

```javascript
/**
 * 提取对话记忆
 * @param {boolean} silent 是否静默提取（不显示提示）
 * @returns {Promise<boolean>} 提取是否成功
 */
async extractChatMemories(silent = true) {
  // 如果消息数量太少，不提取记忆
  if (!this.data.roleId || !this.data.messages || this.data.messages.length < 5) {
    if (isDev) {
      console.log('消息数量不足，不提取记忆');
    }
    return false;
  }
  
  try {
    if (isDev) {
      console.log('开始提取对话记忆...');
    }
    
    // 调用云函数提取记忆
    const result = await wx.cloud.callFunction({
      name: 'roles',
      data: {
        action: 'extractMemories',
        roleId: this.data.roleId,
        messages: this.data.messages
      }
    });

    if (result && result.result && result.result.success) {
      if (isDev) {
        console.log('成功提取记忆:', result.result.memories.length, '条');
      }
      
      if (!silent) {
        wx.showToast({
          title: '记忆提取成功',
          icon: 'success'
        });
      }
      
      return true;
    } else {
      console.error('提取记忆失败:', result);
      return false;
    }
  } catch (error) {
    console.error('调用提取记忆云函数失败:', error);
    return false;
  }
}
```

#### 2.2 定时器管理

在页面卸载时清除定时提取记忆的定时器，避免内存泄漏和不必要的API调用。

```javascript
// 在onUnload生命周期函数中
// 清除定时提取记忆的定时器
if (this.memoryExtractionTimer) {
  clearInterval(this.memoryExtractionTimer);
  this.memoryExtractionTimer = null;
}
```

## 三、使用方法

### 1. 自动触发

三种自动触发机制已经集成到聊天页面中，无需用户手动操作，系统会在适当的时机自动触发记忆提取：

- 对话结束时（离开聊天页面时）
- 对话达到一定长度时（每10条消息）
- 定期触发（每5分钟）

### 2. 手动触发（开发者使用）

如果需要手动触发记忆提取，可以在代码中调用`extractChatMemories`函数：

```javascript
// 静默提取记忆（不显示提示）
this.extractChatMemories();

// 提取记忆并显示提示
this.extractChatMemories(false);
```

## 四、技术实现

### 1. 记忆提取流程

1. 检查消息数量是否足够（至少5条）
2. 调用`roles`云函数的`extractMemories`操作
3. 云函数分析对话内容，提取重要信息作为记忆
4. 将提取的记忆保存到数据库
5. 返回提取结果

### 2. 记忆使用流程

1. 在生成角色提示词时，系统会检查是否有当前上下文
2. 如果有，则获取与当前上下文相关的记忆
3. 将相关记忆融入到提示词中
4. 使用包含记忆的提示词生成更加个性化的AI回复

## 五、注意事项

1. 记忆提取需要消息数量至少为5条，否则不会触发
2. 在发送状态时不会触发定期记忆提取，避免影响用户体验
3. 记忆提取是异步操作，不会阻塞UI线程
4. 记忆提取的结果会保存到数据库，下次对话时可以使用

## 六、未来优化方向

1. 实现记忆优先级排序，确保最重要的记忆被优先使用
2. 添加记忆过期机制，自动清理过时的记忆
3. 实现记忆冲突解决机制，处理矛盾的记忆
4. 提供记忆管理界面，允许用户查看和编辑角色记忆
5. 实现记忆分类，将记忆按主题或重要性分类
