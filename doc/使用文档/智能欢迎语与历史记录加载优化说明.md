# 智能欢迎语与历史记录加载优化说明

## 功能概述

HeartChat微信小程序实现了智能欢迎语和历史记录加载优化功能，具有以下特点：

1. **智能欢迎语系统**：根据角色关系类型生成个性化欢迎语，增强角色扮演的真实感
2. **历史记录智能加载**：智能判断是否有历史聊天记录，有则加载历史记录，无则显示欢迎语
3. **无缝体验**：用户在角色页面点击"开始对话"时，系统会自动判断是继续之前的对话还是开始新的对话
4. **角色个性化**：不同类型的角色（朋友、家人、同事、导师等）有不同风格的欢迎语

## 技术实现

### 1. 智能欢迎语系统

欢迎语系统根据角色的关系类型生成不同风格的欢迎语，增强角色扮演的真实感和沉浸感。

```javascript
// 根据角色关系类型生成不同的欢迎语
switch(relationshipType.toLowerCase()) {
  case 'friend':
  case '朋友':
    welcomeContent = `嘉嘉，好久不见了！最近怎么样？有什么想聊的吗？`;
    break;
  case 'family':
  case '家人':
    welcomeContent = `亲爱的，最近身体还好吗？有什么想和我分享的吗？`;
    break;
  case 'colleague':
  case '同事':
    welcomeContent = `嘉嘉，工作还顺利吗？有什么我能帮到你的吗？`;
    break;
  // 更多关系类型...
}
```

### 2. 历史记录智能加载

系统会在用户点击"开始对话"时，先检查是否有与该角色的历史聊天记录：

1. 调用`checkChatExists`云函数检查是否存在历史聊天
2. 如果存在，优先从本地缓存加载最新消息，然后在后台静默更新
3. 如果不存在，创建新的聊天并显示欢迎语

```javascript
// 检查是否有与该角色的历史聊天记录
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'checkChatExists',
    roleId: options.roleId
  }
}).then(result => {
  if (result && result.result && result.result.exists) {
    // 存在历史聊天，加载历史记录
    // ...
  } else {
    // 不存在历史聊天，创建新的聊天并显示欢迎语
    // ...
  }
});
```

### 3. 欢迎消息显示逻辑

欢迎消息只在以下情况显示：
- 首次与角色对话
- 没有历史聊天记录
- 强制显示欢迎语（特殊情况）

```javascript
/**
 * 添加欢迎消息
 * @param {boolean} force 是否强制显示欢迎消息，即使有历史消息
 */
addWelcomeMessage(force = false) {
  // 如果有历史消息且不是强制显示，则不显示欢迎消息
  if (this.data.messages.length > 0 && !force) {
    return;
  }
  
  // 生成并显示欢迎消息
  // ...
}
```

### 4. 云函数实现

`checkChatExists`云函数用于检查是否存在与指定角色的历史聊天记录：

```javascript
async function checkChatExists(event, context) {
  const { OPENID } = cloud.getWXContext();
  const { roleId } = event;
  
  // 查询是否存在与该角色的聊天会话
  const chatResult = await db.collection('chats')
    .where({
      roleId: roleId,
      openId: OPENID
    })
    .orderBy('updateTime', 'desc')
    .limit(1)
    .get();
    
  if (chatResult.data && chatResult.data.length > 0) {
    // 存在聊天会话
    return {
      success: true,
      exists: true,
      chatId: chatResult.data[0]._id
    };
  } else {
    // 不存在聊天会话
    return {
      success: true,
      exists: false
    };
  }
}
```

## 用户交互流程

### 首次与角色对话

1. 用户在角色选择页面点击"开始对话"
2. 系统检查是否有历史聊天记录
3. 没有历史记录，创建新的聊天
4. 显示根据角色关系类型生成的个性化欢迎语
5. 用户可以开始对话

### 再次与角色对话

1. 用户在角色选择页面点击"开始对话"
2. 系统检查是否有历史聊天记录
3. 发现有历史记录，加载历史聊天记录
4. 不显示欢迎语，直接展示历史对话内容
5. 用户可以继续之前的对话

## 优势与效果

1. **增强角色扮演真实感**：根据角色关系类型生成个性化欢迎语，使角色更加生动
2. **提升用户体验**：智能判断是继续之前的对话还是开始新的对话，避免重复显示欢迎语
3. **保持对话连续性**：加载历史聊天记录，保持对话的连续性和上下文
4. **丰富角色和用户的人格**：通过持续的对话历史，更好地丰富角色和用户之间的关系

## 注意事项

1. **云函数部署**：需要部署`chat`云函数，确保`checkChatExists`接口可用
2. **本地缓存**：配合本地缓存功能，可以更快地加载历史聊天记录
3. **欢迎语定制**：可以在角色编辑页面自定义欢迎语，覆盖系统根据关系类型生成的默认欢迎语

## 相关文件

- `miniprogram/packageChat/pages/chat/chat.js`：聊天页面逻辑
- `cloudfunctions/chat/index.js`：聊天云函数，包含`checkChatExists`接口
- `miniprogram/services/chatCacheService.js`：聊天缓存服务

## 开发者

- 开发时间：2025年4月
- 版本：v1.0
