# HeartChat 聊天功能使用指南

本文档提供 HeartChat 聊天功能的使用说明，包括云函数调用方法、参数说明和返回值说明。

## 一、功能概述

HeartChat 的聊天功能基于微信云开发和智谱AI (GLM-4-Flash) 实现，提供以下核心功能：

1. 发送消息并获取AI回复
2. 获取聊天历史记录
3. 保存聊天记录
4. 删除消息
5. 清空聊天记录
6. 集成情绪分析

## 二、云函数调用

### 1. 发送消息 (sendMessage)

**功能**：发送用户消息并获取AI回复

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'sendMessage',
    chatId: chatId, // 可选，新会话不需要
    roleId: roleId, // 必填，角色ID
    content: content // 必填，用户消息内容
  }
}).then(res => {
  console.log('发送消息结果:', res.result);
  if (res.result.success) {
    // 处理成功响应
    const { chatId, message, aiMessage, emotionAnalysis } = res.result;
    // 更新UI等操作
  } else {
    // 处理错误
    wx.showToast({
      title: res.result.error || '发送失败',
      icon: 'none'
    });
  }
}).catch(err => {
  console.error('调用失败:', err);
  wx.showToast({
    title: '网络错误，请重试',
    icon: 'none'
  });
});
```

**参数说明**：
- `action`: 固定为 'sendMessage'
- `chatId`: 聊天会话ID（可选，新会话不需要）
- `roleId`: 角色ID（必填）
- `content`: 用户消息内容（必填）

**返回值**：
```javascript
{
  success: true,
  chatId: "聊天会话ID",
  isNewChat: false, // 是否新创建的会话
  message: {
    // 用户消息对象
    _id: "消息ID",
    chatId: "聊天会话ID",
    roleId: "角色ID",
    content: "用户消息内容",
    sender_type: "user",
    createTime: "2023-04-12T12:34:56.789Z",
    status: "sent"
  },
  aiMessage: {
    // AI回复消息对象
    _id: "消息ID",
    chatId: "聊天会话ID",
    roleId: "角色ID",
    content: "AI回复内容",
    sender_type: "ai",
    createTime: "2023-04-12T12:34:57.123Z",
    status: "sent"
  },
  emotionAnalysis: {
    // 情绪分析结果（可能为null）
    user_id: "用户ID",
    message_id: "消息ID",
    chat_id: "聊天会话ID",
    role_id: "角色ID",
    emotion_type: "情绪类型",
    emotion_intensity: 0.8, // 情绪强度
    valence: 0.5, // 情绪极性
    arousal: 0.7, // 情绪唤醒度
    keywords: ["关键词1", "关键词2"],
    suggestions: ["建议1", "建议2"],
    timestamp: "2023-04-12T12:34:56.789Z",
    analysis_result: {
      // 完整的情绪分析结果
      primary_emotion: "情绪类型",
      secondary_emotions: ["次要情绪1", "次要情绪2"],
      intensity: 0.8,
      valence: 0.5,
      arousal: 0.7,
      trend: "rising",
      attention_level: "high",
      radar_dimensions: {
        trust: 0.8,
        openness: 0.7,
        resistance: 0.3,
        stress: 0.4,
        control: 0.6
      },
      topic_keywords: ["关键词1", "关键词2"],
      emotion_triggers: ["触发词1", "触发词2"],
      suggestions: ["建议1", "建议2"],
      summary: "情绪总结"
    }
  }
}
```

### 2. 获取聊天历史记录 (getChatHistory)

**功能**：获取聊天历史记录

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'getChatHistory',
    roleId: roleId, // 必填，角色ID
    skip: 0, // 可选，跳过的消息数量，默认0
    limit: 20 // 可选，返回的消息数量，默认20
  }
}).then(res => {
  console.log('获取聊天历史结果:', res.result);
  if (res.result.success) {
    // 处理成功响应
    const { chatId, messages, hasMore } = res.result;
    // 更新UI等操作
  } else {
    // 处理错误
    wx.showToast({
      title: res.result.error || '获取失败',
      icon: 'none'
    });
  }
}).catch(err => {
  console.error('调用失败:', err);
});
```

**参数说明**：
- `action`: 固定为 'getChatHistory'
- `roleId`: 角色ID（必填）
- `skip`: 跳过的消息数量（可选，默认0）
- `limit`: 返回的消息数量（可选，默认20）

**返回值**：
```javascript
{
  success: true,
  chatId: "聊天会话ID",
  messages: [
    {
      _id: "消息ID",
      chatId: "聊天会话ID",
      roleId: "角色ID",
      content: "消息内容",
      sender_type: "user", // 或 "ai"
      createTime: "2023-04-12T12:34:56.789Z",
      status: "sent"
    },
    // 更多消息...
  ],
  hasMore: false // 是否还有更多消息
}
```

### 3. 保存聊天记录 (saveChatHistory)

**功能**：保存聊天记录

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'saveChatHistory',
    chatId: chatId // 必填，聊天会话ID
  }
}).then(res => {
  console.log('保存聊天记录结果:', res.result);
  if (res.result.success) {
    // 处理成功响应
  } else {
    // 处理错误
    console.error('保存失败:', res.result.error);
  }
}).catch(err => {
  console.error('调用失败:', err);
});
```

**参数说明**：
- `action`: 固定为 'saveChatHistory'
- `chatId`: 聊天会话ID（必填）

**返回值**：
```javascript
{
  success: true
}
```

### 4. 删除消息 (deleteMessage)

**功能**：删除指定消息

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'deleteMessage',
    messageId: messageId // 必填，消息ID
  }
}).then(res => {
  console.log('删除消息结果:', res.result);
  if (res.result.success) {
    // 处理成功响应
    wx.showToast({
      title: '删除成功',
      icon: 'success'
    });
  } else {
    // 处理错误
    wx.showToast({
      title: res.result.error || '删除失败',
      icon: 'none'
    });
  }
}).catch(err => {
  console.error('调用失败:', err);
});
```

**参数说明**：
- `action`: 固定为 'deleteMessage'
- `messageId`: 消息ID（必填）

**返回值**：
```javascript
{
  success: true
}
```

### 5. 清空聊天记录 (clearChatHistory)

**功能**：清空指定会话的所有聊天记录

**调用方式**：
```javascript
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'clearChatHistory',
    chatId: chatId // 必填，聊天会话ID
  }
}).then(res => {
  console.log('清空聊天记录结果:', res.result);
  if (res.result.success) {
    // 处理成功响应
    wx.showToast({
      title: '清空成功',
      icon: 'success'
    });
  } else {
    // 处理错误
    wx.showToast({
      title: res.result.error || '清空失败',
      icon: 'none'
    });
  }
}).catch(err => {
  console.error('调用失败:', err);
});
```

**参数说明**：
- `action`: 固定为 'clearChatHistory'
- `chatId`: 聊天会话ID（必填）

**返回值**：
```javascript
{
  success: true,
  deletedCount: 10 // 删除的消息数量
}
```

## 三、数据库集合说明

### 1. chats 集合

存储聊天会话的元数据。

**字段说明**：
- `_id`: 会话ID
- `roleId`: 角色ID
- `roleName`: 角色名称
- `openId`: 用户OpenID
- `messageCount`: 消息数量
- `lastMessage`: 最后一条消息内容
- `createTime`: 创建时间
- `updateTime`: 更新时间

### 2. messages 集合

存储聊天消息详情。

**字段说明**：
- `_id`: 消息ID
- `chatId`: 会话ID
- `roleId`: 角色ID
- `openId`: 用户OpenID
- `content`: 消息内容
- `sender_type`: 发送者类型（'user' 或 'ai'）
- `createTime`: 创建时间
- `status`: 消息状态（'sent', 'delivered', 'read', 'failed'）

### 3. emotion_records 集合

存储情绪分析结果。

**字段说明**：
- `_id`: 记录ID
- `user_id`: 用户ID
- `message_id`: 消息ID
- `chat_id`: 会话ID
- `role_id`: 角色ID
- `emotion_type`: 情绪类型
- `emotion_intensity`: 情绪强度
- `valence`: 情绪极性
- `arousal`: 情绪唤醒度
- `keywords`: 关键词数组
- `suggestions`: 建议数组
- `timestamp`: 时间戳
- `analysis_result`: 完整的情绪分析结果

## 四、使用示例

### 1. 发送消息并处理回复

```javascript
// 在聊天页面中
Page({
  data: {
    roleId: '',
    chatId: '',
    messages: [],
    sending: false
  },
  
  // 发送消息
  async handleSendMessage(e) {
    const { content } = e.detail;
    if (!content.trim()) return;
    
    this.setData({ sending: true });
    
    try {
      const result = await wx.cloud.callFunction({
        name: 'chat',
        data: {
          action: 'sendMessage',
          chatId: this.data.chatId,
          roleId: this.data.roleId,
          content
        }
      });
      
      if (result.result.success) {
        // 更新聊天ID
        this.setData({
          chatId: result.result.chatId,
          sending: false
        });
        
        // 更新消息列表
        const updatedMessages = [...this.data.messages];
        updatedMessages.push(result.result.message);
        updatedMessages.push(result.result.aiMessage);
        
        this.setData({
          messages: updatedMessages
        });
        
        // 如果有情绪分析结果，可以显示情绪标签
        if (result.result.emotionAnalysis) {
          this.showEmotionTag(result.result.emotionAnalysis);
        }
        
        // 滚动到底部
        this.scrollToBottom();
      } else {
        throw new Error(result.result.error || '发送失败');
      }
    } catch (error) {
      console.error('发送消息失败:', error);
      wx.showToast({
        title: '发送失败，请重试',
        icon: 'none'
      });
      this.setData({ sending: false });
    }
  },
  
  // 显示情绪标签
  showEmotionTag(emotionAnalysis) {
    wx.showToast({
      title: `检测到情绪: ${emotionAnalysis.emotion_type}`,
      icon: 'none',
      duration: 2000
    });
  },
  
  // 滚动到底部
  scrollToBottom() {
    // 实现滚动到底部的逻辑
  }
});
```

### 2. 加载聊天历史

```javascript
// 在聊天页面中
Page({
  data: {
    roleId: '',
    chatId: '',
    messages: [],
    loading: true,
    loadingHistory: false,
    hasMoreHistory: true
  },
  
  // 加载聊天历史
  async loadChatHistory() {
    try {
      this.setData({ loadingHistory: true });
      
      const result = await wx.cloud.callFunction({
        name: 'chat',
        data: {
          action: 'getChatHistory',
          roleId: this.data.roleId,
          skip: this.data.messages.length,
          limit: 20
        }
      });
      
      if (result.result.success) {
        const { chatId, messages, hasMore } = result.result;
        
        // 如果有历史消息，添加到消息列表前面
        if (messages && messages.length > 0) {
          this.setData({
            chatId,
            messages: [...messages.reverse(), ...this.data.messages],
            hasMoreHistory: hasMore
          });
        } else if (chatId) {
          // 如果没有历史消息但有聊天ID，说明是新的聊天
          this.setData({
            chatId,
            hasMoreHistory: false
          });
        }
      } else {
        throw new Error('获取聊天历史失败');
      }
    } catch (error) {
      console.error('加载聊天历史失败:', error);
      wx.showToast({
        title: '加载历史失败',
        icon: 'none'
      });
    } finally {
      this.setData({
        loading: false,
        loadingHistory: false
      });
      
      // 如果没有历史消息，显示欢迎消息
      if (this.data.messages.length === 0 && this.data.role) {
        this.addWelcomeMessage();
      }
      
      // 滚动到底部
      this.scrollToBottom();
    }
  }
});
```

## 五、注意事项

1. **API密钥安全**：
   - 智谱AI的API密钥存储在云函数环境变量中，不要在前端代码中硬编码。

2. **错误处理**：
   - 调用云函数时应添加适当的错误处理，提供友好的用户提示。

3. **性能优化**：
   - 聊天历史采用分页加载，避免一次性加载过多数据。
   - 发送消息时显示加载状态，提升用户体验。

4. **数据安全**：
   - 确保用户只能访问自己的聊天记录。
   - 敏感信息不要存储在前端。

5. **智谱AI限制**：
   - 注意智谱AI的API调用频率限制和token限制。
   - 历史消息传递给智谱AI时限制数量，避免超出token限制。
