# 聊天界面键盘优化文档

## 一、功能概述

在移动设备上使用聊天界面时，当用户点击输入框后键盘弹出，可能会导致以下问题：
1. 导航栏消失或被推出可视区域
2. 聊天内容区域显示不全，影响用户体验
3. 最新消息被键盘遮挡，用户无法看到对话上下文

本次优化针对这些问题进行了全面解决，确保在键盘弹出时，聊天界面的各个元素都能正常显示，提升用户体验。

## 二、实现方案

### 2.1 键盘高度监听

通过微信小程序提供的`wx.onKeyboardHeightChange`API监听键盘高度变化，实时调整页面布局：

```javascript
// 监听键盘高度变化
watchKeyboard() {
  this.keyboardHeightChangeListener = wx.onKeyboardHeightChange(res => {
    const isKeyboardShow = res.height > 0;
    console.log('键盘高度变化:', res.height, '是否显示:', isKeyboardShow);
    
    this.setData({
      keyboardHeight: res.height,
      isKeyboardShow: isKeyboardShow
    });
    
    // 当键盘弹出时，滚动到底部
    if (isKeyboardShow) {
      this.scrollToBottom(50);
    }
  });
}
```

### 2.2 动态调整聊天容器高度

根据键盘的显示状态和高度，动态调整聊天容器的高度，确保内容区域不被压缩：

```html
<scroll-view class="chat-container"
             style="margin-top: {{statusBarHeight + navBarHeight + 10}}px; height: calc(100vh - {{statusBarHeight + navBarHeight + 10}}px - {{isKeyboardShow ? keyboardHeight : 180}}rpx);"
             scroll-y
             enable-back-to-top
             scroll-with-animation
             scroll-anchoring="true"
             enhanced="true"
             show-scrollbar="false"
             id="chat-container">
  <!-- 聊天内容 -->
</scroll-view>
```

### 2.3 优化输入框组件

修改输入框组件，禁用系统默认的键盘位置调整，添加焦点事件处理：

```html
<input class="text-input"
       type="text"
       value="{{inputValue}}"
       placeholder="{{placeholder}}"
       disabled="{{disabled}}"
       bindinput="input"
       bindfocus="onFocus"
       bindblur="onBlur"
       adjust-position="{{false}}"
       cursor-spacing="20"
       confirm-type="send"
       bindconfirm="confirm"></input>
```

### 2.4 增强导航栏样式

增强导航栏的视觉效果，确保在键盘弹出时仍然可见：

```css
.custom-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background-color: #ededed;
  z-index: 1000;
  /* 添加阴影增强层次感 */
  box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.1);
}

.dark .custom-nav {
  background-color: #1a1d20;
}
```

### 2.5 优化滚动逻辑

在键盘弹出和消息发送时，自动滚动到底部，确保用户始终能看到最新消息：

```javascript
// 处理输入框获取焦点
handleInputFocus(e) {
  console.log('输入框获取焦点:', e);
  // 设置键盘显示状态
  this.setData({
    isKeyboardShow: true
  });
  // 滚动到底部
  this.scrollToBottom(50);
}
```

## 三、实现细节

### 3.1 数据结构

在页面的data中添加以下字段：

```javascript
data: {
  // 其他字段...
  keyboardHeight: 0,          // 键盘高度
  isKeyboardShow: false,      // 键盘是否显示
}
```

### 3.2 生命周期处理

在页面的生命周期函数中添加键盘监听的初始化和清理：

```javascript
onLoad() {
  // 其他初始化...
  
  // 监听键盘高度变化
  this.watchKeyboard();
}

onUnload() {
  // 其他清理...
  
  // 移除键盘监听
  this.unwatchKeyboard();
}
```

### 3.3 输入框组件事件处理

在聊天输入组件中添加焦点事件处理：

```javascript
// 输入框获取焦点
onFocus: function(e) {
  // 触发父组件的输入框获取焦点事件
  this.triggerEvent('focus', e.detail);
},

// 输入框失去焦点
onBlur: function(e) {
  // 触发父组件的输入框失去焦点事件
  this.triggerEvent('blur', e.detail);
}
```

## 四、使用说明

### 4.1 键盘弹出时的行为

1. 当用户点击输入框时，键盘弹出
2. 系统自动调整聊天容器的高度，确保内容区域不被压缩
3. 自动滚动到最新消息，确保用户可以看到对话上下文
4. 导航栏保持可见，不会被推出可视区域

### 4.2 键盘收起时的行为

1. 当用户点击发送按钮或键盘上的完成按钮时，键盘收起
2. 系统自动恢复聊天容器的原始高度
3. 页面布局恢复正常

## 五、兼容性说明

本优化方案已在以下环境中测试通过：

- iOS设备（iPhone系列）
- Android设备（主流机型）
- 微信最新版本

## 六、注意事项

1. 键盘高度监听API（`wx.onKeyboardHeightChange`）需要微信基础库版本 2.7.0 或以上
2. 在某些低端设备上，键盘高度变化可能不会触发监听事件，此时会回退到默认布局
3. 暗夜模式下的样式已经适配，会自动跟随系统设置

## 七、未来优化方向

1. 优化键盘弹出动画，使页面调整更加平滑
2. 增强输入框体验，如添加表情选择器、优化语音输入功能
3. 适配更多设备，特别是异形屏幕设备

## 八、相关文件

- `miniprogram\packageChat\pages\chat\chat.js`：聊天页面逻辑
- `miniprogram\packageChat\pages\chat\chat.wxml`：聊天页面结构
- `miniprogram\packageChat\pages\chat\chat.wxss`：聊天页面样式
- `miniprogram\packageChat\components\chat-input\index.js`：聊天输入组件逻辑
- `miniprogram\packageChat\components\chat-input\index.wxml`：聊天输入组件结构
