# 角色自定义方案

## 一、用户需求分析

用户希望能够创建高度自定义的角色，这些角色能够模拟真实人物的性格特点和说话方式，并且能够在对话过程中不断丰富角色人格和收集用户信息。具体需求包括：

1. **高度自定义角色**：
   - 支持各种人际关系（家人、情侣、老师、朋友等）
   - 能够模拟真实人物的性格特点和说话方式
   - 可自定义年龄段、生活经历等背景信息

2. **角色人格动态发展**：
   - 在多次对话中不断丰富角色的人格
   - 角色能够"记住"之前的对话内容和用户提供的信息

3. **用户画像构建**：
   - 收集用户的兴趣爱好、倾向点、语言风格等信息
   - 基于这些信息构建用户画像

4. **情感互动**：
   - 角色能够在适当时候安慰用户
   - 角色也能在必要时批评用户，提供建设性意见

## 二、实现方案

### 1. 角色数据结构

我们扩展了角色数据结构，添加了更多字段以支持高度自定义：

```javascript
{
  _id: "角色ID",
  name: "角色名称",
  avatar: "头像URL",
  
  // 基本信息
  relationship: "与用户的关系", // 家人、情侣、老师、朋友等
  age: 25, // 年龄
  gender: "性别", // 男/女/其他
  
  // 详细背景
  background: "生活经历和背景故事",
  education: "教育背景",
  occupation: "职业",
  hobbies: ["爱好1", "爱好2"],
  
  // 性格特点
  personality_traits: ["性格特点1", "性格特点2"],
  communication_style: "说话方式", // 例如：直接、温和、幽默、严肃等
  emotional_tendency: "情感倾向", // 例如：乐观、悲观、理性、感性等
  
  // AI提示词相关
  prompt: "系统提示词",
  
  // 记忆与发展
  memories: [
    {
      content: "记忆内容",
      importance: 0.8, // 重要性评分（0-1）
      timestamp: Date,
      context: "记忆上下文"
    }
  ],
  
  // 用户画像感知
  user_perception: {
    interests: ["用户兴趣1", "用户兴趣2"],
    preferences: ["用户偏好1", "用户偏好2"],
    communication_style: "用户说话方式",
    emotional_patterns: ["用户情感模式1", "用户情感模式2"]
  },
  
  // 基础字段
  creator: "创建者ID",
  createTime: Date,
  updateTime: Date,
  status: 1 // 1:启用 0:禁用
}
```

### 2. 角色创建流程

我们设计了一个分步表单，引导用户完成角色创建：

1. **第一步：基本信息**
   - 角色名称、与用户的关系、年龄、性别

2. **第二步：详细背景**
   - 职业、教育背景、爱好、生活经历

3. **第三步：性格特点**
   - 性格特点、说话风格、情感倾向、禁忌话题

用户可以在最后一步预览生成的提示词，也可以自定义提示词模板。

### 3. 角色记忆系统

为了实现角色在多次对话中不断丰富人格，我们设计了一个记忆系统：

1. **记忆提取**：
   - 在每次对话结束后，分析对话内容
   - 提取重要信息并存储到角色的 `memories` 数组中
   - 为每条记忆分配重要性评分

2. **记忆检索**：
   - 在新对话开始时，根据上下文相关性和重要性，选择最相关的记忆
   - 将这些记忆融合到系统提示词中，使AI能够"记住"之前的对话

3. **记忆管理**：
   - 实现记忆自动合并和淘汰机制，避免记忆过多导致提示词过长

### 4. 用户画像系统

为了收集用户信息并构建用户画像，我们实现了：

1. **对话分析**：
   - 在每次对话后，分析用户的表达方式、情感倾向和提到的兴趣爱好
   - 更新角色的 `user_perception` 字段

2. **用户画像反馈**：
   - 生成用户画像摘要
   - 让角色在对话中自然地反馈这些观察

3. **个性化互动**：
   - 基于用户画像调整角色的回应方式
   - 在用户情绪低落时提供安慰，在用户需要建议时提供批评性意见

### 5. 提示词生成系统

我们创建了一个提示词生成系统，根据角色信息生成高质量的提示词：

1. **基础提示词生成**：
   - 根据角色的基本信息、详细背景和性格特点生成基础提示词

2. **记忆融合**：
   - 将相关记忆自然地融入到提示词中

3. **用户画像融合**：
   - 将用户画像信息融入到提示词中，使角色能够根据用户的兴趣和偏好进行互动

4. **自定义模板**：
   - 支持用户自定义提示词模板，可以使用变量如 `{{name}}`、`{{relationship}}` 等

## 三、技术实现

### 1. 云函数架构

我们创建了一个完整的 `roles` 云函数，包含以下模块：

```
cloudfunctions/roles/                # 角色管理云函数
├── index.js                        # 主函数入口
├── roleManager.js                  # 基础角色管理模块
├── promptGenerator.js              # 提示词生成模块
├── memoryManager.js                # 记忆管理模块
├── userPerception.js               # 用户画像模块
├── init-roles.js                   # 初始角色数据
└── package.json                    # 依赖配置
```

### 2. 智谱AI接口调用

我们使用智谱AI的以下接口来实现高级功能：

1. **GLM-4-Flash**：用于生成角色回复、分析对话内容、提取记忆和构建用户画像
   - 优点：响应速度快，成本较低，适合实时对话
   - 用途：日常对话生成、简单的记忆提取和用户画像更新

2. **GLM-4**：用于更复杂的角色设计和深度分析
   - 优点：理解和生成能力更强，适合复杂任务
   - 用途：初始角色设计、复杂记忆整合、深度用户画像分析

3. **Embedding-3**：用于记忆检索和相关性计算
   - 优点：能够计算文本语义相似度，适合检索相关记忆
   - 用途：在对话开始时检索与当前上下文最相关的记忆

### 3. 前端实现

我们创建了一个符合iOS设计规范的角色编辑界面：

1. **UI设计**：
   - 卡片式布局、圆角元素和适当的投影效果
   - 分步表单，引导用户完成角色创建
   - 预览功能，让用户了解生成的提示词效果

2. **交互设计**：
   - 表单验证，确保必填字段不为空
   - 头像上传，支持从相册选择或拍照
   - 步骤导航，允许用户在不同步骤之间切换

## 四、使用场景

### 1. 角色创建/编辑

用户可以通过角色编辑页面创建或编辑角色，设置角色的各种属性，包括基本信息、详细背景和性格特点。系统会根据这些信息生成提示词，用户也可以自定义提示词模板。

### 2. 对话过程

在对话过程中，系统会根据角色的提示词生成回复。如果角色有记忆和用户画像，系统会将这些信息融入到提示词中，使角色能够"记住"之前的对话和用户的兴趣偏好。

### 3. 对话结束后

对话结束后，系统会分析对话内容，提取重要信息作为角色的记忆，并更新用户画像。这些信息会在下次对话中使用，使角色能够不断丰富人格和了解用户。

## 五、未来扩展

1. **情感分析增强**：
   - 更精细的情感分析，识别用户的情绪状态
   - 根据用户情绪调整角色的回应方式

2. **多模态交互**：
   - 支持语音输入和输出
   - 支持图片识别和生成

3. **角色社区**：
   - 允许用户分享自己创建的角色
   - 提供角色评分和评论功能

4. **角色进化**：
   - 基于用户反馈自动调整角色的性格和行为
   - 实现角色的长期记忆和成长

通过以上方案，我们实现了用户对自定义角色的需求，使用户能够创建高度个性化的角色，并在对话过程中不断丰富角色人格和收集用户信息，为用户提供更加个性化的对话体验。
