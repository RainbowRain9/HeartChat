# HeartChat 聊天功能开发计划

## 一、需求分析

### 当前状态
- 聊天页面UI已经实现，包括角色信息、消息滚动区和输入区
- 聊天页面基本逻辑已实现，包括加载角色信息、加载历史消息、发送消息等
- 聊天云函数框架已存在，但缺少核心功能实现，特别是与智谱AI的集成

### 需要完成的功能
- 完善聊天云函数，实现与智谱AI (GLM-4-Flash) 的集成
- 实现聊天记录的保存和获取
- 实现会话管理
- 集成基础情绪分析功能
- 优化聊天体验

## 二、详细开发计划

### 1. 完善聊天云函数 (cloudfunctions/chat)

#### 1.1 更新云函数结构
- 修改`index.js`，完善现有功能并添加新功能
- 添加`bigmodel.js`模块，用于与智谱AI交互
- 更新`package.json`，添加必要的依赖

#### 1.2 实现核心功能
- 实现`sendMessage`功能，处理用户消息并调用智谱AI生成回复
- 实现`getChatHistory`功能，获取聊天历史记录
- 实现`saveChatHistory`功能，保存聊天记录
- 实现`deleteMessage`功能，删除消息
- 实现`clearChatHistory`功能，清空聊天记录

#### 1.3 集成智谱AI
- 创建`bigmodel.js`模块，封装智谱AI API调用
- 实现Prompt构建，包括角色信息和历史消息
- 实现API调用和响应处理
- 添加错误处理和重试机制

#### 1.4 集成情绪分析
- 在`sendMessage`功能中添加情绪分析逻辑
- 调用`analysis`云函数进行情绪分析
- 将情绪分析结果保存到`emotion_records`集合

### 2. 数据库设计与实现

#### 2.1 完善`chats`集合
- 添加必要字段：user_id, role_id, role_name, create_time, last_message_time, message_count
- 设置适当的索引，优化查询性能

#### 2.2 完善`messages`集合
- 添加必要字段：chat_id, user_id, role_id, content, sender, create_time, status, emotion_tags, keywords
- 设置适当的索引，优化查询性能

### 3. 前端优化

#### 3.1 优化聊天页面
- 优化消息加载逻辑，支持分页加载
- 添加加载状态提示
- 优化滚动体验

#### 3.2 增强错误处理
- 添加网络错误处理
- 添加API调用失败处理
- 添加重试机制

## 三、实施步骤

### 步骤1：完善聊天云函数
1. 创建`cloudfunctions/chat/bigmodel.js`文件，实现与智谱AI的交互
2. 更新`cloudfunctions/chat/index.js`文件，完善现有功能并添加新功能
3. 更新`cloudfunctions/chat/package.json`文件，添加必要的依赖

### 步骤2：完善数据库设计
1. 确认`chats`和`messages`集合的字段设计
2. 设置适当的索引，优化查询性能

### 步骤3：测试与优化
1. 测试聊天功能，确保消息发送和接收正常
2. 测试情绪分析功能，确保分析结果准确
3. 测试历史记录功能，确保记录保存和获取正常
4. 优化性能和用户体验

### 步骤4：文档更新
1. 更新`README.md`，添加聊天功能说明
2. 更新`todo.md`，标记已完成的任务
3. 创建聊天功能使用文档，放在`docs/使用文档/`目录下

## 四、功能详细说明

### 1. 聊天云函数 API

#### 1.1 sendMessage
- **功能**：发送用户消息并获取AI回复
- **参数**：
  - `chatId`：聊天会话ID（可选，新会话不需要）
  - `roleId`：角色ID
  - `content`：用户消息内容
- **返回值**：
  - `success`：是否成功
  - `chatId`：聊天会话ID
  - `message`：用户消息对象
  - `aiMessage`：AI回复消息对象
  - `emotionAnalysis`：情绪分析结果（可选）

#### 1.2 getChatHistory
- **功能**：获取聊天历史记录
- **参数**：
  - `roleId`：角色ID
  - `skip`：跳过的消息数量（分页用）
  - `limit`：返回的消息数量（分页用）
- **返回值**：
  - `success`：是否成功
  - `chatId`：聊天会话ID
  - `messages`：消息数组
  - `hasMore`：是否还有更多消息

#### 1.3 saveChatHistory
- **功能**：保存聊天记录
- **参数**：
  - `chatId`：聊天会话ID
- **返回值**：
  - `success`：是否成功

#### 1.4 deleteMessage
- **功能**：删除消息
- **参数**：
  - `messageId`：消息ID
- **返回值**：
  - `success`：是否成功

#### 1.5 clearChatHistory
- **功能**：清空聊天记录
- **参数**：
  - `chatId`：聊天会话ID
- **返回值**：
  - `success`：是否成功

### 2. 数据库集合设计

#### 2.1 chats集合
- `_id`：聊天会话ID
- `user_id`：用户ID
- `role_id`：角色ID
- `role_name`：角色名称（冗余字段，方便查询）
- `create_time`：创建时间
- `last_message_time`：最后消息时间
- `message_count`：消息数量
- `summary`：对话摘要（可选，由AI生成）

#### 2.2 messages集合
- `_id`：消息ID
- `chat_id`：会话ID
- `user_id`：用户ID
- `role_id`：角色ID
- `content`：消息内容
- `sender_type`：发送者类型（'user', 'ai'）
- `create_time`：创建时间
- `status`：消息状态（'sent', 'delivered', 'read', 'failed'）
- `emotion_tags`：情绪标签（数组，可由AI分析生成）
- `keywords`：关键词（数组，可由AI分析生成）
- `is_analyzed`：是否已分析（布尔值）
- `analysis_result`：分析结果（对象，如果有单条消息分析）

## 五、开发时间表

### 第1天：准备工作
- 创建`bigmodel.js`模块
- 更新`package.json`
- 确认数据库设计

### 第2天：核心功能实现
- 实现`sendMessage`功能
- 实现`getChatHistory`功能
- 实现`saveChatHistory`功能

### 第3天：辅助功能实现
- 实现`deleteMessage`功能
- 实现`clearChatHistory`功能
- 集成情绪分析功能

### 第4天：测试与优化
- 测试所有功能
- 修复问题
- 优化性能

### 第5天：文档更新
- 更新`README.md`
- 更新`todo.md`
- 创建使用文档
