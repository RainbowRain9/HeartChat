# 情绪历史界面暗夜模式适配说明

## 问题描述

在HeartChat项目中，情绪历史界面（包括情绪历史页面和每日报告页面）不会根据本地缓存的`darkMode`值来切换暗夜模式，而是依赖于系统主题设置。这导致即使用户在个人中心手动切换了暗夜模式，情绪历史界面也不会跟随变化。

## 解决方案

修改情绪历史相关页面的代码，使其优先读取本地缓存中的`darkMode`设置，而不是依赖系统主题设置。具体修改了以下两个页面：

1. 情绪历史页面（emotion-history.js）
2. 每日报告页面（daily-report.js）

## 技术实现

### 1. 情绪历史页面（emotion-history.js）

#### 修改onLoad函数

在页面加载时，优先从本地缓存读取darkMode设置：

```javascript
onLoad: function (options) {
  // 获取系统信息
  const systemInfo = wx.getSystemInfoSync();
  
  // 获取全局应用实例
  const app = getApp();
  
  // 优先使用本地缓存中的 darkMode 设置
  let darkMode = false;
  try {
    const localDarkMode = wx.getStorageSync('darkMode');
    if (localDarkMode !== undefined && localDarkMode !== null) {
      // 确保 localDarkMode 是布尔值
      darkMode = typeof localDarkMode === 'boolean' ? localDarkMode : localDarkMode === 'true';
      console.log('情绪历史页面加载时从本地缓存读取暗黑模式设置:', darkMode);
    } else if (app && app.globalData && app.globalData.darkMode !== undefined) {
      // 如果本地缓存中没有设置，则使用全局状态
      darkMode = app.globalData.darkMode;
      console.log('情绪历史页面加载时使用全局状态暗黑模式设置:', darkMode);
    } else {
      // 如果全局状态也没有设置，则使用系统主题
      darkMode = systemInfo.theme === 'dark';
      console.log('情绪历史页面加载时使用系统主题设置暗黑模式:', darkMode);
    }
  } catch (e) {
    console.error('获取暗黑模式设置失败:', e);
    // 如果出错，使用系统主题
    darkMode = systemInfo.theme === 'dark';
  }

  // 设置页面数据
  this.setData({
    darkMode,
    statusBarHeight,
    navBarHeight
  });
}
```

#### 修改onShow函数

在页面显示时，检查本地缓存中的darkMode设置是否变化：

```javascript
onShow: function () {
  // 获取全局应用实例
  const app = getApp();
  
  // 优先使用本地缓存中的 darkMode 设置
  let newDarkMode = false;
  try {
    const localDarkMode = wx.getStorageSync('darkMode');
    if (localDarkMode !== undefined && localDarkMode !== null) {
      // 确保 localDarkMode 是布尔值
      newDarkMode = typeof localDarkMode === 'boolean' ? localDarkMode : localDarkMode === 'true';
      console.log('情绪历史页面从本地缓存读取暗黑模式设置:', newDarkMode);
    } else if (app && app.globalData && app.globalData.darkMode !== undefined) {
      // 如果本地缓存中没有设置，则使用全局状态
      newDarkMode = app.globalData.darkMode;
      console.log('情绪历史页面使用全局状态暗黑模式设置:', newDarkMode);
    } else {
      // 如果全局状态也没有设置，则使用系统主题
      const systemInfo = wx.getSystemInfoSync();
      newDarkMode = systemInfo.theme === 'dark';
      console.log('情绪历史页面使用系统主题设置暗黑模式:', newDarkMode);
    }
  } catch (e) {
    console.error('获取暗黑模式设置失败:', e);
    // 如果出错，使用系统主题
    const systemInfo = wx.getSystemInfoSync();
    newDarkMode = systemInfo.theme === 'dark';
  }

  // 检查暗黑模式是否变化
  if (this.data.darkMode !== newDarkMode) {
    this.setData({ darkMode: newDarkMode });
    console.log('情绪历史页面更新暗黑模式为:', newDarkMode);

    // 如果图表已初始化，重新初始化以适应主题变化
    if (this.data.hasData) {
      this.initCharts();
    }
  }
}
```

### 2. 每日报告页面（daily-report.js）

#### 修改checkDarkMode函数

修改检测暗夜模式的函数，优先从本地缓存读取darkMode设置：

```javascript
checkDarkMode: function() {
  // 优先使用本地缓存中的 darkMode 设置
  try {
    const localDarkMode = wx.getStorageSync('darkMode');
    if (localDarkMode !== undefined && localDarkMode !== null) {
      // 确保 localDarkMode 是布尔值
      const darkModeValue = typeof localDarkMode === 'boolean' ? localDarkMode : localDarkMode === 'true';
      this.setData({ darkMode: darkModeValue });
      console.log('每日报告页面从本地缓存读取暗黑模式设置:', darkModeValue);
      return;
    }
  } catch (e) {
    console.error('从本地缓存读取darkMode失败:', e);
  }
  
  // 如果本地缓存中没有设置，则使用全局状态
  const app = getApp();
  if (app.globalData && app.globalData.darkMode !== undefined) {
    this.setData({
      darkMode: app.globalData.darkMode
    });
    console.log('每日报告页面使用全局状态暗黑模式设置:', app.globalData.darkMode);
  } else {
    // 如果全局状态也没有设置，则使用系统主题
    wx.getSystemInfo({
      success: (res) => {
        const darkMode = res.theme === 'dark';
        this.setData({ darkMode });
        console.log('每日报告页面使用系统主题设置暗黑模式:', darkMode);

        // 如果全局数据存在，更新全局数据
        if (app.globalData) {
          app.globalData.darkMode = darkMode;
        }
      }
    });
  }
}
```

#### 修改onShow函数

在页面显示时，检查本地缓存中的darkMode设置是否变化：

```javascript
onShow: function () {
  // 优先使用本地缓存中的 darkMode 设置
  let newDarkMode = this.data.darkMode;
  let shouldUpdateDarkMode = false;
  
  try {
    const localDarkMode = wx.getStorageSync('darkMode');
    if (localDarkMode !== undefined && localDarkMode !== null) {
      // 确保 localDarkMode 是布尔值
      newDarkMode = typeof localDarkMode === 'boolean' ? localDarkMode : localDarkMode === 'true';
      shouldUpdateDarkMode = this.data.darkMode !== newDarkMode;
      console.log('每日报告页面onShow从本地缓存读取暗黑模式设置:', newDarkMode, '是否需要更新:', shouldUpdateDarkMode);
    } else {
      // 如果本地缓存中没有设置，则使用全局状态
      const app = getApp();
      if (app.globalData && app.globalData.darkMode !== undefined) {
        newDarkMode = app.globalData.darkMode;
        shouldUpdateDarkMode = this.data.darkMode !== newDarkMode;
        console.log('每日报告页面onShow使用全局状态暗黑模式设置:', newDarkMode, '是否需要更新:', shouldUpdateDarkMode);
      }
    }
  } catch (e) {
    console.error('每日报告页面onShow从本地缓存读取darkMode失败:', e);
  }
  
  // 如果暗黑模式状态变化，更新UI和图表
  if (shouldUpdateDarkMode) {
    this.setData({
      darkMode: newDarkMode,
      // 清空颜色映射，强制重新生成颜色
      emotionColorMap: {}
    });

    // 重新渲染图表
    if (this.data.report) {
      this.renderCharts(this.data.report);
    }
  }

  // 如果图表实例已经初始化，刷新图表
  if (this.chart) {
    this.chart.resize();
  }
}
```

## 效果

通过以上修改，情绪历史界面现在可以根据本地缓存的darkMode值正确地切换为亮色或暗色模式，与应用的其他部分保持一致的主题风格。

- 当用户在个人中心切换暗夜模式时，情绪历史界面会立即响应变化
- 当用户重新进入情绪历史界面时，会根据本地缓存的darkMode值显示正确的主题
- 图表和UI元素会根据当前的主题设置使用相应的颜色方案
