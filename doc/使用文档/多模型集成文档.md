# 多模型集成文档

## 概述

HeartChat 现已支持多种 AI 模型，包括智谱AI、Google Gemini、OpenAI、Crond API 和 CloseAI。本文档介绍了多模型集成的架构设计、配置方法和使用指南。

## 支持的模型平台

HeartChat 目前支持以下 AI 模型平台：

1. **智谱AI**
   - 模型：glm-4-flash, glm-4
   - 特点：中文理解能力强，适合中文场景
   - API 地址：https://open.bigmodel.cn/api/paas/v4/chat/completions

2. **Google Gemini**
   - 模型：gemini-2.5-flash-preview-04-17
   - 特点：多模态能力强，理解力和创造力较好
   - API 地址：https://apiv2.aliyahzombie.top

3. **OpenAI**
   - 模型：gpt-3.5-turbo, gpt-4, gpt-4-turbo
   - 特点：通用能力强，英文表现尤其出色
   - API 地址：https://api.openai.com/v1/chat/completions

4. **Crond API**
   - 模型：gpt-4o-mini, deepseek-v3, o3-mini
   - 特点：提供多种大语言模型，支持高质量的对话生成和推理能力
   - API 地址：https://new.crond.dev/v1/chat/completions

5. **CloseAI**
   - 模型：deepseek-ai/DeepSeek-V3-0324
   - 特点：提供 DeepSeek 系列模型，具有出色的中文理解能力和对话生成能力
   - API 地址：https://api.closeai.im/v1/chat/completions

## 架构设计

### 模块化设计

HeartChat 采用模块化设计，为每个 AI 模型平台创建独立的模块：

- `bigmodel.js`：智谱AI 模块
- `geminiModel.js`：Google Gemini 模块
- `openaiModel.js`：OpenAI 模块
- `crondModel.js`：Crond API 模块
- `closeaiModel.js`：CloseAI 模块

每个模块都实现了相同的接口，包括：

- `generateChatReply`：生成聊天回复
- `getAvailableModels`：获取可用模型列表

### 统一接口

所有模型模块都实现了统一的接口，确保可以无缝切换不同的模型：

```javascript
async function generateChatReply(
  userMessage,
  history = [],
  roleInfo = {},
  includeEmotionAnalysis = false,
  customSystemPrompt = null,
  params = {}
) {
  // 实现细节...
}
```

### 动态模型列表

系统支持动态获取模型列表，通过云函数 `getModelList` 实现：

```javascript
async function getModelList(event) {
  const { modelType = 'gemini' } = event;
  
  // 根据 modelType 获取不同平台的模型列表
  // ...
  
  return {
    success: true,
    models: models
  };
}
```

## 配置方法

### 环境变量配置

在云函数环境中，需要为每个模型平台设置相应的 API 密钥：

- `ZHIPU_API_KEY`：智谱AI API 密钥
- `GEMINI_API_KEY`：Google Gemini API 密钥
- `OPENAI_API_KEY`：OpenAI API 密钥
- `CROND_API_KEY`：Crond API 密钥
- `CLOSEAI_API_KEY`：CloseAI API 密钥

可以通过以下步骤配置环境变量：

1. 登录微信云开发控制台
2. 进入云函数 -> 环境变量
3. 添加相应的环境变量和值
4. 保存配置

### 模型配置

每个模型平台的配置在相应的模块文件中定义，例如 `crondModel.js` 中：

```javascript
// 默认模型配置
const DEFAULT_MODEL = 'gpt-4o-mini'; // 默认模型
const AVAILABLE_MODELS = ['gpt-4o-mini', 'deepseek-v3', 'o3-mini']; // 可用模型列表
```

## 使用方法

### 在聊天界面切换模型平台和模型

1. 打开聊天界面
2. 点击导航栏右侧的模型选择器
3. 在弹出的模型平台列表中选择需要的平台（如 "Crond API"）
4. 系统会自动测试连接并切换到选择的模型平台
5. 点击当前选择的模型平台，可以进一步选择该平台下的具体模型

### 通过代码调用

可以通过以下方式在代码中指定使用的模型平台和具体模型：

```javascript
// 在发送消息时指定模型类型和模型名称
wx.cloud.callFunction({
  name: 'chat',
  data: {
    action: 'sendMessage',
    chatId: chatId,
    roleId: roleId,
    content: message,
    modelType: 'crond', // 指定使用 Crond API
    modelName: 'deepseek-v3' // 指定使用 deepseek-v3 模型
  }
});
```

### 模型服务接口

`modelService.js` 提供了以下接口用于模型管理：

- `getAvailableModelTypes()`：获取所有可用的模型类型
- `getSelectedModelType()`：获取当前选择的模型类型
- `setSelectedModelType(modelType)`：设置选择的模型类型
- `getModelDisplayName(modelType)`：获取模型类型的显示名称
- `getModelConfig(modelType)`：获取模型配置信息
- `testModelConnection(modelType)`：测试模型连接
- `getModelList(modelType, forceRefresh)`：获取模型列表
- `getSelectedModel(modelType)`：获取当前选择的模型
- `setSelectedModel(modelType, modelName)`：设置选择的模型

## 前端组件

### 模型选择器组件

HeartChat 实现了一个模型选择器组件，用于在聊天界面选择不同的模型平台和具体模型：

- `model-selector.js`：模型选择器组件逻辑
- `model-selector.wxml`：模型选择器组件模板
- `model-selector.wxss`：模型选择器组件样式
- `model-selector.json`：模型选择器组件配置

组件提供了两级选择：

1. 第一级：选择模型平台（智谱AI、Google Gemini、OpenAI、Crond API、CloseAI）
2. 第二级：选择具体模型（如 gpt-4o-mini, deepseek-v3, o3-mini 等）

## 注意事项

1. **API 密钥安全**：确保各平台 API 密钥安全，不要在客户端代码中硬编码
2. **费用控制**：大多数 API 是付费服务，请注意控制使用量，避免产生过高费用
3. **错误处理**：实现了重试机制，但仍需注意处理 API 调用失败的情况
4. **模型兼容性**：不同模型的能力和特性有差异，可能需要针对特定模型调整提示词
5. **缓存机制**：模型列表会缓存 24 小时，可以通过 `forceRefresh` 参数强制刷新

## 常见问题

### Q: 如何获取各平台的 API 密钥？
A: 访问各平台的官方网站，注册账号并创建 API 密钥：
   - 智谱AI：https://open.bigmodel.cn/
   - OpenAI：https://platform.openai.com/
   - Crond API 和 CloseAI：请联系相应服务提供商

### Q: 为什么切换模型后没有响应？
A: 请检查以下几点：
   - 确认已正确配置相应平台的 API 密钥
   - 检查网络连接是否正常
   - 查看云函数日志，了解具体错误信息

### Q: 不同模型之间的回复有什么差异？
A: 不同模型有各自的特点，可以根据具体需求选择合适的模型：
   - 中文场景：推荐智谱AI 或 DeepSeek 系列模型
   - 英文场景：推荐 OpenAI 的 GPT 系列模型
   - 多模态需求：推荐 Google Gemini

## 更新历史

- 2025-05-10：添加 OpenAI 模型支持
- 2025-05-15：添加 Crond API 和 CloseAI 模型支持，实现动态模型列表
