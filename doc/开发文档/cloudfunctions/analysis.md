# Analysis 云函数文档

## 功能描述

Analysis云函数是一个**情感分析与关键词提取服务**，提供基于多种AI模型的文本情感分析、关键词提取、用户兴趣分析和报告生成功能。

## 文件结构

- **`index.js`** - 主入口文件，定义云函数接口和主要业务逻辑
- **`aiModelService.js`** - 统一AI模型服务，支持多平台调用
- **`aiModelService_part2.js`** - AI模型服务的第二部分（关键词提取、词向量）
- **`aiModelService_part3.js`** - AI模型服务的第三部分（聚类分析、兴趣分析）
- **`bigmodel.js`** - 智谱AI API集成模块
- **`geminiModel.js`** - Google Gemini API集成模块
- **`keywordClassifier.js`** - 关键词分类器
- **`userInterestAnalyzer.js`** - 用户兴趣分析器
- **`keywordEmotionLinker.js`** - 关键词情感关联模块
- **`keywords.js`** - HanLP关键词提取模块

## 主要流程

### 1. 情感分析流程
```
用户文本 → 参数验证 → AI模型调用 → JSON解析 → 情感分析结果 → 数据库存储（可选）
```

### 2. 关键词提取流程
```
用户文本 → 参数验证 → AI模型调用 → 关键词提取 → 权重计算 → 返回结果
```

### 3. 用户兴趣分析流程
```
关键词数组 → 分类处理 → 权重计算 → 关注点提取 → 情感关联 → 兴趣分析结果
```

### 4. 每日报告生成流程
```
用户ID → 查询情绪记录 → 情感统计分析 → AI生成报告内容 → 报告数据存储 → 返回结果
```

## 数据流向

### 输入数据
- 用户文本内容
- 历史聊天记录（用于上下文分析）
- 用户ID（用于数据存储）
- 角色ID和聊天ID（用于关联）
- AI模型类型选择

### 处理过程
1. **参数验证**：检查必要参数和格式
2. **AI模型调用**：根据选择的模型调用相应API
3. **结果解析**：解析AI返回的JSON数据
4. **数据加工**：标准化处理和权重计算
5. **关联分析**：关键词与情感关联
6. **数据存储**：将结果保存到数据库

### 输出数据
- 情感分析结果（包含多种情感指标）
- 关键词列表（带权重和分类）
- 用户兴趣分析结果
- 每日报告内容

## 涉及的数据库集合

- **`emotionRecords` (读/写)**: 存储情感分析结果，并在生成报告和分析关注点时读取。
- **`userInterests` (读/写)**: 存储和更新用户的兴趣关键词、分类及情感分数。
- **`userReports` (写)**: 写入生成的每日心情报告。
- **`messages` (只读)**: 在进行聊天情绪分析时，读取消息记录作为上下文。
- **`users` (只读)**: 在发送报告通知时，读取用户的通知设置。
- **`sys_config` (只读)**: 在发送报告通知时，读取订阅消息的模板ID。

## API接口

### 支持的操作类型
1. **`emotion`** - 情感分析
2. **`keywords`** - 关键词提取
3. **`word_vectors`** - 获取词向量
4. **`cluster`** - 关键词聚类分析
5. **`user_interests`** - 用户兴趣分析
6. **`focus_points`** - 用户关注点分析
7. **`daily_report`** - 每日报告生成
8. **`classify_keywords`** - 关键词分类
9. **`get_categories`** - 获取预定义分类
10. **`link_keywords_emotion`** - 关联关键词与情感
11. **`get_keyword_emotion_stats`** - 获取关键词情感统计
12. **`emotion_record`** - 获取单条情感记录分析
13. **`chat_emotion`** - 获取聊天的情绪分析

### 支持的AI模型
- Google Gemini (gemini-2.5-flash-preview-04-17)
- 智谱AI (glm-4-flash)
- OpenAI (gpt-3.5-turbo, gpt-4)
- Crond API、CloseAI、Grok、Claude等

## 错误处理

- API调用失败自动重试（最多3次）
- 429错误使用指数退避策略
- API不可用时降级为本地模拟数据
- 完整的错误日志记录

## 性能特性

- 并行处理情感分析和关键词提取
- 异步保存记录不阻塞主流程
- 关键词分类支持批量处理
- 多模型负载均衡