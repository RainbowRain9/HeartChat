# Login 云函数文档

## 功能描述

Login云函数是一个**用户登录认证服务**，提供微信用户登录、用户信息管理、JWT令牌生成和用户统计功能，支持新用户注册和现有用户信息更新。

## 文件结构

- **`index.js`** - 主入口文件，实现用户登录和认证逻辑

## 主要流程

### 1. 用户登录流程
```
接收微信用户信息 → 验证参数 → 查询现有用户 → 新用户处理/现有用户更新 → 生成用户统计 → 生成JWT令牌 → 记录登录日志 → 返回登录结果
```

## 数据流向

### 输入数据
- `userInfo` - 微信用户信息对象
  - `nickName` - 用户昵称
  - `avatarUrl` - 头像URL
  - `clientIP` - 客户端IP（可选）
  - `userAgent` - 用户代理（可选）

### 处理过程
1. **参数验证**：检查userInfo参数是否存在
2. **用户查询**：根据openid查询user_base集合
3. **用户处理**：
   - **新用户**：生成唯一userId，创建用户基础信息和统计记录
   - **现有用户**：更新用户信息（仅在用户名为默认值时更新），更新活跃天数统计
4. **令牌生成**：生成JWT令牌，包含用户基本信息和7天有效期
5. **日志记录**：记录登录成功日志
6. **统计获取**：获取最新的用户统计信息

### 输出数据
- 操作成功状态
- JWT访问令牌
- 是否新用户标识
- 用户详细信息
- 用户统计数据

## 涉及的数据库集合

### 1. user_base（用户基础信息表）
```javascript
{
  _id: "记录ID",
  user_id: "用户ID（7位数字）",
  openid: "微信openid",
  username: "用户名",
  avatar_url: "头像URL",
  user_type: 1, // 1-普通用户，2-VIP用户，3-管理员
  status: 1, // 1-启用，0-禁用
  created_at: "创建时间",
  updated_at: "更新时间"
}
```

### 2. user_stats（用户统计表）
```javascript
{
  _id: "记录ID",
  stats_id: "统计ID",
  user_id: "用户ID",
  openid: "微信openid",
  chat_count: 0, // 聊天次数
  solved_count: 0, // 解决问题数
  rating_avg: 0, // 平均评分
  active_days: 1, // 活跃天数
  last_active: "最后活跃时间",
  created_at: "创建时间",
  updated_at: "更新时间"
}
```

### 3. sys_log_login（登录日志表）
```javascript
{
  _id: "记录ID",
  log_id: "日志ID",
  user_id: "用户ID",
  openid: "微信openid",
  status: 1, // 1-成功，0-失败
  error: "错误信息（失败时）",
  ip: "客户端IP",
  device: "设备信息",
  created_at: "创建时间"
}
```

## 核心功能

### 1. 用户ID生成
- 格式：7位数字（1000000-9999999）
- 唯一性检查：确保生成的ID不重复
- 最大尝试次数：10次，防止无限循环

### 2. JWT令牌生成
- 有效期：7天
- 包含信息：user_id、user_type、status
- 签名密钥：硬编码的64位随机字符串

### 3. 用户信息更新策略
- 新用户：创建完整用户信息和统计记录
- 现有用户：
  - 用户名为"微信用户"或空时：更新昵称和头像
  - 其他情况：只更新最后活跃时间
- 活跃天数：每天首次登录时增加

## API接口

### 请求格式
```javascript
{
  userInfo: {
    nickName: "用户昵称",
    avatarUrl: "头像URL",
    clientIP: "客户端IP（可选）",
    userAgent: "用户代理字符串（可选）"
  }
}
```

### 响应格式（成功）
```javascript
{
  success: true,
  data: {
    token: "JWT访问令牌",
    isNewUser: true, // 是否新用户
    userInfo: {
      userId: "1234567",
      username: "用户名",
      avatarUrl: "头像URL",
      userType: 1,
      status: 1,
      stats: {
        stats_id: "统计ID",
        user_id: "用户ID",
        chat_count: 0,
        solved_count: 0,
        rating_avg: 0,
        active_days: 1,
        last_active: "最后活跃时间",
        // 其他统计字段...
      }
    }
  }
}
```

### 响应格式（失败）
```javascript
{
  success: false,
  error: "登录失败的具体原因"
}
```

## 用户类型定义

- **1** - 普通用户
- **2** - VIP用户
- **3** - 管理员

## 用户状态定义

- **1** - 启用
- **0** - 禁用

## 错误处理

### 参数错误
- 缺少userInfo参数
- 返回明确的错误信息

### 系统错误
- 数据库操作失败
- ID生成失败
- JWT生成失败
- 记录详细的错误日志

### 登录失败处理
- 记录失败日志
- 包含错误信息和客户端信息
- 不影响用户再次尝试

## 安全特性

- JWT令牌签名验证
- 用户ID唯一性保证
- 登录日志记录
- 客户端信息收集

## 性能优化

- 只在必要时更新用户信息
- 活跃天数智能计算
- 批量数据库操作
- 错误隔离处理

## 使用场景

1. **用户首次登录**：自动注册新用户
2. **用户日常登录**：更新活跃状态和统计
3. **身份认证**：生成访问令牌
4. **用户管理**：提供用户基础信息

## 注意事项

- JWT密钥硬编码在代码中，生产环境建议使用环境变量
- 用户ID生成有最大尝试次数限制
- 登录日志包含客户端信息，需要注意隐私保护
- 统计信息创建失败不影响登录流程

## 扩展建议

1. **JWT刷新**：实现令牌刷新机制
2. **设备管理**：支持多设备登录管理
3. **权限验证**：基于用户类型的权限控制
4. **安全审计**：增强登录安全性检查