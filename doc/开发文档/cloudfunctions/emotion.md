# Emotion 云函数文档

## 功能描述

Emotion云函数是一个**情绪数据管理服务**，提供用户情绪概览分析和历史情绪记录查询功能，支持情绪统计、趋势分析和可视化数据生成。

## 文件结构

- **`index.js`** - 主入口文件，实现情绪数据处理逻辑

## 主要流程

### 1. 获取情绪概览流程
```
请求参数 → 获取用户ID → 计算时间范围（最近7天） → 查询情绪记录 → 统计情绪类型 → 计算百分比 → 排序处理 → 生成可视化数据 → 返回结果
```

### 2. 获取情绪历史流程
```
请求参数 → 获取用户ID → 计算时间范围（指定天数） → 查询历史记录 → 按日期分组 → 计算每日主要情绪 → 映射情绪值 → 生成图表数据 → 返回结果
```

## 数据流向

### 输入数据
- `action` - 操作类型（getEmotionOverview/getEmotionHistory）
- `userId` - 用户ID（可选，默认使用OPENID）
- `days` - 查询天数（仅getEmotionHistory，默认30天）
- `limit` - 记录数量限制（仅getEmotionHistory，默认100条）

### 处理过程
1. **参数验证**：获取操作类型和相关参数
2. **用户识别**：获取用户ID（优先使用传入参数，否则使用OPENID）
3. **时间计算**：根据操作类型计算查询时间范围
4. **数据查询**：从数据库获取情绪记录
5. **数据处理**：
   - 概览：统计情绪类型出现次数，计算百分比
   - 历史：按日期分组，计算每日主要情绪和情绪值
6. **数据排序**：按出现次数或日期排序
7. **可视化准备**：生成图表所需的标签、数值、颜色等数据

### 输出数据
- 操作成功状态
- 情绪统计数据
- 图表可视化数据
- 主要情绪信息
- 错误信息（如果有）

## 涉及的数据库集合

### emotionRecords（情绪记录表）
```javascript
{
  _id: "记录ID",
  userId: "用户ID",
  mainEmotion: "主要情绪类型",
  emotions: [
    {
      emotion: "情绪类型",
      intensity: 0.8,
      description: "情绪描述"
    }
  ],
  createTime: "创建时间",
  // 其他情绪分析相关字段...
}
```

## API接口

### 支持的操作类型

#### 1. getEmotionOverview - 获取情绪概览
**功能**：获取用户最近一周的情绪统计数据

**请求参数**：
```javascript
{
  action: 'getEmotionOverview',
  userId: '用户ID（可选）'
}
```

**响应格式**：
```javascript
{
  success: true,
  data: {
    labels: ["快乐", "平静", "焦虑"], // 情绪类型标签
    values: [5, 3, 2], // 出现次数
    colors: ["#38b2ac", "#48bb78", "#ed64a6"], // 对应颜色
    mainEmotion: "快乐", // 主要情绪
    secondEmotion: "平静", // 次要情绪
    emotionArray: [ // 详细情绪数据
      {
        emotion: "快乐",
        count: 5,
        percentage: 50
      }
    ]
  }
}
```

#### 2. getEmotionHistory - 获取情绪历史
**功能**：获取用户指定时间范围内的情绪历史趋势

**请求参数**：
```javascript
{
  action: 'getEmotionHistory',
  userId: '用户ID（可选）',
  days: 30, // 查询天数，默认30天
  limit: 100 // 记录数量限制，默认100条
}
```

**响应格式**：
```javascript
{
  success: true,
  data: {
    dailyData: [ // 每日情绪数据
      {
        date: "2025-01-01",
        mainEmotion: "快乐",
        emotionValue: 100,
        recordCount: 3
      }
    ],
    chartData: {
      dates: ["2025-01-01", "2025-01-02"], // 日期数组
      values: [100, 80], // 情绪值数组
      emotions: ["快乐", "满足"] // 情绪类型数组
    }
  }
}
```

## 情绪类型和颜色映射

### 支持的情绪类型
- **积极情绪**：快乐、满足、平静、期待、惊讶
- **消极情绪**：担忧、疲惫、焦虑、悲伤、压力、愤怒、恐惧
- **未知情绪**：未知

### 情绪值映射
```javascript
{
  '快乐': 100,
  '满足': 80,
  '平静': 60,
  '期待': 40,
  '惊讶': 20,
  '未知': 0,
  '担忧': -20,
  '疲惫': -40,
  '焦虑': -60,
  '悲伤': -80,
  '压力': -90,
  '愤怒': -95,
  '恐惧': -100
}
```

### 颜色映射
```javascript
{
  '疲惫': '#ffc107',
  '压力': '#f56565',
  '担忧': '#4299e1',
  '焦虑': '#ed64a6',
  '平静': '#48bb78',
  '满足': '#9f7aea',
  '快乐': '#38b2ac',
  '愤怒': '#e53e3e',
  '悲伤': '#718096',
  '期待': '#ecc94b',
  '惊讶': '#667eea',
  '恐惧': '#805ad5',
  '未知': '#a0aec0'
}
```

## 错误处理

- 数据库查询错误处理
- 参数验证错误处理
- 详细的错误日志记录
- 友好的错误信息返回

## 性能优化

- 限制查询记录数量
- 按时间范围过滤数据
- 内存中数据处理优化
- 避免复杂聚合查询

## 使用场景

1. **情绪仪表盘**：显示用户情绪概览和主要情绪类型
2. **情绪趋势分析**：展示用户情绪变化趋势
3. **心理健康监控**：长期跟踪情绪状态
4. **个性化推荐**：基于情绪状态提供相关建议