# ClearDatabase 云函数文档

## 功能描述

ClearDatabase云函数是一个**数据库清理工具**，用于清理指定集合的数据，支持选择性清理和强制清理所有数据的功能。

## 文件结构

- **`index.js`** - 主入口文件，实现数据库清理逻辑

## 主要流程

### 1. 数据库清理流程
```
接收请求 → 获取要清理的集合列表 → 检查是否强制清理 → 遍历集合 → 统计文档数量 → 删除文档 → 记录结果 → 返回清理报告
```

## 数据流向

### 输入数据
- `collections` - 要清理的集合列表（可选）
- `force` - 是否强制清理所有集合（可选）

### 处理过程
1. **参数解析**：获取要清理的集合列表和强制标志
2. **集合配置**：根据force参数调整清理范围
3. **批量清理**：遍历每个集合进行清理
4. **结果统计**：记录每个集合的清理结果
5. **状态标记**：标记保留的集合状态

### 输出数据
- 清理成功状态
- 每个集合的清理结果
- 删除的文档数量
- 错误信息（如果有）

## 涉及的数据库集合

### 默认清理的集合
- **messages** - 消息表
- **chats** - 聊天会话表
- **emotionRecords** - 情感记录表
- **roleUsage** - 角色使用统计表

### 默认保留的集合
- **roles** - 角色表
- **sys_config** - 系统配置表
- **dict_type** - 字典类型表
- **dict_data** - 字典数据表
- **emotion_practices** - 情感练习表

### 强制清理时额外清理的集合
- 当`force=true`时，会清理所有集合包括保留的集合

## API接口

### 支持的操作
- **清理指定集合**：传入collections参数指定要清理的集合
- **清理默认集合**：不传collections参数，清理默认集合
- **强制清理所有**：传入force=true，清理所有集合

### 请求格式
```javascript
{
  collections: ['messages', 'chats'], // 可选，要清理的集合列表
  force: false // 可选，是否强制清理所有集合
}
```

### 响应格式
```javascript
{
  success: true,
  results: {
    messages: {
      status: 'cleaned',
      total: 100,
      deleted: 100
    },
    chats: {
      status: 'cleaned',
      total: 50,
      deleted: 50
    },
    roles: {
      status: 'preserved'
    }
  }
}
```

## 错误处理

- 集合不存在时的错误处理
- 删除操作的错误捕获
- 详细的错误日志记录
- 部分失败时的结果统计

## 安全特性

- 默认保护重要系统数据
- 需要明确指定才能清理保留集合
- 详细的操作日志记录
- 错误时提供明确错误信息

## 使用场景

1. **开发环境重置**：清理测试数据
2. **生产环境维护**：选择性清理用户数据
3. **数据迁移准备**：清理旧数据准备导入新数据
4. **性能优化**：清理大量历史数据