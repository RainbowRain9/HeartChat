## HeartChat 项目数据库设计方案

### 1. 数据库选型

考虑到项目是微信小程序，并利用云开发能力（从 [`cloudfunctions`](../cloudfunctions/:1) 目录结构推断），推荐选用**云开发提供的 NoSQL 文档型数据库**（例如腾讯云云开发数据库，其 API 风格类似 MongoDB）。

**选型依据：**

*   **与云函数无缝集成**：云开发环境天然支持，简化了后端逻辑与数据存储的交互（如 [`cloudfunctions/user/index.js`](../cloudfunctions/user/index.js:1) 中的数据库操作）。
*   **灵活的 Schema**：NoSQL 数据库对数据结构要求灵活，适合存储如聊天记录、用户画像等半结构化或非结构化数据，便于快速迭代和适应需求变化。
*   **高并发与可扩展性**：文档型数据库通常具有良好的水平扩展能力，能较好地应对小程序用户量增长带来的并发压力。
*   **开发效率**：对于前端开发者，JSON 风格的数据模型更易于理解和操作。

### 2. 核心业务实体

根据项目文件结构和功能推断（例如 [`cloudfunctions/chat/index.js`](../cloudfunctions/chat/index.js:1), [`cloudfunctions/roles/index.js`](../cloudfunctions/roles/index.js:1), [`miniprogram/services/userService.js`](../miniprogram/services/userService.js:1)），核心业务实体包括：

*   **User (用户)**：小程序的用户。
*   **Role (AI 角色)**：用户可以与之交互的 AI 角色。
*   **ChatSession (聊天会话)**：用户与 AI 角色之间的一次完整对话。
*   **ChatMessage (聊天消息)**：会话中的每一条具体消息。
*   **EmotionLog (情绪记录)**：用户的情绪状态记录。
*   **UserInterest (用户兴趣)**：用户的兴趣标签。
*   **UserPerception (用户画像)**：系统对用户特征的分析和记录。

### 3. 实体关系模型 (ERM)

采用 NoSQL 数据库，关系主要通过引用 (ID 关联) 或部分嵌入来实现。

*   **User** 1 --- * **ChatSession** (一个用户可以有多个聊天会话)
*   **Role** 1 --- * **ChatSession** (一个角色可以参与多个聊天会话)
*   **ChatSession** 1 --- * **ChatMessage** (一个会话包含多条消息)
*   **User** 1 --- * **EmotionLog** (一个用户可以有多条情绪记录)
*   **User** 1 --- * **UserInterest** (一个用户可以有多个兴趣标签)
*   **User** 1 --- 1 **UserPerception** (一个用户对应一个用户画像，可考虑嵌入User或独立)

### 4. 关键数据表 (集合) 结构定义

以下为各核心实体的集合 (Collection) 结构定义，字段名采用驼峰式。

#### 4.1. `Users` 集合

存储用户信息。

| 字段名             | 数据类型        | 约束/说明                                     |
| :----------------- | :-------------- | :-------------------------------------------- |
| `_id`              | String          | 主键，云数据库自动生成，或可使用 `openid`       |
| `openid`           | String          | **唯一, 索引**。微信用户唯一标识                |
| `nickName`         | String          | 用户昵称                                      |
| `avatarUrl`        | String          | 用户头像 URL                                  |
| `gender`           | Number          | 0:未知, 1:男, 2:女                            |
| `city`             | String          | 城市                                          |
| `province`         | String          | 省份                                          |
| `country`          | String          | 国家                                          |
| `registrationDate` | Date            | **索引**。用户注册时间                        |
| `lastLoginDate`    | Date            | 最后登录时间                                  |
| `settings`         | Object          | 用户个性化设置 (如主题 [`miniprogram/theme.json`](../miniprogram/theme.json:1)) |
| `status`           | String          | 用户状态 (e.g., 'active', 'banned')           |
| `createdAt`        | Date            | 创建时间 (云数据库通常自动添加)                 |
| `updatedAt`        | Date            | 更新时间 (云数据库通常自动添加)                 |

#### 4.2. `Roles` 集合

存储 AI 角色信息。

| 字段名         | 数据类型        | 约束/说明                                                                 |
| :------------- | :-------------- | :------------------------------------------------------------------------ |
| `_id`          | String          | 主键，云数据库自动生成                                                      |
| `roleId`       | String          | **唯一, 索引**。自定义角色 ID，便于管理和引用                               |
| `name`         | String          | **索引**。角色名称                                                        |
| `description`  | String          | 角色描述                                                                  |
| `avatar`       | String          | 角色头像 URL                                                              |
| `prompt`       | String          | 角色的核心 Prompt (参考 [`cloudfunctions/roles/promptGenerator.js`](../cloudfunctions/roles/promptGenerator.js:1)) |
| `greeting`     | String          | 角色开场白                                                                |
| `creatorId`    | String          | **索引**。创建者 `Users._id` (若为用户自定义角色)                           |
| `isSystemRole` | Boolean         | `true` 表示系统预设角色, `false` 表示用户创建 (default: `false`)            |
| `tags`         | Array of String | 角色标签，便于分类和搜索                                                    |
| `usageCount`   | Number          | 被使用次数 (default: 0)                                                   |
| `memoryConfig` | Object          | 角色记忆配置 (参考 [`cloudfunctions/roles/memoryManager.js`](../cloudfunctions/roles/memoryManager.js:1)) |
| `createdAt`    | Date            | 创建时间                                                                  |
| `updatedAt`    | Date            | 更新时间                                                                  |

#### 4.3. `ChatSessions` 集合

存储用户与角色的聊天会话信息。

| 字段名               | 数据类型 | 约束/说明                                                              |
| :------------------- | :------- | :--------------------------------------------------------------------- |
| `_id`                | String   | 主键，云数据库自动生成                                                   |
| `userId`             | String   | **索引**。关联 `Users._id` 或 `Users.openid`                             |
| `roleId`             | String   | **索引**。关联 `Roles.roleId`                                            |
| `title`              | String   | 会话标题 (可选, 可由首条消息生成或用户自定义)                              |
| `lastMessageAt`      | Date     | **索引**。最新消息时间，用于会话列表排序                                   |
| `lastMessageSnippet` | String   | 最新消息摘要 (冗余字段，提高列表查询性能)                                  |
| `unreadCount`        | Number   | 用户在该会话中的未读消息数 (default: 0)                                    |
| `isArchived`         | Boolean  | 是否已归档 (default: `false`)                                            |
| `isPinned`           | Boolean  | 是否置顶 (default: `false`)                                              |
| `createdAt`          | Date     | **索引**。会话创建时间                                                   |
| `updatedAt`          | Date     | 会话最后更新时间 (通常等于 `lastMessageAt`)                                |

#### 4.4. `ChatMessages` 集合

存储具体的聊天消息。

| 字段名        | 数据类型        | 约束/说明                                                                                                |
| :------------ | :-------------- | :------------------------------------------------------------------------------------------------------- |
| `_id`         | String          | 主键，云数据库自动生成                                                                                     |
| `sessionId`   | String          | **索引**。关联 `ChatSessions._id`                                                                          |
| `senderId`    | String          | **索引**。发送者 ID (可能是 `Users._id` 或 `Roles.roleId`)                                                 |
| `senderType`  | String          | `enum: ['user', 'role']`。发送者类型                                                                       |
| `receiverId`  | String          | **索引**。接收者 ID (可能是 `Users._id` 或 `Roles.roleId`)                                                 |
| `content`     | String          | 文本消息内容                                                                                             |
| `messageType` | String          | `enum: ['text', 'image', 'audio', 'system']` (default: `'text'`)。消息类型 (参考 [`miniprogram/packageChat/components/chat-input/index.js`](../miniprogram/packageChat/components/chat-input/index.js:1)) |
| `mediaUrl`    | String          | 图片或音频的 URL (当 `messageType` 为 `image` 或 `audio` 时)                                               |
| `timestamp`   | Date            | **索引**。消息发送时间                                                                                     |
| `status`      | String          | `enum: ['sending', 'sent', 'delivered', 'read', 'failed']` (default: `'sent'`)。消息状态                   |
| `aiModel`     | String          | 使用的 AI 模型 (如 'gemini', 'zhipu', 参考 [`cloudfunctions/chat/geminiModel.js`](../cloudfunctions/chat/geminiModel.js:1)) |
| `metadata`    | Object          | 其他元数据，如情绪分析结果、引用的消息 ID 等                                                                 |
| `isDeleted`   | Boolean         | 软删除标记 (default: `false`)                                                                            |

#### 4.5. `EmotionLogs` 集合

存储用户的情绪记录 (参考 [`miniprogram/services/emotionService.js`](../miniprogram/services/emotionService.js:1))。

| 字段名                 | 数据类型 | 约束/说明                                                              |
| :--------------------- | :------- | :--------------------------------------------------------------------- |
| `_id`                  | String   | 主键，云数据库自动生成                                                   |
| `userId`               | String   | **索引**。关联 `Users._id` 或 `Users.openid`                             |
| `emotion`              | String   | **索引**。情绪标签 (如: "开心", "难过", "焦虑")                            |
| `intensity`            | Number   | 情绪强度 (e.g., 1-10)                                                  |
| `notes`                | String   | 用户备注或日记内容                                                       |
| `source`               | String   | `enum: ['chat_analysis', 'manual_input', 'daily_report']`。情绪来源      |
| `relatedChatSessionId` | String   | **索引** (可选)。关联的 `ChatSessions._id` (如果来源于聊天分析)          |
| `relatedChatMessageId` | String   | (可选)。关联的 `ChatMessages._id`                                        |
| `loggedAt`             | Date     | **索引**。记录时间                                                       |
| `createdAt`            | Date     | 创建时间                                                               |

#### 4.6. `UserInterests` 集合

存储用户的兴趣标签 (参考 [`cloudfunctions/user/userInterests.js`](../cloudfunctions/user/userInterests.js:1))。

| 字段名      | 数据类型 | 约束/说明                                                              |
| :---------- | :------- | :--------------------------------------------------------------------- |
| `_id`       | String   | 主键，云数据库自动生成                                                   |
| `userId`    | String   | **索引**。关联 `Users._id` 或 `Users.openid`                             |
| `tag`       | String   | **索引**。兴趣标签名称                                                   |
| `source`    | String   | `enum: ['manual', 'system_generated']`。标签来源 (用户手动添加或系统分析) |
| `weight`    | Number   | 兴趣权重/强度 (可选, default: 1)                                       |
| `createdAt` | Date     | 创建时间                                                               |

*复合唯一索引*: `(userId, tag)` 避免重复。

#### 4.7. `UserPerceptions` 集合

存储系统对用户的画像分析 (参考 [`cloudfunctions/user/userPerception.js`](../cloudfunctions/user/userPerception.js:1) 或 [`cloudfunctions/user/userPerception_new.js`](../cloudfunctions/user/userPerception_new.js:1))。

| 字段名              | 数据类型        | 约束/说明                                      |
| :------------------ | :-------------- | :--------------------------------------------- |
| `_id`               | String          | 主键，可直接使用 `userId` 以确保一对一关系       |
| `userId`            | String          | **唯一, 索引**。关联 `Users._id` 或 `Users.openid` |
| `summary`           | String          | 用户画像总结性描述                             |
| `keywords`          | Array of String | 从用户行为中提取的关键词                       |
| `personalityTraits` | Object          | 性格特质分析结果 (e.g., MBTI, 大五等)          |
| `communicationStyle`| String          | 推断的沟通风格                                 |
| `preferredTopics`   | Array of String | 用户偏好的聊天主题                             |
| `lastUpdatedAt`     | Date            | 画像最后更新时间                               |
| `version`           | Number          | 画像版本号                                     |

### 5. 索引策略

除了上述各表定义中已标注的单字段索引外，还需考虑复合索引以优化查询性能：

*   **`ChatSessions` 集合**:
    *   `{ userId: 1, lastMessageAt: -1 }`: 用于高效查询特定用户的会话列表并按最新消息时间倒序排列。
    *   `{ userId: 1, isPinned: -1, lastMessageAt: -1 }`: 如果支持置顶，用于优先显示置顶会话。
*   **`ChatMessages` 集合**:
    *   `{ sessionId: 1, timestamp: -1 }`: 用于高效查询特定会话的消息并按时间倒序排列。
    *   `{ sessionId: 1, timestamp: 1 }`: 按时间正序排列。
*   **`EmotionLogs` 集合**:
    *   `{ userId: 1, loggedAt: -1 }`: 用于查询用户的情绪历史记录。
    *   `{ userId: 1, emotion: 1, loggedAt: -1 }`: 按特定情绪类型查询。
*   **`UserInterests` 集合**:
    *   `{ userId: 1, tag: 1 }`: 确保用户和标签组合的唯一性，并快速查找。

索引的创建和维护需要根据实际的查询模式进行调整。云函数 [`cloudfunctions/user/createIndexes.js`](../cloudfunctions/user/createIndexes.js:1) 暗示了项目中已有创建索引的实践。

### 6. 数据一致性保障机制

*   **原子操作**：云开发数据库通常对单个文档的操作提供原子性。
*   **应用层一致性**：
    *   对于跨文档/集合的更新，例如发送新消息时，需要同时更新 `ChatMessages` 集合（插入新消息）和 `ChatSessions` 集合（更新 `lastMessageAt`, `lastMessageSnippet`, `unreadCount`）。这通常在云函数中通过代码逻辑保证。
    *   如果云开发环境支持事务（某些后端可能支持），则应用于关键的、需要强一致性的多步操作。若不支持，则需精心设计操作顺序和补偿机制。
*   **幂等性**：云函数接口设计应考虑幂等性，防止因重试导致数据不一致。
*   **软删除**：对于如 `ChatMessages` 等数据，优先考虑使用软删除标记 (`isDeleted: true`) 而不是物理删除，便于数据恢复和审计。

### 7. 范式设计考量 (NoSQL 反范式化)

NoSQL 设计倾向于反范式化以优化读取性能。

*   **数据冗余**：
    *   在 `ChatSessions` 中冗余 `lastMessageSnippet` 和 `lastMessageAt`，避免了在拉取会话列表时需要对 `ChatMessages` 进行聚合查询。
    *   用户信息（如 `nickName`, `avatarUrl`）可能会在 `ChatMessages` 中冗余少量，以减少前端渲染时的多次查询，但这会增加数据同步的复杂性，需权衡。当前设计倾向于不在此处冗余，通过 `senderId` 关联。
*   **嵌入文档 vs. 引用**：
    *   `UserPerceptions` 可以考虑嵌入到 `Users` 文档中，如果其总是伴随用户信息一起读取且结构相对固定。但独立集合更利于其自身的复杂查询和更新。当前设计为独立集合。
    *   `UserInterests` 列表较短时也可考虑嵌入 `Users`，但独立集合更灵活，尤其当兴趣标签数量多或需要对兴趣进行全局分析时。
    *   `ChatMessages` 数量可能非常大，不适合嵌入到 `ChatSessions` 中，采用引用方式更佳。

### 8. 性能和可扩展性设计决策

*   **合理的索引策略**：如上所述，是性能的基石。
*   **分页查询**：所有列表数据（聊天记录、会话列表、情绪历史等）必须使用分页加载 (`skip`, `limit` 或基于游标的分页)，避免一次性加载大量数据。
*   **读写分离**：若数据库平台支持且业务量巨大，可考虑配置读写分离。
*   **数据归档与清理**：
    *   对于非常久远且不活跃的 `ChatMessages` 和 `EmotionLogs`，可以设计归档策略，将其迁移到成本更低的存储或定期清理。[`cloudfunctions/clearDatabase/index.js`](../cloudfunctions/clearDatabase/index.js:1) 可能与此相关。
    *   定期清理无效或临时的用户数据。
*   **云函数优化**：
    *   减少不必要的数据库请求次数，合并操作。
    *   利用云函数并发能力处理请求。
*   **CDN 加速**：用户头像、聊天中发送的图片/语音等静态资源应存储在对象存储服务中，并通过 CDN 加速访问。
*   **异步处理**：对于非核心路径的耗时操作（如复杂的用户画像分析、批量通知），可采用异步任务队列处理，避免阻塞主流程。
*   **监控与告警**：对数据库的关键性能指标（QPS, 延迟, 连接数等）进行监控，并设置告警。

### 9. 安全性考量

*   **权限控制**：
    *   严格遵循云开发数据库的权限规则，确保用户只能访问和修改其自身数据。例如，`ChatSessions` 和 `ChatMessages` 的查询和写入必须基于当前登录用户的 `userId` 进行过滤。
    *   云函数层面进行严格的身份验证和权限校验。
*   **数据校验**：所有来自客户端的输入数据，在写入数据库前必须在云函数中进行严格的合法性校验（类型、长度、格式等），防止 XSS、注入等攻击。
*   **敏感数据处理**：
    *   用户密码（如果存在独立账户体系而非纯微信登录）必须加密存储。
    *   对于其他敏感信息，根据合规要求考虑是否需要加密存储。
*   **API 安全**：云函数 API 接口应有频率限制、防刷机制。

此数据库设计方案旨在为 HeartChat 项目提供一个坚实、可扩展且高性能的数据存储基础。在项目迭代过程中，应根据实际运营数据和新的业务需求持续优化。