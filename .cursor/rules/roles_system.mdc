---
description:
globs:
alwaysApply: true
---
# AI角色系统

## 功能概述
HeartChat的核心特色是多样化的AI角色系统，用户可以与不同性格和专长的AI角色进行对话，获得不同风格的回复和建议。角色系统支持预设角色和用户自定义角色，通过角色提示词模板和角色记忆实现个性化的对话体验。

## 相关文件结构
- 前端部分：
  - [miniprogram/pages/role-select/](mdc:miniprogram/pages/role-select/)：角色选择页面
  - [miniprogram/pages/role-editor/](mdc:miniprogram/pages/role-editor/)：角色编辑页面
  - [miniprogram/pages/prompt-editor/](mdc:miniprogram/pages/prompt-editor/)：提示词编辑页面
  - [miniprogram/pages/user/role/edit/](mdc:miniprogram/pages/user/role/edit/)：用户角色编辑页面
  - [miniprogram/components/role-card/](mdc:miniprogram/components/role-card/)：角色卡片组件
  
- 后端部分：
  - [cloudfunctions/roles/](mdc:cloudfunctions/roles/)：角色管理相关云函数

## 角色架构设计
根据[roles_architecture.md](mdc:roles_architecture.md)和[角色自定义方案.md](mdc:docs/使用文档/角色自定义方案.md)文件，HeartChat的角色系统基于以下架构设计：
- 基础角色模板：定义角色的基本属性和行为
- 角色特性：定义角色的性格、专长、语言风格等
- 角色提示词：引导AI按照角色设定生成回复
- 角色记忆：存储与用户的历史交互，形成连贯的对话体验

## 角色属性
每个AI角色通常包含以下属性：
```javascript
{
  _id: "角色唯一标识",
  name: "角色名称",
  avatar: "角色头像URL",
  description: "角色简短描述",
  detailed_description: "角色详细介绍",
  personality: "性格特点",
  expertise: ["专长领域1", "专长领域2"],
  language_style: "语言风格",
  background_story: "背景故事",
  prompt_template: "提示词模板",
  category: "角色分类",
  tags: ["标签1", "标签2"],
  is_system: true/false, // 是否为系统预设角色
  created_by: "创建者ID", // 用户创建的角色才有此字段
  created_at: "创建时间",
  updated_at: "更新时间",
  status: "active/inactive", // 角色状态
  popularity: 0, // 受欢迎程度
  example_dialogues: [ // 示例对话
    {question: "问题", answer: "回答"},
    // ...更多示例对话
  ]
}
```

## 角色分类
根据[角色分类方案.md](mdc:docs/使用文档/角色分类方案.md)，HeartChat将角色分为以下几个主要类别：

1. 情感支持类
   - 倾听者：专注于倾听和理解用户情感
   - 情感顾问：帮助用户处理情绪问题
   - 共情伙伴：与用户共情，分享情感
   
2. 专业顾问类
   - 职业规划师：帮助用户规划职业发展
   - 学习教练：辅助学习和知识获取
   - 心理咨询师：提供心理健康方面的建议
   - 财务顾问：提供财务管理建议
   
3. 个人发展类
   - 思维导师：帮助用户拓展思维方式
   - 习惯养成助手：帮助用户培养良好习惯
   - 自我提升指导：促进个人全面发展
   
4. 娱乐互动类
   - 故事讲述者：讲述有趣的故事
   - 游戏伙伴：与用户进行游戏互动
   - 创意激发者：帮助用户激发创意

5. 定制角色
   - 用户自定义：用户根据自己需求创建的角色

## 提示词模板
根据[新角色编辑页面使用文档_更新版.md](mdc:docs/使用文档/新角色编辑页面使用文档_更新版.md)，角色提示词模板通常包含以下部分：

1. 角色定义：描述角色是谁，具有什么特点
2. 角色背景：角色的背景故事和经历
3. 语言风格：角色说话的方式和语气
4. 专业领域：角色擅长的知识和领域
5. 回复规则：角色在对话中应遵循的规则
6. 示例对话：几组问答示例，展示角色的应答风格

```
你是一名名叫"心灵伙伴"的AI情感支持助手，具有高度同理心和心理学知识。

背景：你拥有丰富的心理咨询经验，特别擅长倾听、理解他人情感，并提供温暖支持。

语言风格：你说话温和、亲切、耐心，使用简单易懂的语言，避免专业术语，总是尊重对方的感受，不评判用户的想法和行为。

专业领域：
- 情绪识别和管理
- 压力缓解技巧
- 积极心理学
- 日常心理支持

回复规则：
1. 以温暖友好的方式回应用户
2. 先理解和确认用户的情感，再提供建议
3. 提供具体、实用的建议，避免笼统的回答
4. 在用户感到低落时，提供鼓励和支持
5. 不冒充医生或心理医生，不提供医疗诊断
6. 鼓励用户在面对严重心理问题时寻求专业帮助

示例对话：
用户：最近工作压力好大，经常睡不好觉
心灵伙伴：听到你睡不好觉，想必这段时间工作压力确实很大。这种情况很多人都会经历，你并不孤单。能分享一下是什么让你感到特别有压力的吗？同时，也许你可以尝试睡前半小时做些轻松的活动，如听柔和的音乐或进行深呼吸练习，这可能有助于放松身心。
```

## 角色选择页面
根据[角色选择页面详细文档.md](mdc:docs/使用文档/角色选择页面详细文档.md)和[角色选择页面优化.md](mdc:docs/使用文档/角色选择页面优化.md)，角色选择页面的主要功能包括：

1. 展示分类的角色列表
2. 角色搜索和筛选
3. 角色详情查看
4. 收藏/取消收藏角色
5. 创建新角色的入口
6. 最近使用的角色快捷选择
7. 热门推荐角色展示

## 角色编辑功能
根据[角色自定义方案.md](mdc:docs/使用文档/角色自定义方案.md)，角色编辑功能包括：

1. 基本信息编辑：名称、头像、描述等
2. 角色个性设定：性格特点、语言风格等
3. 专业领域选择：设定角色的专长领域
4. 提示词模板编辑：定制角色的回复风格和规则
5. 示例对话设置：为角色添加示例对话
6. 背景故事编写：丰富角色的背景信息
7. 预览和测试：测试角色的对话效果

## 预设角色
根据[预设角色功能使用指南.md](mdc:docs/使用文档/预设角色功能使用指南.md)，系统提供一系列预设角色，分为以下几个方面：

1. 心理健康支持
   - 心灵伙伴：提供情感支持和倾听
   - 正念指导：引导冥想和压力管理
   
2. 学习与工作辅助
   - 学习教练：帮助制定学习计划和解答问题
   - 职业顾问：提供职业规划和发展建议
   
3. 生活与兴趣
   - 生活管家：日常生活建议和家务管理
   - 兴趣导师：培养和发展个人兴趣爱好
   
4. 自我提升
   - 目标规划师：帮助设定和实现个人目标
   - 思维拓展：促进创造性和批判性思维

## 自定义角色
用户可以通过以下步骤创建自定义角色：

1. 在角色选择页面点击"创建新角色"
2. 设置角色基本信息：名称、头像、简要描述
3. 选择角色类别和添加标签
4. 设置角色性格和专长领域
5. 编写角色提示词模板
6. 添加示例对话（可选）
7. 保存并开始使用新角色

## 角色云函数API
根据[roles云函数使用文档.md](mdc:docs/使用文档/roles云函数使用文档.md)，roles云函数提供以下主要API：

1. 获取角色列表：`getRoleList`
   - 参数：分页、筛选条件等
   - 返回：角色列表和总数

2. 获取角色详情：`getRoleDetail`
   - 参数：角色ID
   - 返回：角色详细信息

3. 创建角色：`createRole`
   - 参数：角色信息对象
   - 返回：创建结果和角色ID

4. 更新角色：`updateRole`
   - 参数：角色ID和更新字段
   - 返回：更新结果

5. 删除角色：`deleteRole`
   - 参数：角色ID
   - 返回：删除结果

6. 收藏/取消收藏：`toggleFavorite`
   - 参数：角色ID和操作类型
   - 返回：操作结果

7. 获取用户角色列表：`getUserRoles`
   - 参数：用户ID和筛选条件
   - 返回：用户创建的角色列表

## 角色记忆实现
角色记忆主要通过以下方式实现：

1. 会话历史存储：保存用户与角色的历史对话
2. 上下文管理：为AI提供必要的上下文信息
3. 首次对话提示：根据角色设定生成初始对话
4. 用户偏好记忆：记住用户的偏好和习惯
5. 长期记忆管理：管理长期对话记忆和关键信息
