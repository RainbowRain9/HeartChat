# HeartChat 开发文档

## 一、项目概述

心语精灵 是一款基于微信小程序云开发的 AI 情感陪伴与情商提升应用。通过与可定制的 AI 角色进行对话，用户可以在安全私密的环境中倾诉心事、整理思绪，并通过实时情感分析获得反馈，逐步提升自我认知和人际交往能力。

### 1.1 核心价值

- **情感倾诉**：提供安全的情感表达空间
- **角色管理**：用户可以创建和管理自己的角色
- **角色互动**：通过多样化的角色满足不同情感需求
- **情绪分析**：实时分析用户情绪，提供情绪建议
- **情绪跟踪**：记录和分析情绪变化
- **每日心情报告**：基于对话分析生成个性化心情总结和运势建议
- **用户画像**：基于用户对话内容生成用户画像（兴趣、性格、价值观等）
- **用户中心**：用户可以查看自己的信息和统计数据
- **系统设置**：用户可以设置自己的偏好和通知

### 1.2 目标用户

- 需要情感倾诉的用户
- 寻求心理支持的用户
- 想要记录心情变化的用户
- 希望获得建议和指导的用户
- 关注个人情绪和兴趣发展的用户

## 二、技术架构

### 2.1 前端技术

- 微信小程序原生框架 (JavaScript)
- 组件化开发 (`components/` 目录下)
- WXS / SASS (按需使用)
- ECharts 图表库 (用于数据可视化)

### 2.2 后端技术

- 微信云开发
  - 云函数 (Node.js)
  - 云数据库 (MongoDB 风格)
  - 云存储 (用于存储用户头像等)
  - 云调用 (订阅消息等)

### 2.3 AI 服务

- **对话生成:** 外部大语言模型 (LLM)
- **情感分析:** 智谱AI (GLM-4-Flash)
- **关键词提取:** 智谱AI (GLM-4-Flash)
- **词向量生成:** 智谱AI (Embedding-3)
- **用户画像:** 智谱AI (GLM-4-Flash) - 已增强
- **关键词分类:** 智谱AI (GLM-4-Flash) - 新增
- **关键词情感关联:** 智谱AI (GLM-4-Flash) - 新增

### 2.4 项目结构

```
HeartChat/
├── cloudfunctions/           # 云函数目录
│   ├── analysis/             # 情感分析云函数
│   ├── chat/                 # 聊天相关云函数
│   ├── clearDatabase/        # 数据库清理云函数
│   ├── login/                # 用户登录云函数
│   ├── role/                 # 旧版角色管理云函数
│   ├── roles/                # 新版角色管理云函数
│   └── user/                 # 用户管理云函数
│
├── miniprogram/              # 小程序前端代码
│   ├── components/           # 公共组件
│   │   ├── chat-bubble/      # 聊天气泡组件
│   │   ├── chat-input/       # 聊天输入组件
│   │   ├── emotion-analysis/ # 情感分析组件
│   │   ├── emotion-card/     # 情感卡片组件
│   │   ├── emotion-history/  # 情感历史组件
│   │   ├── emotion-panel/    # 情感面板组件
│   │   ├── emotion-pie/      # 情感饼图组件
│   │   ├── interest-tag-cloud/ # 兴趣标签云组件
│   │   ├── keyword-emotion-stats/ # 关键词情感统计组件
│   │   ├── login/            # 登录组件
│   │   └── practice-card/    # 练习卡片组件
│   │
│   ├── images/               # 图片资源
│   │   └── tabbar/           # 底部导航栏图标
│   │
│   ├── models/               # 数据模型
│   │   └── emotion.js        # 情感模型
│   │
│   ├── packageA/             # 分包A - 情感相关
│   │   └── pages/
│   │       └── emotion/
│   │           ├── analysis.ts  # 情感分析页面
│   │           └── practice.ts  # 情感练习页面
│   │
│   ├── packageB/             # 分包B - 组件相关
│   │   └── pages/
│   │       └── feedback/     # 反馈页面
│   │
│   ├── pages/                # 主包页面
│   │   ├── role-select/      # 角色选择页面（原心情树洞tab页）
│   │   │   └── agent-ui/     # 代理UI组件
│   │   └── user/             # 用户中心页面
│   │       ├── profile/      # 用户资料页面
│   │       └── role/         # 角色管理页面
│   │           └── edit/     # 角色编辑页面
│   │
│   ├── services/             # 业务服务
│   │   ├── emotionService.js # 情感服务
│   │   ├── personalityService.js # 用户画像服务
│   │   ├── userInterestsService.js # 用户兴趣服务
│   │   ├── keywordService.js # 关键词服务
│   │   ├── cloudFuncCaller.js # 云函数调用工具
│   │   └── eventBus.js # 事件总线
│   │
│   ├── utils/                # 工具函数
│   │   ├── emotionAnalyzer.js # 情感分析工具
│   │   ├── emotionHelper.js  # 情感辅助工具
│   │   └── stats.js          # 统计工具
│   │
│   ├── app.js                # 小程序入口文件
│   ├── app.json              # 小程序配置文件
│   └── app.wxss              # 小程序全局样式
│
├── docs/                     # 项目文档
│   ├── 使用文档/              # 使用文档
│   │   └── 云函数使用文档.md   # 云函数使用文档
│   ├── 小程序优化方案.md       # 小程序优化方案
│   └── 云函数整合与优化建议.md  # 云函数整合建议
│
├── scripts/                  # 脚本文件
├── utils/                    # 工具脚本
├── .gitignore                # Git忽略文件
├── package.json              # 项目依赖配置
├── project.config.json       # 项目配置文件
├── README.md                 # 项目说明文档
└── tsconfig.json             # TypeScript配置
```

## 三、数据库设计

### 3.1 集合设计

| 集合名称         | 用途         | 关键字段                                                               |
| ---------------- | ------------ | ---------------------------------------------------------------------- |
| `users`          | 用户信息     | openid, nickName, avatarUrl, createTime, lastLoginTime, reportSettings |
| `roles`          | 角色信息     | name, avatar, description, personality, prompt, creator                |
| `chats`          | 聊天会话信息 | roleId, userId, lastMessage, messageCount, updateTime                  |
| `messages`       | 消息详情     | chatId, content, sender, timestamp, emotionData                        |
| `emotionRecords` | 情感分析记录 | userId, chatId, type, intensity, timestamp, keywords                   |
| `roleUsage`      | 角色使用统计 | userId, roleId, usageCount, lastUsed                                   |
| `userReports`    | 用户每日报告 | userId, date, emotionSummary, keywords, interests, fortune             |
| `userInterests`  | 用户兴趣     | userId, interests{name, weight, updateTime}                            |
| `sys_config`     | 系统配置     | configKey, configValue, description                                    |

### 3.2 索引设计

为提高查询性能，需要为以下字段创建索引：

- `users`: openid (唯一索引)
- `roles`: creator, category, isSystem
- `chats`: userId, roleId
- `messages`: chatId, timestamp
- `emotionRecords`:
  - userId (用于按用户查询情绪记录)
  - createTime (用于按时间排序)
  - roleId (用于按角色筛选)
  - userId + createTime (组合索引，用于按用户查询并按时间排序)
  - userId + roleId (组合索引，用于按用户和角色筛选)
- `userReports`: userId, date

## 四、功能模块设计

### 4.1 用户系统

#### 登录流程

1. 用户点击登录按钮
2. 调用 `wx.login()` 获取 code
3. 调用 `login` 云函数，获取 openid
4. 保存用户信息到 `users` 集合
5. 返回用户信息和登录状态

#### 用户数据库设计

**1. 用户基础信息表 (user_base)**
```javascript
{
  _id: "string", // 系统自动生成的唯一ID
  user_id: "string", // 用户ID (与openid关联)
  openid: "string", // 微信OpenID
  username: "string", // 用户昵称
  avatar_url: "string", // 头像URL
  user_type: number, // 用户类型 (1普通/2企业/3管理员)
  status: number, // 账号状态 (0禁用/1启用)
  created_at: Date, // 创建时间
  updated_at: Date // 更新时间
}
```

**2. 用户详细信息表 (user_profile)**
```javascript
{
  _id: "string", // 系统自动生成的唯一ID
  user_id: "string", // 用户ID (与user_base关联)
  gender: number, // 性别 (0未知/1男/2女)
  country: "string", // 国家
  province: "string", // 省份
  city: "string", // 城市
  bio: "string", // 个人简介
  tags: Array, // 用户标签
  created_at: Date, // 创建时间
  updated_at: Date // 更新时间
}
```

**3. 用户统计信息表 (user_stats)**
```javascript
{
  _id: "string", // 系统自动生成的唯一ID
  stats_id: "string", // 统计ID
  user_id: "string", // 用户ID (与user_base关联)
  openid: "string", // 微信OpenID
  chat_count: number, // 对话次数
  solved_count: number, // 解决问题数
  rating_avg: number, // 平均评分
  active_days: number, // 活跃天数
  last_active: Date, // 最后活跃时间
  daily_report_count: number, // 每日报告数
  created_at: Date, // 创建时间
  updated_at: Date // 更新时间
}
```

**4. 用户配置表 (user_config)**
```javascript
{
  _id: "string", // 系统自动生成的唯一ID
  user_id: "string", // 用户ID (与user_base关联)
  dark_mode: boolean, // 是否启用暗黑模式
  notification_enabled: boolean, // 是否启用通知
  language: "string", // 语言设置
  created_at: Date, // 创建时间
  updated_at: Date // 更新时间
}
```

**5. 用户兴趣表 (user_interests)**
```javascript
{
  _id: "string", // 系统自动生成的唯一ID
  user_id: "string", // 用户ID (与user_base关联)
  interests: Array, // 兴趣标签数组 (Array<Object{tag: String, score: Number}>)
  aggregated_interest_vector: Array, // 用户聚合兴趣向量 (Array<Number>)
  created_at: Date, // 创建时间
  updated_at: Date // 更新时间
}
```

#### 用户中心页面

- 显示用户基本信息
- 展示用户统计数据
- 显示情绪概览和个性分析
- 提供角色管理入口
- 提供情绪历史入口
- 提供系统设置入口
- 提供退出登录功能

#### 个人资料页面

- 显示并允许编辑用户详细信息
- 显示用户性格分析和兴趣标签
- 提供头像上传功能

### 4.2 角色系统

#### 角色数据结构

```javascript
{
  _id: "角色ID",
  name: "角色名称",
  avatar: "头像URL",
  description: "角色描述",
  personality: ["性格特点1", "性格特点2"],
  prompt: "给AI的提示词",
  creator: "创建者ID", // 系统角色为"system"
  createTime: Date,
  updateTime: Date,
  status: 1 // 1:启用 0:禁用
}
```

#### 角色管理功能

- 浏览预设角色
- 创建自定义角色
- 编辑现有角色
- 设置默认角色

### 4.3 聊天系统

#### 对话流程

1. 用户发送消息
2. 前端将消息显示在对话界面
3. 调用 `chat` 云函数的 `sendMessage` 功能处理消息
4. 云函数将用户消息存储到 `messages` 集合
5. 云函数构建提示词，调用智谱AI (GLM-4-Flash) API 生成回复
6. 云函数将 AI 回复存储到 `messages` 集合
7. 云函数分析用户情绪，并将结果存储到 `emotion_records` 集合
8. 前端接收 AI 回复和情绪分析结果并显示
9. 在用户消息下方自动显示情绪分析标签
10. 更新情感分析面板

#### 聊天云函数功能

- **sendMessage**: 发送消息并获取AI回复
- **getChatHistory**: 获取聊天历史记录，支持分页加载
- **saveChatHistory**: 保存聊天记录
- **deleteMessage**: 删除指定消息
- **clearChatHistory**: 清空聊天记录
- **checkChatExists**: 检查是否存在与指定角色的历史聊天记录

#### 智谱AI集成

- 使用 GLM-4-Flash 模型生成聊天回复
- 基于角色提示词和历史消息构建上下文
- 在回复中包含情绪分析结果
- 安全处理API密钥，使用云函数环境变量存储

#### 聊天界面设计

- 卡片式聊天界面，符合iOS设计规范
- 支持角色切换和角色信息显示
- 消息气泡区分用户和AI，并显示时间戳
- 消息气泡使用圆角设计，并添加适当阴影增强立体感
- 消息气泡下方自动显示情绪分析标签，标签居中显示
- 输入框支持文本输入和发送，并始终保持在最上层
- 支持消息分页加载和滚动到底部
- 最后一条消息不会被输入框遮挡，确保良好的用户体验
- 集成情绪分析结果显示
- 智能欢迎语系统，根据角色关系类型生成个性化欢迎语
- 智能判断是否有历史聊天记录，有则加载历史记录，无则显示欢迎语
- 支持暗夜模式，自动跟随系统设置
- 键盘弹出优化，确保导航栏和消息内容不被遮挡

#### 聊天记录缓存与加载

- **本地缓存**: 将聊天记录保存到本地缓存，减少网络请求，提高加载速度
- **下拉刷新**: 通过下拉刷新获取最新消息
- **上拉加载**: 通过上拉加载更多历史消息
- **离线访问**: 即使在网络不稳定的情况下，也能查看历史聊天记录
- **自动同步**: 在网络恢复后自动同步最新消息
- **缓存管理**: 自动清理旧缓存，避免占用过多存储空间

#### 键盘弹出优化

- **键盘高度监听**: 使用 `wx.onKeyboardHeightChange` API 监听键盘高度变化
- **动态调整布局**: 根据键盘高度动态调整聊天容器高度
- **自动滚动**: 键盘弹出时自动滚动到最新消息
- **导航栏固定**: 确保导航栏始终可见，不会被键盘遮挡
- **输入框优化**: 禁用系统默认的键盘位置调整，提供更好的输入体验

### 4.4 情感分析系统

#### 情感分析流程

1. 用户发送消息后，调用 `analysis` 云函数
2. 云函数调用智谱AI (GLM-4-Flash) API进行情感分析
3. 云函数将分析结果存储到 `emotionRecords` 集合
4. 前端获取分析结果并更新情感面板
5. 前端自动在用户消息下方显示情绪分析标签
6. 显示情感类型、强度和建议

#### 关键词提取流程

1. 用户发送消息后，调用 `analysis` 云函数的关键词提取功能
2. 云函数调用智谱AI (GLM-4-Flash) API提取关键词和权重
3. 将关键词与情感分析结果关联，存储到数据库
4. 前端展示关键词云或关键词列表
5. 基于关键词聚类分析用户兴趣和关注点

#### 关键词分类流程

1. 关键词提取后，调用 `analysis` 云函数的关键词分类功能
2. 云函数调用智谱AI (GLM-4-Flash) API对关键词进行分类
3. 将分类结果存储到数据库，关联到用户兴趣记录
4. 前端根据分类结果展示不同颜色的关键词标签
5. 支持批量分类和单个分类模式

#### 关键词分类数据存储

关键词分类数据存储在 `userInterests` 集合中，包含两个主要部分：

1. **keywords 数组**：存储每个关键词的详细信息，包括关键词文本、权重、分类、情感分数等。

2. **categories 数组**：存储分类统计数据，包括分类名称、计数、首次出现时间和最后更新时间等。

每次更新关键词时，系统会同时更新这两个数组，确保数据一致性。这样设计可以快速获取用户的兴趣分类统计数据，而不需要每次都重新计算。

#### 关键词情感关联流程

1. 情感分析完成后，调用关键词情感关联功能
2. 将关键词与情感分析结果关联，计算关键词的情感分数
3. 使用加权平均算法更新关键词的情感分数，确保分数能够反映用户的最新情感倾向
4. 按情感倾向（正面、负面、中性）对关键词进行分类
5. 生成关键词情感统计数据，用于前端展示

#### 词向量生成流程

1. 调用 `analysis` 云函数的词向量功能
2. 云函数调用智谱AI (Embedding-3) API生成词向量
3. 将词向量用于聚类分析和相似度计算

#### 情感可视化

- 情感类型分布饼图
- 情感强度趋势图
- 关键词词云展示
- 兴趣主题聚类分析
- 关键词情感统计展示

#### 兴趣标签云组件

兴趣标签云组件（`components/interest-tag-cloud/`）用于展示用户的兴趣标签，支持自动加载、刷新和点击交互。

- **自动加载**：组件初始化时自动加载用户兴趣数据
- **刷新功能**：支持手动刷新标签云数据
- **点击交互**：支持点击标签查看详情
- **自定义样式**：支持自定义标签颜色和字体大小
- **分类展示**：支持按分类展示标签，不同分类使用不同颜色

#### 关键词情感统计组件

关键词情感统计组件（`components/keyword-emotion-stats/`）用于展示用户关键词的情感统计数据，帮助用户了解自己对不同话题的情感倾向。

- **情感分类**：将关键词分为正面、负面和中性三类
- **自动加载**：组件初始化时自动加载关键词情感统计数据
- **刷新功能**：支持手动刷新统计数据
- **点击交互**：支持点击关键词查看详情
- **排序功能**：根据情感分数和权重排序，突出重要关键词

#### 情绪历史页面

情绪历史页面（`packageEmotion/pages/emotion-history/`）是展示用户情绪历史记录的重要页面，包含以下功能：

- **时间范围选择**：支持一周、一个月、三个月、半年、一年等多种时间范围
- **情绪趋势图表**：直观展示不同情绪类型随时间的变化
- **情绪分布图表**：展示各种情绪类型的占比分布
- **情绪波动指数**：展示情绪波动指数，包括与上周的对比和变化原因分析
- **情绪日历**：以日历形式展示每天的主要情绪状态
- **最近情绪记录列表**：展示最近的情绪分析记录，包含角色名称、时间和情绪类型

数据获取和处理流程：

1. 页面加载时，先检查本地缓存
2. 如果缓存存在且未过期，使用缓存数据，同时在后台从数据库获取最新数据
3. 如果缓存不存在或已过期，从数据库获取数据
4. 处理数据，生成图表和列表
5. 将数据存入本地缓存，缓存过期时间为30分钟

用户交互：

1. 用户可以切换时间范围，查看不同时间段的情绪数据
2. 用户可以下拉刷新，强制从数据库获取最新数据
3. 用户可以点击最近情绪记录列表中的记录，跳转到对应的角色聊天页面或情绪分析详情页

### 4.5 每日心情报告系统

#### 报告生成流程

1. 定时触发器触发 `generateDailyReports` 云函数
2. 云函数遍历活跃用户，并调用 `analysis` 云函数的 `daily_report` 功能
3. `analysis` 云函数获取用户当日的情感记录和对话内容
4. 提取关键词并计算权重
5. 聚类关键词形成兴趣领域
6. 分析情绪变化和波动
7. 调用智谱AI (GLM-4-Flash) 生成个性化报告内容
8. 将报告保存到 `userReports` 集合
9. 更新用户兴趣数据到 `userInterests` 集合
10. 如果用户开启了通知，发送订阅消息通知

#### 报告页面设计

```
┌─────────────────────────┐
│  [日期选择] [分享按钮]  │
├─────────────────────────┤
│  今日心情总结           │
│  [情绪分布饼图]         │
│  [情绪趋势图]           │
├─────────────────────────┤
│  关注点分析             │
│  [关键词云]             │
├─────────────────────────┤
│  兴趣领域               │
│  [兴趣分布图]           │
├─────────────────────────┤
│  今日运势               │
│  宜: xxx                │
│  忌: xxx                │
│  幸运领域: xxx          │
├─────────────────────────┤
│  小建议                 │
│  1. xxx                 │
│  2. xxx                 │
├─────────────────────────┤
│  [励志语]               │
└─────────────────────────┘
```

#### 核心算法设计

##### 关键词权重计算

```javascript
// 关键词权重计算函数
function calculateKeywordWeight(keyword, context) {
  let weight = 0;

  // 词频权重 (TF-IDF)
  weight += calculateTfIdf(keyword, context) * 0.3;

  // 情感关联度
  weight += calculateEmotionalAssociation(keyword, context) * 0.25;

  // 时间衰减因子
  weight += calculateRecencyFactor(keyword, context) * 0.15;

  // 上下文重要性
  weight += calculateContextImportance(keyword, context) * 0.2;

  // 领域相关性
  weight += calculateDomainRelevance(keyword) * 0.1;

  return weight;
}
```

##### 兴趣聚类算法

```javascript
// 兴趣聚类算法
function clusterInterests(keywords) {
  // 初始化兴趣簇
  let clusters = [];

  // 第一轮：基于词向量相似度聚类
  clusters = initialClustering(keywords);

  // 第二轮：合并相似的簇
  clusters = mergeSimilarClusters(clusters);

  // 第三轮：找出每个簇的核心关键词
  clusters = identifyCoreKeywords(clusters);

  // 第四轮：根据用户历史兴趣调整
  clusters = adjustWithHistoricalInterests(clusters);

  return clusters;
}
```

##### 情绪波动计算

```javascript
// 情绪波动计算函数
function calculateEmotionalVolatility(emotionRecords) {
  // 标准差计算
  const intensities = emotionRecords.map(record => record.intensity);
  const mean = intensities.reduce((sum, val) => sum + val, 0) / intensities.length;
  const squareDiffs = intensities.map(val => Math.pow(val - mean, 2));
  const stdDev = Math.sqrt(squareDiffs.reduce((sum, val) => sum + val, 0) / squareDiffs.length);

  // 情绪类型变化
  const typeChanges = countEmotionTypeChanges(emotionRecords);

  // 时间加权
  const timeWeightedChanges = calculateTimeWeightedChanges(emotionRecords);

  // 综合波动指数 (0-100)
  const volatility = (stdDev * 40) + (typeChanges * 30) + (timeWeightedChanges * 30);

  return Math.min(Math.round(volatility), 100);
}
```

## 五、开发规范

### 5.1 代码规范

- 采用 JavaScript 标准规范
- 使用 ESLint 进行代码检查
- 命名规范：
  - 文件名：小写字母，用连字符（-）连接，如 `emotion-panel.js`
  - 变量名：驼峰命名法，如 `userInfo`
  - 常量：全大写，用下划线连接，如 `MAX_COUNT`
  - 函数名：驼峰命名法，如 `getUserInfo`
  - 组件名：大驼峰命名法，如 `EmotionPanel`

### 5.2 注释规范

- 文件头部添加描述注释
- 函数头部添加功能描述、参数和返回值注释
- 复杂逻辑添加行内注释
- 使用 JSDoc 风格的注释

示例：
```javascript
/**
 * 分析文本情感
 * @param {string} text 待分析文本
 * @returns {Promise<object>} 情感分析结果
 */
async function analyzeEmotion(text) {
  // 函数实现...
}
```

### 5.3 Git提交规范

- 提交信息格式：`[类型] 简短描述`
- 类型包括：feat(新功能)、fix(修复)、docs(文档)、style(格式)、refactor(重构)、test(测试)、chore(构建/工具)
- 每次提交尽量只做一件事
- 保持提交频率，避免大规模提交

## 六、开发计划

### 6.1 每日心情报告系统开发计划（优先级：高）

#### 第一阶段：基础架构与数据设计 (1-2周) - 已完成

- 搭建数据库结构 (`userReports`, `userInterests`, 扩展现有集合)
- 设计自定义算法框架 (关键词权重、兴趣聚类、情绪波动)
- 完成LLM提示词设计和测试

#### 第二阶段：后端功能开发 (2-3周) - 已完成

- 实现核心算法
- 开发生成报告云函数
- 开发获取报告云函数
- 开发定时触发器
- 开发通知推送机制
- 单元测试与性能优化

#### 第三阶段：前端开发 (2-3周) - 已完成

- 设计UI/UX原型
- 开发报告页面
- 开发图表组件
- 实现日历导航
- 开发报告设置页面
- 整合订阅消息功能

#### 第四阶段：集成与测试 (1-2周) - 进行中

- 系统集成测试
- 用户体验测试
- 性能优化
- 内容质量评估与调整

#### 第五阶段：上线与监控 (1周) - 待开始

- 功能发布
- 用户反馈收集
- 性能监控
- 内容质量监控
- 迭代计划制定

### 6.2 代码清理与规范化计划（优先级：中）

- 删除未使用的 TypeScript 相关文件
- 统一 JavaScript 代码风格 (使用 ESLint)
- 优化代码结构和组织
- 增强代码注释和文档

## 七、调试与测试指南

### 7.1 本地调试

1. 使用微信开发者工具打开项目
2. 开启调试模式
3. 使用 Console 面板查看日志
4. 使用 Network 面板监控网络请求
5. 使用 Storage 面板查看本地存储
6. 使用云开发控制台查看云函数和数据库

### 7.2 测试策略

- 单元测试：测试核心算法和工具函数
- 集成测试：测试云函数和页面交互
- 端到端测试：模拟用户操作流程
- 性能测试：测试报告生成性能和加载速度
- 用户体验测试：收集真实用户反馈

## 八、部署与发布流程

### 8.1 开发环境部署

1. 在微信开发者工具中，选择云开发环境
2. 部署云函数
3. 初始化数据库集合
4. 创建必要的索引
5. 上传云存储资源

## 九、版本更新记录

### 版本 0.3.1 更新

#### 情绪分析弹窗优化

- **修复弹窗无法上下滚动问题**
  - 修改了弹窗容器的样式，将`overflow: hidden`改为`overflow-y: auto`
  - 添加`-webkit-overflow-scrolling: touch`属性，使iOS设备上的滚动更加流畅
  - 优化了`emotion-dashboard`组件本身的滚动属性
  - 确保在各种设备上都能正常滚动查看全部内容

- **修复右上角关闭按钮不显示问题**
  - 在对话界面中显示`emotion-dashboard`组件时，明确设置`showCloseButton="{{true}}"`属性
  - 增强关闭按钮的样式，添加背景色和圆角，使其更加明显
  - 为暗黑模式下的关闭按钮添加特殊样式
  - 增加z-index确保关闭按钮始终在最上层

- **修复JavaScript错误**
  - 修复`process.env.NODE_ENV`错误，使用常量替代环境变量
  - 修复`requestAnimationFrame`错误，使用`wx.nextTick`替代浏览器API
  - 增强代码的健壮性，适应小程序环境
  - 优化图表初始化和渲染性能

### 版本 0.3.0 更新

#### 暗夜模式全面优化

- **底部Tab页暗夜模式适配**
  - 修复底部Tab导航栏不随本地缓存darkMode切换的问题
  - 优化TabBar样式切换逻辑，确保在TabBar页面才调用setTabBarStyle
  - 统一Tab栏在暗夜模式下的颜色和样式
  - 增强用户体验，保持全局主题一致性

- **情绪历史界面暗夜模式适配**
  - 修复情绪历史页面不受本地缓存darkMode控制的问题
  - 优化每日报告页面的暗夜模式切换逻辑
  - 确保图表在暗夜模式下正确显示
  - 提升用户体验，保持全局主题一致性

- **暗夜模式机制优化**
  - 统一暗夜模式切换逻辑，优先使用本地缓存设置
  - 增强错误处理，确保在各种情况下都能正确显示主题
  - 优化页面间主题同步，确保切换页面时保持一致的主题

### 版本 0.2.9 更新

#### 用户体验与性能优化

- **聊天功能增强**
  - 优化聊天界面响应速度，减少加载延迟
  - 改进消息发送状态显示机制
  - 增加消息发送失败重试功能
  - 优化历史消息加载策略

- **情绪分析系统升级**
  - 新增多维度情绪分析模型
  - 优化情绪标签分类准确度
  - 添加实时情绪变化追踪
  - 改进情绪数据可视化展示

- **系统性能优化**
  - 优化应用启动速度和资源加载
  - 改进内存管理和缓存策略
  - 增强网络请求错误处理
  - 优化大数据量下的渲染性能

- **用户界面改进**
  - 优化页面布局和视觉效果
  - 增强用户交互反馈
  - 改进移动端适配
  - 优化夜间模式显示效果


### 版本 0.1.9 更新

#### 用户页面与聊天功能优化

- **聊天页面优化**
  - 优化聊天页面的消息加载和渲染性能
  - 修复消息发送后偶尔出现的重复显示问题
  - 改进消息列表滚动机制，提升用户体验
  - 优化输入框高度自适应功能

- **情绪分析功能增强**
  - 改进情绪分析算法，提高准确度
  - 优化情绪标签展示效果
  - 添加情绪变化趋势分析
  - 完善情绪数据存储结构

- **系统稳定性提升**
  - 修复已知的崩溃和卡顿问题
  - 优化内存使用和资源释放
  - 增强错误处理和异常恢复机制
  - 改进日志记录系统

- **文档更新**
  - 更新开发文档，添加最新功能说明
  - 完善API文档和使用示例
  - 更新部署指南和测试文档


### 版本 0.1.8 更新

#### 用户页面优化

- **下拉刷新功能增强**
  - 实现用户页面下拉刷新情绪概览和个性分析数据
  - 使用情绪历史页面的一周内情绪分布数据，保持数据一致性
  - 优化个性分析数据处理，正确处理智谱AI返回的用户画像数据
  - 添加加载提示和成功/失败反馈，提升用户体验

- **数据加载优化**
  - 使用Promise.all并行加载情绪概览和个性分析数据，提高效率
  - 添加详细的日志记录，便于调试
  - 优化用户ID获取逻辑，使用openId作为userId

- **图表刷新机制优化**
  - 添加图表实例检查，如果实例不存在则尝试重新初始化
  - 优化图表数据更新逻辑，确保数据变化时图表正确更新
  - 添加错误处理机制，提高图表显示稳定性

- **文档更新**
  - 更新README.md，添加用户页面下拉刷新功能的相关内容
  - 更新todo.md，添加用户页面下拉刷新功能的相关内容

### 版本 0.1.7 更新

#### 用户画像智谱AI增强

- **智谱AI用户画像功能**
  - 使用智谱AI分析用户对话内容，提取用户的兴趣、偏好、沟通风格和情感模式
  - 生成更准确、更个性化的用户画像
  - 提供更自然、更友好的个性总结描述
  - 实现智能降级机制，当AI分析失败时自动回退到基于规则的分析方法

- **个性特征生成优化**
  - 基于AI分析结果生成更准确的个性特征
  - 使用多维度特征映射，包括沟通风格、情感模式、兴趣和偏好
  - 保留基于情绪记录和兴趣数据的调整逻辑作为备选

- **个性总结生成优化**
  - 使用智谱AI生成更自然、更友好的个性总结
  - 确保生成的描述自然、友好，不像机器分析报告
  - 添加适当的建议或鼓励，提升用户体验

- **用户画像与聊天系统集成**
  - 在聊天页面中获取用户画像数据
  - 将用户画像信息添加到角色系统提示中
  - 使用包含用户画像的系统提示生成更个性化的AI回复
  - 优化云函数，支持自定义系统提示词

- **文档更新**
  - 新增《智谱AI用户画像功能使用指南》文档
  - 更新了项目文档，记录了最新的功能增强

### 版本 0.1.6 更新

#### 情绪波动指数优化

- **情绪波动指数计算功能**
  - 实现了基于真实情绪记录的情绪波动指数计算
  - 替换了原有的硬编码示例数据
  - 考虑了情绪强度变化、情绪类型多样性、情绪极性变化和时间密度等多个维度
  - 提供了更准确的波动级别和波动原因分析

- **波动级别划分**
  - 0-20：非常稳定（绿色）
  - 21-40：稳定（浅绿色）
  - 41-60：中等（黄色）
  - 61-80：波动（橙色）
  - 81-100：剧烈波动（红色）

- **图表显示优化**
  - 根据波动指数值动态设置柱状图颜色
  - 支持多种数据格式的处理
  - 增强了错误处理能力

### 版本 0.1.5 更新

#### 情绪历史页面功能增强

- **数据获取优化**
  - 从数据库获取真实数据，不再使用模拟数据
  - 支持按时间范围筛选数据
  - 支持按角色ID筛选数据
  - 支持分页加载数据

- **本地缓存机制**
  - 实现数据本地缓存，提高页面加载速度
  - 缓存过期时间为30分钟
  - 下拉刷新时清除缓存，强制从数据库获取最新数据
  - 切换时间范围时，优先使用缓存数据，同时在后台从数据库获取最新数据

- **角色名称显示**
  - 在情绪记录中显示对应的角色名称
  - 优先使用记录中的 `roleName` 或 `role_name` 字段
  - 如果记录中没有角色名称，则通过 `roleId` 从 `roles` 集合中查询
  - 使用特殊样式突出显示角色名称
  - 支持暗黑模式下的样式适配

- **角色页面跳转**
  - 点击情绪记录可跳转到对应的角色聊天页面
  - 如果没有角色ID或跳转失败，跳转到情绪分析详情页

- **云函数支持**
  - 添加云函数 `getRoleInfo`，用于获取角色信息
  - 优化 `getEmotionHistory` 云函数，支持更精确的查询条件

### 版本 0.1.4 更新

#### 新增功能

- **情绪历史页面**: 新增了情绪历史页面
  - 实现了时间范围选择功能，支持一周、一个月、三个月、半年、一年等多种时间范围
  - 实现了情绪趋势图表，直观展示不同情绪类型随时间的变化
  - 实现了情绪分布图表，展示各种情绪类型的占比分布
  - 实现了情绪波动指数展示，包括与上周的对比和变化原因分析
  - 实现了情绪日历功能，以日历形式展示每天的主要情绪状态
  - 实现了最近情绪记录列表，展示最近的情绪分析记录
  - 支持暗黑模式，与全局暗黑模式设置同步
  - 采用卡片式设计，符合iOS设计规范
  - 支持下拉刷新加载最新数据

### 版本 0.1.3 更新

#### 优化功能

- **完善情绪分析逻辑**: 优化了小程序端的情绪分析处理
  - 移除了聊天页面中的情绪分析数据处理逻辑
  - 统一使用专门的情绪分析组件进行处理
  - 简化了聊天页面的代码逻辑
  - 提高了系统的一致性和可维护性

### 版本 0.1.2 更新

#### 修复问题

- **修复情绪数据重复处理问题**: 修复了情绪数据被重复处理的问题
  - 优化了情绪数据处理逻辑，智能检测数据是否已经标准化
  - 增强了数据范围判断，避免重复转换导致的异常值
  - 特别优化了valence值的处理，避免出现异常高的值
  - 增加了详细的日志记录，方便调试和问题跟踪

### 版本 0.1.1 更新

#### 修复问题

- **修复情绪波动数据异常问题**: 修复了情绪波动图表数据异常的问题
  - 优化了情绪强度和激动水平的数据处理逻辑，确保不超过100%
  - 优化了雷达图维度的数据处理逻辑，确保在 0-100 范围内
  - 增加了数据范围限制，避免图表显示异常
  - 提高了图表数据的准确性和可靠性

### 版本 0.1.0 更新

#### 修复问题

- **修复情绪分析显示问题**: 修复了情绪维度和情绪历史对比不显示的问题
  - 优化了情绪分析云函数的提示词，增加了英文字段名的支持
  - 修改了情绪分析组件的数据处理逻辑，兼容中文和英文字段
  - 优化了数值转换逻辑，确保图表数据正确显示
  - 增强了系统的兼容性，同时支持中文和英文字段

### 版本 0.0.35 更新

#### 优化功能

- **完善情绪分析逻辑**: 优化了小程序端的情绪分析处理
  - 修改了情绪分析服务，支持直接使用中文情感类型
  - 更新了情绪颜色和图标映射，增加了中文情感类型的支持
  - 优化了聊天页面的情绪分析处理逻辑
  - 兼容了旧版英文情感类型，确保系统向后兼容

### 版本 0.0.34 更新

#### 优化功能

- **完善情绪分析逻辑**: 优化小程序端的情绪分析处理
  - 移除了对云函数返回的情绪分析结果的处理
  - 统一使用专门的情绪分析云函数进行分析
  - 简化了聊天页面的代码逻辑
  - 提高了系统的一致性和可维护性

### 版本 0.0.34 更新

#### 优化功能

- **优化情绪分析提示词**: 优化了情绪分析云函数的提示词
  - 修改了情绪分析结果为直接返回中文情感类型，方便前端进行颜色分类
  - 要求关键词、建议和总结必须使用中文返回，提升用户体验
  - 增强了提示词中对中文输出的要求，确保前端显示一致性

### 版本 0.0.33 更新

#### 优化功能

- **优化情绪分析逻辑**: 移除了聊天回复中的情绪分析功能
  - 禁用了聊天回复中的情绪分析，避免与专门的情绪分析云函数功能重复
  - 情绪分析将完全由专门的云函数 @cloudfunctions\analysis/ 处理
  - 删除了情绪分析相关的提示词和JSON提取代码
  - 简化了代码逻辑，提高了系统效率

### 版本 0.0.32 更新

#### 修复问题

- **修复云函数语法错误**: 修复了导致云函数执行失败的语法错误
  - 修复了`bigmodel.js`和`promptGenerator.js`中的模板字符串语法错误
  - 替换了可能导致JavaScript解析错误的特殊字符
  - 确保云函数可以正常执行
  - 优化了情绪分析指令，与系统提示词保持一致性

### 版本 0.0.31 更新

#### 修复问题

- **优化分段消息逻辑**: 修复了分段消息在列表和编号内容中的处理问题
  - 增强了对列表和编号内容的识别，避免过度分段
  - 增加了对Markdown语法的预处理，移除加粗等标记
  - 增大了最大段落长度，减少过度分段

- **优化系统提示词**: 修改了系统提示词，避免使用Markdown语法
  - 明确指示不要使用Markdown语法，如**加粗**、*斜体*等
  - 指导使用纯文本格式，更符合手机聊天风格
  - 优化了列表和编号内容的表达方式
  - 同步更新了角色提示词生成模板，确保所有生成的角色提示词也避免使用Markdown语法

#### 技术改进

- 优化了分段算法，增强了对特殊格式的处理
- 完善了系统提示词，增加了格式要求部分
- 增强了对用户体验的优化，使对话更加自然

### 版本 0.0.30 更新

#### 修复问题

- **修复历史对话中角色最后回复的消息丢失问题**: 优化了历史消息加载逻辑
  - 添加了分段消息的处理逻辑，确保所有分段消息都能正确加载
  - 优化了消息排序逻辑，确保消息按正确的时间顺序显示
  - 修复了分段消息的时间戳显示问题

- **修复第一个时间戳没有正常显示的问题**: 优化了时间戳显示逻辑
  - 完善了`shouldShowTimestamp`方法，增加了更多判断条件
  - 对欢迎消息和分段消息的第一段进行了特殊处理
  - 优化了分段消息的时间戳显示逻辑

#### 技术改进

- 优化了消息加载逻辑，增强了对分段消息的处理
- 完善了消息排序逻辑，确保消息按正确的时间和分段顺序显示
- 优化了时间戳显示逻辑，增强了用户体验

### 版本 0.0.29 更新

#### 优化内容

- **优化聊天时间戳显示**: 优化了聊天界面的时间戳显示逻辑
  - 在同一时间范围内的连续对话只显示一个时间戳
  - 当消息时间间隔超过5分钟时才显示新的时间戳
  - 欢迎消息始终显示时间戳
  - 优化了分段消息的时间戳显示逻辑

#### 技术改进

- 添加了`shouldShowTimestamp`方法，判断是否显示时间戳
- 优化了消息对象，添加`showTimestamp`属性
- 修改了聊天气泡组件，根据消息的`showTimestamp`属性决定是否显示时间

### 版本 0.0.28 更新

#### 优化内容

- **进一步优化对话简洁度**: 全面优化了AI回复的简洁度，更接近真实手机聊天风格
  - 修改提示词生成器，强调每条消息不超过1-2句话
  - 优化默认系统提示词，强调使用非常简短的对话方式
  - 更激进地分割消息，将最大段落长度降低到80个字符
  - 优化分段算法，优先按句子分割，并更激进地分割长句

#### 技术改进

- 降低了分段阈值，使分段更加激进
- 扩展了分割标点的范围，增加了顺接词等分割点
- 优化了分段算法的逻辑，无论长度如何都先按句子分割

### 版本 0.0.27 更新

#### 优化内容

- **优化提示词生成和分段输出**: 全面优化了提示词生成和分段输出功能
  - 在提示词生成器中添加了对话风格指导，鼓励生成更自然的分段回复
  - 优化了消息分段算法，支持多种分段策略，包括段落、句子和字符数分段
  - 改进了消息显示的延迟计算，根据消息长度和内容复杂度动态调整
  - 增强了“正在输入...”的动画效果，使其更加生动

#### 技术改进

- 优化了消息分段算法，增强了对不同类型文本的处理能力
- 改进了消息显示的延迟计算，增加了随机因子，使其更加自然
- 优化了默认系统提示词，增加了对话风格指导
- 改进了“正在输入...”的动画效果，增强了用户体验

### 版本 0.0.26 更新

#### 新增功能

- **聊天消息分段输出**: 实现了AI回复按自然段落或句子分段显示的功能
  - 将AI回复按自然段落或句子拆分成多个消息气泡
  - 在消息气泡之间添加适当的时间间隔，模拟真实打字的节奏
  - 优化“正在输入...”的状态提示，增强交互的真实感
  - 实现了分段消息在数据库中的正确关联和存储

#### 优化内容

- 优化了聊天体验，使其更加自然，接近真实人类对话
- 改进了消息分段算法，支持多种分段策略
- 优化了消息缓存服务，支持分段消息的存储和加载
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.25 更新

#### 新增功能

- **角色选择页面暗夜模式**: 为角色选择页面添加了暗夜模式支持
  - 参考home和user页面的实现方式，保持风格一致
  - 优化了暗夜模式下的界面元素显示，包括导航栏、状态栏、搜索框、分类标签、角色卡片等
  - 增强了暗夜模式下的可读性，调整了文本和背景颜色
  - 实现了暗夜模式的自动切换，与全局暗夜模式设置同步

#### 优化内容

- 优化了暗夜模式下的视觉效果，提升了用户体验
- 增强了页面与全局设置的联动，确保主题切换的一致性
- 优化了代码结构，提高了可维护性
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.24 更新

#### 优化内容

- **扩大角色编辑页面生活经历文本区域**: 扩大了角色编辑页面中生活经历文本区域的大小
  - 将生活经历文本区域的高度从200rpx增加到400rpx
  - 提供更大的空间输入角色的背景故事和生活经历
  - 改善了用户体验，使用户可以更方便地输入详细的生活经历

### 版本 0.0.23 更新

#### 优化内容

- **优化角色编辑页面按钮位置**: 优化了角色编辑页面中“上一步”和“下一步”按钮的位置
  - 使所有页面的按钮位置保持一致，提高用户体验
  - 统一了按钮的样式和宽度，使界面更加协调
  - 优化了按钮容器的布局，确保在不同步骤中保持一致的高度
  - 添加了占位元素，确保单个按钮和多个按钮时的布局一致

#### 修复问题

- 修复了不同页面按钮位置不一致的问题
- 优化了按钮容器的样式，使其在所有页面中保持一致的高度
- 统一了按钮的样式，删除了不再使用的preview-button样式

### 版本 0.0.22 更新

#### 修复问题

- **彻底修复角色编辑页面提示词卡片显示undefined问题**: 彻底修复了角色编辑页面提示词卡片下方显示"undefined..."的问题
  - 全面重构了提示词卡片的渲染逻辑，使用block标签包裹条件渲染内容
  - 对所有条件判断增加了字符串长度检查，确保只在提示词非空时显示
  - 增强了类型检查，确保提示词始终是字符串类型且非null
  - 添加了日志记录，方便跟踪提示词的类型和值

#### 优化内容

- 优化了卡片样式，添加了overflow属性防止内容溢出
- 添加了text-overflow属性，确保文本溢出时显示省略号
- 增强了数据类型处理，提高了代码的健壮性
- 改进了用户界面的显示效果，提升了用户体验
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.21 更新

#### 修复问题

- **修复角色编辑页面提示词卡片显示undefined问题**: 修复了角色编辑页面提示词卡片下方显示"undefined..."的问题
  - 完善了提示词卡片的条件渲染逻辑，只在提示词存在且非空时显示预览
  - 增强了类型检查，确保提示词始终是字符串类型
  - 消除了卡片下方显示的异常文本

#### 优化内容

- 增强了数据类型处理，提高了代码的健壮性
- 改进了用户界面的显示效果，提升了用户体验
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.19 更新

#### 修复问题

- **修复提示词编辑页面保存失败问题**: 修复了提示词编辑页面保存提示词时出现“没有权限更新此角色”的问题
  - 在提示词编辑页面中添加了用户ID的传递
  - 增强了错误处理，显示更详细的错误信息
  - 确保了用户可以正常保存和编辑自己创建的角色提示词

#### 优化内容

- 增强了用户权限验证，确保用户只能编辑自己的角色
- 改进了错误提示的友好性，提供更清晰的错误信息
- 增强了日志记录，方便问题跟踪和调试
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.18 更新

#### 修复问题

- **修复提示词编辑页面角色名称乱码问题**: 修复了提示词编辑页面中角色名称显示为URL编码的问题
  - 在提示词编辑页面中添加了对角色名称的解码处理
  - 使用decodeURIComponent函数对传入的角色名称进行解码
  - 确保了角色名称在页面上正确显示

#### 优化内容

- 增强了页面间数据传递的安全性
- 提高了用户体验，确保了界面显示的一致性
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.17 更新

#### 新增功能

- **角色编辑页面文本区域优化**: 优化了角色编辑页面的文本区域高度
  - 缩短了“说话风格”文本区域的高度，从400rpx减少到120rpx
  - 缩短了“生活经历”文本区域的高度，从400rpx减少到200rpx
  - 为不同类型的文本区域设置了不同的高度，更符合实际使用需求

#### 优化内容

- 优化了页面空间利用，减少了不必要的空白区域
- 提高了表单填写的效率，减少了滚动操作
- 使界面更加紧凑，提升了用户体验
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.16 更新

#### 新增功能

- **提示词卡片化设计**: 将角色编辑页面的提示词模板改为卡片形式
  - 采用卡片式设计，点击卡片可跳转到提示词编辑页面
  - 添加了图标字体，增强视觉效果
  - 实现了提示词预览功能，显示提示词的前50个字符
  - 添加了点击动画效果，增强交互体验

#### 优化内容

- 简化了角色编辑页面的提示词模块，使界面更加简洁清爽
- 提供了更直观的交互方式，提高了用户体验
- 增强了视觉设计，使界面更加现代化
- 优化了提示词的展示方式，方便用户快速了解提示词的内容
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.15 更新

#### 新增功能

- **提示词专业编辑器**: 新增了专门的提示词编辑页面
  - 创建了新的提示词编辑页面，提供更好的编辑体验
  - 实现了提示词的加载、编辑和保存功能
  - 添加了提示词编写指南，帮助用户编写更好的提示词
  - 支持重新生成和清空提示词的功能
  - 实现了保存后自动返回角色编辑页面的功能

- **角色编辑页面提示词模块优化**: 优化了角色编辑页面的提示词模块
  - 添加了“高级编辑”按钮，可以跳转到专业的提示词编辑器
  - 优化了提示词模板的布局和样式
  - 增强了提示词编辑的用户体验

#### 优化内容

- 提供了更专业的提示词编辑环境，提高了用户体验
- 增强了提示词编辑的可用性，方便用户编写复杂的提示词
- 添加了提示词编写指南，帮助用户理解如何编写有效的提示词
- 优化了页面间的跳转和数据传递，提高了用户操作流程的连贯性
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.14 更新

#### 新增功能

- **角色编辑提示词模板优化**: 优化了角色编辑页面的提示词模板显示
  - 增加了提示词模板文本区域的高度，从200rpx增加到400rpx
  - 添加了auto-height属性，允许文本区域根据内容自动增长
  - 添加了white-space: pre-wrap属性，保留空白符和换行符
  - 去除了文本长度限制，允许输入任意长度的提示词
  - 优化了行高和内边距，提高可读性

#### 优化内容

- 提高了提示词模板的可读性和编辑体验
- 确保提示词能够完整显示，方便用户编辑和查看
- 优化了文本区域的样式，使其更适合显示长文本
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.13 更新

#### 新增功能

- **角色编辑自动跳转优化**: 优化了角色编辑页面的保存后跳转逻辑
  - 修改了保存成功后的提示方式，使用更简洁的Toast提示替代对话框
  - 实现了保存成功后自动跳转回角色选择页面，无需用户点击确认按钮
  - 添加了延时跳转，确保用户能看到成功提示
  - 保留了错误处理逻辑，确保在跳转失败时有适当的备选方案

#### 优化内容

- 简化了用户操作流程，提升了用户体验
- 减少了用户需要点击的次数，使操作更加流畅
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.12 更新

#### 新增功能

- **角色编辑功能修复**: 修复了角色选择页面中编辑角色按钮的跳转问题
  - 修改了角色编辑页面的跳转逻辑，使用 `wx.switchTab` 方法跳转回角色选择页面
  - 修复了保存成功后的跳转逻辑，确保正确返回到角色选择页面
  - 修复了取消编辑时的跳转逻辑，确保正确返回到角色选择页面
  - 增强了错误处理，确保在跳转失败时有适当的备选方案

- **角色编辑页面加载优化**: 优化了角色编辑页面的角色数据加载逻辑
  - 修复了云函数初始化问题，使用 `wx.cloud.DYNAMIC_CURRENT_ENV` 替代 `cloud.DYNAMIC_CURRENT_ENV`
  - 增强了角色数据加载的日志记录，方便诊断问题
  - 优化了错误处理，在加载失败时显示更详细的错误信息
  - 添加了更多的日志记录点，方便诊断问题

#### 优化内容

- 优化了角色编辑页面与角色选择页面的连接，提升了用户体验
- 增强了角色编辑页面的错误处理和日志记录，方便诊断和解决问题
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.11 更新

#### 新增功能

- **首页心情树洞跳转优化**: 优化了首页上的心情树洞跳转功能
  - 使用 `wx.switchTab` 方法跳转到角色选择tab页面，替代原来的 `wx.navigateTo`
  - 优化了跳转逻辑，增强了错误处理
  - 修改了“暂无最近对话”时的“开始聊天”按钮文本，改为“选择角色聊天”
  - 新增了跳转失败时的提示信息

#### 优化内容

- 优化了首页与角色选择页面的连接，提升了用户体验
- 更新了项目文档，记录了最新的修改内容
- 新增了《Tab页修改说明》文档，详细说明了将心情树洞tab页改为role-select页面的相关内容

### 版本 0.0.10 更新

#### 修复问题

- **角色选择页面修复**: 修复了 `@miniprogram\pages\role-select/` 角色选择页面的显示问题
  - 修复了角色显示不全的问题，兼容不同的数据结构
  - 优化了分类过滤逻辑，增强了对不同分类名称的兼容性
  - 扩展了搜索功能，现在可以根据角色名称、描述和关系类型进行搜索
  - 增强了数据处理的健壮性，确保在不同数据结构下都能正确显示

#### 优化内容

- 优化了角色数据处理逻辑，增强了对不同字段名称的兼容性
- 改进了分类过滤逻辑，增加了对相似分类的支持
- 扩展了搜索功能，提升了用户体验
- 更新了项目文档，记录了最新的修复内容

### 版本 0.0.9 更新

#### 新增功能

- **用户资料页面重构**: 完全重构了 `@miniprogram\pages\user\profile` 用户资料页面
  - 采用 Material Design 3 设计规范，结合 iOS 设计指南的简洁性
  - 使用卡片式布局，提供清晰的视觉层次
  - 优化表单交互体验，提供即时反馈
  - 增强用户画像和性格分析展示
  - 优化头像上传功能
  - 改进表单验证和错误提示
  - 添加数据加载状态和动画
  - 支持深色模式

#### 优化内容

- 使用自定义导航栏，与微信胶囊按钮齐平
- 优化了表单元素的视觉效果，提供更好的状态反馈
- 添加了安全区域适配，确保在各种设备上的良好体验
- 优化了云函数调用，提高数据加载效率
- 更新了项目文档，记录了最新的重构内容

### 版本 0.0.8 更新

#### 新增功能

- **角色创建页面优化**: 优化了 `@miniprogram\pages\role-editor/` 角色创建页面
  - 优化了提示词预览弹窗的样式，解决了内容偏右的问题
  - 使用自定义导航栏，与微信胶囊按钮齐平
  - 删除了右上角的保存按钮，改为在预览提示词后保存
  - 修复了取消按钮无法退出的问题
  - 优化了返回逻辑，现在可以正确返回到角色选择页面

- **角色选择页面优化**: 优化了 `@miniprogram\pages\role-select/` 角色选择页面
  - 使用自定义导航栏，与微信胶囊按钮齐平
  - 修复了返回按钮不生效的问题
  - 优化了页面布局和样式，提升用户体验
  - 增强了导航逻辑的健壮性，确保用户能够成功返回

#### 优化内容

- 优化了导航栏样式，使其更符合iOS设计规范
- 优化了按钮的可点击区域，提升用户体验
- 优化了弹窗样式，使其更加美观和易用
- 更新了项目文档，记录了最新的修改内容

### 版本 0.0.7 更新

#### 新增功能

- **用户中心页面重构**: 完全重构了用户中心页面
  - 新增了情绪概览和个性分析模块
  - 优化了用户统计数据展示
  - 重新设计了功能入口列表
  - 添加了情绪历史入口
  - 改进了页面整体布局和视觉效果

- **用户画像功能**: 新增了用户画像功能
  - 实现了基于用户对话和情绪数据的个性分析
  - 添加了用户兴趣标签展示
  - 提供了个性特征雷达图可视化

- **情绪云函数**: 新增了情绪云函数
  - 实现了获取情绪概览功能
  - 实现了获取情绪历史功能
  - 提供了情绪数据处理和分析能力

#### 优化内容

- 优化了用户云函数，添加了获取用户画像功能
- 完善了用户数据库设计，增加了用户兴趣和配置表
- 更新了项目文档，增加了用户模块的详细说明

### 版本 0.0.6 更新

#### 修复问题

- **角色选择页面修复**: 全面修复了 `@miniprogram\pages\role-select/` 目录下的多个问题
  - 修复了滚动逻辑问题，解决了出现两个滚动条的问题
  - 修复了角色分类显示问题，现在可以在过滤后的分类 tab 下正确显示角色
  - 修复了全部角色显示问题，现在可以在全部角色下显示所有角色，而不仅仅是推荐角色
  - 修复了长按角色后的操作功能，包括查看详情、编辑角色和删除角色
  - 增强了错误处理和异常情况的处理，提高了代码的健壮性

- **图片服务修复**: 修复了 `imageService.js` 中的问题
  - 解决了 `TypeError: Cannot read property 'globalData' of undefined` 错误
  - 移除了模块顶层的 `getApp()` 调用，避免在小程序初始化完成之前执行
  - 在每个需要使用 `app` 的函数内部调用 `getApp()`
  - 添加了对 `app` 和 `app.globalData` 的存在性检查
  - 增强了错误处理和日志记录

### 版本 0.0.5 更新

#### 新增功能

- **新版角色管理云函数**: 新增 `roles` 云函数，替代旧版 `role` 云函数
  - 实现了角色的创建、查询、更新、删除等完整功能
  - 添加了角色使用统计和消息统计功能
  - 支持初始化系统预设角色
  - 完善了错误处理和日志记录
- **角色选择页面优化**: 修复了角色选择页面无法显示角色的问题
  - 使用新的 `roles` 云函数替代旧版 `role` 云函数
  - 添加了测试数据作为备用，确保即使云函数调用失败也能显示角色
- **聊天界面优化**: 修复了聊天界面的布局问题
  - 修复了头部超出限制的问题
  - 添加了安全区域适配，确保在各种设备上正确显示
  - 优化了底部输入框的样式

#### 修复问题

- **情绪分析界面优化**: 修复了情绪分析界面中的两个问题
  - 当没有次要情绪数据时，现在只显示主要情绪，不再显示次要情绪的占位符
  - 修复了情绪图标显示问题，使用内联SVG替代外部字体图标，确保图标在各种环境下正确显示
- **ECharts图表优化**: 解决了图表随页面滚动而移动位置的问题
  - 优化了图表容器样式，使用相对定位和明确的尺寸
  - 添加了滚动事件处理，确保图表位置稳定
  - 使用延时初始化，确保组件完全渲染后再初始化图表

#### 文档更新

- **新增 `roles` 云函数使用文档**: 添加了详细的使用文档，包括功能列表、数据结构、接口说明和使用示例
- **新增 `roles` 云函数部署说明**: 添加了详细的部署说明，包括部署步骤、数据库配置、权限设置和测试方法

- **使用文档**: 新增了三份详细的使用文档
  - `情绪分析功能使用指南.md`: 面向普通用户的功能使用说明
  - `ECharts组件使用指南.md`: 面向开发者的技术文档，详细介绍了如何在项目中使用ECharts组件
  - `情绪分析云函数调用指南.md`: 面向开发者的云函数调用文档，详细说明了情绪分析云函数的参数和返回值格式

### 版本 0.0.4 更新

#### 新增功能

- **欢迎页面**: 新增了应用欢迎页面，展示应用的核心功能和价值
- **一键微信登录**: 在欢迎页面实现了微信一键登录功能，直接调用云函数进行登录，并正确缓存token和userInfo到本地存储，提升用户体验
- **协议页面**: 新增了服务协议和隐私协议页面，符合小程序平台规范

#### 优化内容

- 优化了页面跳转逻辑，登录成功后自动跳转到主页
- 改进了登录组件的交互体验，增加了动画效果
- 优化了页面样式，采用渐变背景和现代化设计

### 版本 0.0.3 生产环境发布

1. 完成所有测试
2. 更新版本号 (app.json)
3. 在微信开发者工具中选择"上传"
4. 填写版本描述
5. 提交审核
6. 发布新版本

### 版本 0.0.2 更新维护

- 定期检查云函数运行状态
- 监控数据库容量和性能
- 收集用户反馈进行迭代
- 定期备份重要数据

## 十、技术问题与解决方案

### 10.1 关键词提取与权重计算精度问题

**挑战**：简单的词频统计或TF-IDF可能无法准确反映关键词在情感表达中的重要性。

**解决方案**：
- 采用多因素综合权重模型（上下文、时间、情感关联、领域相关性）
- 对于常用词和停用词，使用自定义的过滤规则
- 考虑词语在句子中的位置和上下文重要性

### 10.2 兴趣领域分类的准确性

**挑战**：自动将关键词聚类到合适的兴趣领域并不容易，尤其是对于跨领域词汇。

**解决方案**：
- 使用预训练的词向量模型进行初步聚类
- 结合用户历史兴趣数据进行调整
- 设计适当的衰减机制，平衡新兴趣与持续兴趣
- 对未能明确分类的关键词，设置保守策略避免错误分类

### 10.3 LLM输出质量控制

**挑战**：确保LLM生成的内容质量一致、有价值且符合预期格式。

**解决方案**：
- 精心设计结构化提示词，明确输出格式和内容要求
- 实现输出验证机制，检查输出是否符合格式规范
- 设置内容安全过滤，避免不适当的建议或内容
- 准备备选回退方案，当LLM输出不满足要求时使用

### 10.4 性能与资源消耗

**挑战**：报告生成涉及多步骤计算和外部API调用，可能导致性能问题。

**解决方案**：
- 采用分阶段计算策略，将计算任务拆分为多个子任务
- 实现结果缓存机制，避免重复计算
- 设置合理的超时和重试机制
- 使用队列管理批量报告生成任务
- 对长期非活跃用户采用按需生成策略

### 10.5 ECharts 组件集成问题

**挑战**：在微信小程序中集成 ECharts 图表库时，可能遇到文件缺失和编译错误问题。

**解决方案**：
- 确保 `ec-canvas` 组件目录结构完整，包含所有必要文件
- 创建空的 `echarts.wxss` 和 `wx-echarts.js` 文件以解决编译错误
- 正确配置组件引用路径，确保在 JSON 文件中正确声明
- 在 `app.js` 中全局挂载 echarts 对象，方便各页面使用
- 使用 `lazyLoad` 模式初始化图表，提高性能

## 十一、附录

### 11.1 API参考

#### 云函数API

**analysis - 基于智谱AI的情感分析与关键词提取**
- 功能：分析文本情感和提取关键词
- 参数：
  - 情感分析：`{ type: 'emotion', text: '文本内容', saveRecord: true }`
  - 关键词提取：`{ type: 'keywords', text: '文本内容', topK: 10 }`
  - 词向量获取：`{ type: 'word_vectors', texts: ['文本1', '文本2'] }`
  - 聚类分析：`{ type: 'cluster', text: '文本内容', threshold: 0.7 }`
  - 用户兴趣分析：`{ type: 'user_interests', messages: ['消息1', '消息2'] }`
- 返回：根据类型不同返回相应结果

**generateDailyReport**
- 功能：生成用户每日报告
- 参数：`{ userId, date }`
- 返回：`{ success, reportId, error? }`

**getUserReport**
- 功能：获取用户特定日期的报告
- 参数：`{ userId, date }`
- 返回：`{ success, report, error? }`

**sendReportNotification**
- 功能：发送报告通知
- 参数：`{ userId, reportId }`
- 返回：`{ success, error? }`

**roles - 角色管理与智能交互云函数**

功能：提供全面的角色管理功能，包括角色的创建、查询、更新、删除、使用统计等基础功能，以及提示词生成、记忆管理和用户画像分析等高级功能

调用方式：
```javascript
wx.cloud.callFunction({
  name: 'roles',
  data: {
    action: '操作类型', // 必填参数
    // 其他参数根据action不同而变化
  }
})
```

支持的操作类型：

| action                 | 说明             | 参数                                                                                      | 返回值                                                    |
| ---------------------- | ---------------- | ----------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| `getRoles`             | 获取角色列表     | `userId`: 用户ID(可选)<br>`category`: 分类(可选)<br>`limit`: 限制数量<br>`skip`: 跳过数量 | `success`: 是否成功<br>`roles`: 角色列表<br>`total`: 总数 |
| `getRoleDetail`        | 获取角色详情     | `roleId`: 角色ID                                                                          | `success`: 是否成功<br>`role`: 角色详情                   |
| `createRole`           | 创建角色         | `role`: 角色信息对象<br>`userId`: 用户ID                                                  | `success`: 是否成功<br>`roleId`: 新角色ID                 |
| `updateRole`           | 更新角色         | `roleId`: 角色ID<br>`role`: 角色信息对象<br>`userId`: 用户ID                              | `success`: 是否成功                                       |
| `deleteRole`           | 删除角色         | `roleId`: 角色ID<br>`userId`: 用户ID                                                      | `success`: 是否成功                                       |
| `updateUsage`          | 更新角色使用统计 | `roleId`: 角色ID<br>`userId`: 用户ID                                                      | `success`: 是否成功                                       |
| `getMessageStats`      | 获取角色消息统计 | `roleIds`: 角色ID数组<br>`userId`: 用户ID                                                 | `success`: 是否成功<br>`stats`: 统计数据                  |
| `initialize`           | 初始化角色数据   | 无                                                                                        | `success`: 是否成功<br>`result`: 初始化结果               |
| `generatePrompt`       | 生成角色提示词   | `roleId`: 角色ID<br>`roleInfo`: 角色信息(可选)<br>`currentContext`: 当前上下文(可选)      | `success`: 是否成功<br>`prompt`: 生成的提示词             |
| `extractMemories`      | 从对话中提取记忆 | `roleId`: 角色ID<br>`messages`: 消息数组                                                  | `success`: 是否成功<br>`memories`: 提取的记忆             |
| `updateUserPerception` | 更新用户画像     | `roleId`: 角色ID<br>`userId`: 用户ID<br>`messages`: 消息数组                              | `success`: 是否成功<br>`userPerception`: 用户画像         |

角色数据结构：
```javascript
{
  _id: "角色ID",
  name: "角色名称",
  avatar: "头像URL",
  description: "角色描述",
  category: "分类", // emotion(情感支持)、psychology(心理咨询)、life(生活伙伴)、career(职场导师)
  personality: ["性格特点1", "性格特点2"],
  background: "背景故事",
  speaking_style: "说话风格",
  welcome: "欢迎消息",
  system_prompt: "系统提示词",
  creator: "创建者ID", // 系统角色为"system"
  createTime: Date,
  updateTime: Date,
  status: 1 // 1:启用 0:禁用
}
```

示例：
```javascript
// 获取角色列表示例
try {
  const result = await wx.cloud.callFunction({
    name: 'roles',
    data: {
      action: 'getRoles',
      userId: app.globalData.userInfo.userId,
      category: 'emotion' // 只获取情感支持类角色
    }
  });

  if (result && result.result && result.result.success) {
    const roles = result.result.roles;
    console.log('获取到的角色列表:', roles);
  }
} catch (error) {
  console.error('调用云函数失败:', error);
}
```

### 10.2 示例代码

#### 报告页面加载

```javascript
// pages/dailyReport/dailyReport.js
Page({
  data: {
    report: null,
    date: '',
    loading: true
  },

  onLoad: function() {
    const today = new Date();
    const dateStr = this.formatDate(today);
    this.setData({ date: dateStr });
    this.loadReport(dateStr);
  },

  loadReport: async function(date) {
    this.setData({ loading: true });
    try {
      const { result } = await wx.cloud.callFunction({
        name: 'getUserReport',
        data: { date }
      });

      if (result.success) {
        this.setData({
          report: result.report,
          loading: false
        });
        this.initCharts();
      } else {
        this.setData({
          report: null,
          loading: false
        });
        wx.showToast({
          title: '暂无报告',
          icon: 'none'
        });
      }
    } catch (error) {
      console.error('加载报告失败:', error);
      this.setData({ loading: false });
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
    }
  },

  formatDate: function(date) {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
});
```

### 10.3 示例报告内容

**今日心情总结**：
> 今天你的情绪以平静为主(占比65%)，但下午出现了一些波动，短暂出现了些许焦虑情绪。与昨日相比，今天整体情绪略有上升，情绪稳定性良好，波动指数较低(32/100)。

**关注点分析**：
> 今日你主要关注学习和工作相关话题，特别是提到了项目进度和考试安排。这些话题引发了短暂的焦虑情绪，但你很好地保持了整体平静。

**今日运势**：
* 今日宜：整理学习计划
* 今日忌：临时加班熬夜
* 幸运领域：知识学习

**小建议**：
1. 给项目进度制定更细化的时间表，将大任务拆分为小目标，减轻压力感。
2. 尝试在学习间隙进行5-10分钟的冥想或深呼吸，帮助保持平静状态。

**鼓励语**：
> 生活就像编程，bug不可避免，但你总能找到解决方案。今天的平静是你内在力量的体现！
