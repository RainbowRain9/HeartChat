<!-- pages/chatBot/chatBot.wxml -->
<!-- 登录提示 -->
<view class="login-tip" wx:if="{{!isLoggedIn}}">
  <text>请先登录后使用</text>
  <button class="login-btn" bindtap="handleLogin">立即登录</button>
</view>
<!-- 角色选择按钮 -->
<view class="role-select-btn" wx:if="{{isLoggedIn}}" bindtap="showRoleSelector">
  <image class="current-role-avatar" src="{{currentRole.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
  <view class="current-role-info">
    <text class="current-role-name">{{currentRole.role_name || '选择角色'}}</text>
    <text class="current-role-hint">{{currentRole.role_name ? '点击切换' : '请选择一个倾诉对象'}}</text>
  </view>
  <view class="role-arrow"></view>
</view>
<!-- 双视图容器 -->
<view class="dual-view-container" wx:if="{{isLoggedIn}}" bindtouchstart="handleTouchStart" bindtouchmove="handleTouchMove" bindtouchend="handleTouchEnd">
  <!-- 分屏指示器 -->
  <view class="view-indicator">
    <view class="indicator-dot {{currentView === 'chat' ? 'active' : ''}}"></view>
    <view class="indicator-dot {{currentView === 'analysis' ? 'active' : ''}}"></view>
  </view>
  <!-- 主对话视图 -->
  <view class="chat-view {{showAnalysis ? 'shrink' : ''}}" style="width: {{chatViewWidth}}%">
    <!-- 对话界面 -->
    <view class="chat-container">
      <!-- 情感分析按钮 -->
      <view class="emotion-analyze-btn" bindtap="showEmotionPanel">
        <text class="emotion-icon">😊</text>
        <text>情感分析</text>
      </view>
      <agent-ui id="agentUI" agentConfig="{{agentConfig}}" showBotAvatar="{{showBotAvatar}}" chatMode="{{chatMode}}" modelConfig="{{modelConfig}}" bindtapRoleInfo="showRoleSelector" bindmessageChange="onMessageChange" />
    </view>
  </view>
  <!-- 情感分析视图 -->
  <view class="analysis-view {{showAnalysis ? 'expand' : ''}}" style="width: {{100 - chatViewWidth}}%">
    <view class="view-handle" bindtap="toggleAnalysisView">
      <view class="handle-icon"></view>
    </view>
    <!-- 新的情感分析组件 -->
    <emotion-analysis
      show="{{true}}"
      emotion="{{emotionAnalysis}}"
      userId="{{userInfo.userId}}"
      roleId="{{currentRole._id}}"
      darkMode="{{darkMode}}"
      bind:save="saveEmotion"
      bind:share="shareEmotion"
      bind:close="toggleAnalysisView">
    </emotion-analysis>
  </view>
</view>
<!-- 角色选择器弹窗 -->
<view class="role-selector {{showRoleSelector ? 'show' : ''}}" bindtap="hideRoleSelector">
  <view class="role-list-container" catchtap="stopPropagation">
    <view class="role-header">
      <text class="role-title">选择倾诉对象</text>
      <view class="header-btns">
        <button class="close-btn" catchtap="hideRoleSelector">
          <image src="/assets/images/close.png" mode="aspectFill" />
        </button>
      </view>
    </view>
    <view class="role-grid" wx:if="{{roleList.length > 0}}">
      <!-- 工作关系 -->
      <view class="role-category">
        <text class="category-title">工作关系</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'work'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || '未命名角色'}}</text>
              <text class="role-relation">{{role.relationship || '关系未设置'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">使用{{role.usageCount}}次</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 家庭关系 -->
      <view class="role-category">
        <text class="category-title">家庭关系</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'family'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || '未命名角色'}}</text>
              <text class="role-relation">{{role.relationship || '关系未设置'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">使用{{role.usageCount}}次</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 社交关系 -->
      <view class="role-category">
        <text class="category-title">社交关系</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'social'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || '未命名角色'}}</text>
              <text class="role-relation">{{role.relationship || '关系未设置'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">使用{{role.usageCount}}次</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 其他关系 -->
      <view class="role-category">
        <text class="category-title">其他</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'other'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || '未命名角色'}}</text>
              <text class="role-relation">{{role.relationship || '关系未设置'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">使用{{role.usageCount}}次</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="empty-role-tip" wx:else>
      <image class="empty-icon" src="/assets/images/empty-role.png" mode="aspectFit"></image>
      <text class="empty-text">暂无角色，点击下方按钮创建</text>
      <button class="create-role-btn" bindtap="goToRoleManage">创建新角色</button>
    </view>
    <!-- 浮动管理角色按钮 -->
    <button class="role-manage-btn" catchtap="goToRoleManage" wx:if="{{roleList.length > 0}}">
      <text class="manage-icon">✏️</text>
      <text>管理角色</text>
    </button>
  </view>
</view>

