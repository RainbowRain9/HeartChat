<!-- pages/chatBot/chatBot.wxml -->
<!-- ç™»å½•æç¤º -->
<view class="login-tip" wx:if="{{!isLoggedIn}}">
  <text>è¯·å…ˆç™»å½•åä½¿ç”¨</text>
  <button class="login-btn" bindtap="handleLogin">ç«‹å³ç™»å½•</button>
</view>
<!-- è§’è‰²é€‰æ‹©æŒ‰é’® -->
<view class="role-select-btn" wx:if="{{isLoggedIn}}" bindtap="showRoleSelector">
  <image class="current-role-avatar" src="{{currentRole.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
  <view class="current-role-info">
    <text class="current-role-name">{{currentRole.role_name || 'é€‰æ‹©è§’è‰²'}}</text>
    <text class="current-role-hint">{{currentRole.role_name ? 'ç‚¹å‡»åˆ‡æ¢' : 'è¯·é€‰æ‹©ä¸€ä¸ªå€¾è¯‰å¯¹è±¡'}}</text>
  </view>
  <view class="role-arrow"></view>
</view>
<!-- åŒè§†å›¾å®¹å™¨ -->
<view class="dual-view-container" wx:if="{{isLoggedIn}}" bindtouchstart="handleTouchStart" bindtouchmove="handleTouchMove" bindtouchend="handleTouchEnd">
  <!-- åˆ†å±æŒ‡ç¤ºå™¨ -->
  <view class="view-indicator">
    <view class="indicator-dot {{currentView === 'chat' ? 'active' : ''}}"></view>
    <view class="indicator-dot {{currentView === 'analysis' ? 'active' : ''}}"></view>
  </view>
  <!-- ä¸»å¯¹è¯è§†å›¾ -->
  <view class="chat-view {{showAnalysis ? 'shrink' : ''}}" style="width: {{chatViewWidth}}%">
    <!-- å¯¹è¯ç•Œé¢ -->
    <view class="chat-container">
      <!-- æƒ…æ„Ÿåˆ†ææŒ‰é’® -->
      <view class="emotion-analyze-btn" bindtap="showEmotionPanel">
        <text class="emotion-icon">ğŸ˜Š</text>
        <text>æƒ…æ„Ÿåˆ†æ</text>
      </view>
      <agent-ui id="agentUI" agentConfig="{{agentConfig}}" showBotAvatar="{{showBotAvatar}}" chatMode="{{chatMode}}" modelConfig="{{modelConfig}}" bindtapRoleInfo="showRoleSelector" bindmessageChange="onMessageChange" />
    </view>
  </view>
  <!-- æƒ…æ„Ÿåˆ†æè§†å›¾ -->
  <view class="analysis-view {{showAnalysis ? 'expand' : ''}}" style="width: {{100 - chatViewWidth}}%">
    <view class="view-handle" bindtap="toggleAnalysisView">
      <view class="handle-icon"></view>
    </view>
    <!-- æ–°çš„æƒ…æ„Ÿåˆ†æç»„ä»¶ -->
    <emotion-analysis
      show="{{true}}"
      emotion="{{emotionAnalysis}}"
      userId="{{userInfo.userId}}"
      roleId="{{currentRole._id}}"
      darkMode="{{darkMode}}"
      bind:save="saveEmotion"
      bind:share="shareEmotion"
      bind:close="toggleAnalysisView">
    </emotion-analysis>
  </view>
</view>
<!-- è§’è‰²é€‰æ‹©å™¨å¼¹çª— -->
<view class="role-selector {{showRoleSelector ? 'show' : ''}}" bindtap="hideRoleSelector">
  <view class="role-list-container" catchtap="stopPropagation">
    <view class="role-header">
      <text class="role-title">é€‰æ‹©å€¾è¯‰å¯¹è±¡</text>
      <view class="header-btns">
        <button class="close-btn" catchtap="hideRoleSelector">
          <image src="/assets/images/close.png" mode="aspectFill" />
        </button>
      </view>
    </view>
    <view class="role-grid" wx:if="{{roleList.length > 0}}">
      <!-- å·¥ä½œå…³ç³» -->
      <view class="role-category">
        <text class="category-title">å·¥ä½œå…³ç³»</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'work'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || 'æœªå‘½åè§’è‰²'}}</text>
              <text class="role-relation">{{role.relationship || 'å…³ç³»æœªè®¾ç½®'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">ä½¿ç”¨{{role.usageCount}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å®¶åº­å…³ç³» -->
      <view class="role-category">
        <text class="category-title">å®¶åº­å…³ç³»</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'family'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || 'æœªå‘½åè§’è‰²'}}</text>
              <text class="role-relation">{{role.relationship || 'å…³ç³»æœªè®¾ç½®'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">ä½¿ç”¨{{role.usageCount}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¤¾äº¤å…³ç³» -->
      <view class="role-category">
        <text class="category-title">ç¤¾äº¤å…³ç³»</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'social'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || 'æœªå‘½åè§’è‰²'}}</text>
              <text class="role-relation">{{role.relationship || 'å…³ç³»æœªè®¾ç½®'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">ä½¿ç”¨{{role.usageCount}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å…¶ä»–å…³ç³» -->
      <view class="role-category">
        <text class="category-title">å…¶ä»–</text>
        <view class="category-content">
          <view class="role-item {{currentRole._id === role._id ? 'active' : ''}}"
                wx:for="{{roleList}}"
                wx:key="_id"
                wx:for-item="role"
                wx:if="{{role.category === 'other'}}"
                data-id="{{role._id}}"
                bindtap="switchRole">
            <image class="role-avatar" src="{{role.avatar_url || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="role-info">
              <text class="role-name">{{role.role_name || 'æœªå‘½åè§’è‰²'}}</text>
              <text class="role-relation">{{role.relationship || 'å…³ç³»æœªè®¾ç½®'}}</text>
              <text class="role-usage" wx:if="{{role.usageCount > 0}}">ä½¿ç”¨{{role.usageCount}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="empty-role-tip" wx:else>
      <image class="empty-icon" src="/assets/images/empty-role.png" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— è§’è‰²ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»º</text>
      <button class="create-role-btn" bindtap="goToRoleManage">åˆ›å»ºæ–°è§’è‰²</button>
    </view>
    <!-- æµ®åŠ¨ç®¡ç†è§’è‰²æŒ‰é’® -->
    <button class="role-manage-btn" catchtap="goToRoleManage" wx:if="{{roleList.length > 0}}">
      <text class="manage-icon">âœï¸</text>
      <text>ç®¡ç†è§’è‰²</text>
    </button>
  </view>
</view>

