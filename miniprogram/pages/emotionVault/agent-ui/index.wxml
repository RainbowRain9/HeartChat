<!-- agent ui 组件根容器 -->
<view class="agent-ui">
  <!-- 聊天对话区 - 优化滚动和布局 -->
  <scroll-view
    class="main {{manualScroll ? 'manual-scroll' : ''}}"
    bindwheel="onWheel"
    enhanced="{{true}}"
    bindscroll="onScroll"
    binddragstart="handleScrollStart"
    style="height: {{windowInfo.windowHeight-footerHeight}}px;"
    scroll-y="{{true}}"
    scroll-top="{{viewTop}}"
    scroll-into-view="{{ scrollTo }}"
    lower-threshold="1"
    bindscrolltolower="handleScrollToLower"
    show-scrollbar="{{false}}"
    refresher-enabled="{{showPullRefresh}}"
    refresher-threshold="{{80}}"
    bindrefresherrefresh="handelRefresh"
    refresher-triggered="{{triggered}}"
    bounces="{{false}}"
  >
    <!-- 下拉刷新提示 -->
    <view wx:if="{{chatMode === 'bot' && showPullRefresh}}" class="tips">
      <text class="tips-text">{{refreshText}}</text>
      <image wx:if="{{triggered}}" class="tips-loading" src="./imgs/loading.svg" mode="aspectFit"/>
    </view>

    <!-- 模型信息展示 -->
    <view wx:if="{{chatMode === 'model'}}" class="model-info">
      <image src="{{bot.avatar||modelConfig.logo}}" mode="aspectFill" class="model-avatar" />
      <text class="model-name">{{chatMode==='bot'?bot.name:modelConfig.modelProvider}}</text>
      <text class="model-welcome">{{chatMode==='bot'?"":modelConfig.welcomeMsg}}</text>
    </view>

    <!-- 消息列表 -->
    <block wx:for="{{chatRecords}}" wx:key="record_id">
      <!-- 系统消息 -->
      <view class="system" wx:if="{{item.role==='assistant' && (item.content || item.reasoning_content || item.search_info || item.knowledge_base || item.db_len || (chatRecords.length-1)===index&&chatStatus===1)}}">
        <view class="message-content">
          <!-- 发送状态 -->
          <view class="sending-status" wx:if="{{(chatRecords.length-1)===index&&chatStatus===1}}">
            <image src="./imgs/loading.svg" mode="aspectFill" class="status-icon"/>
            <text class="status-text">正在思考中...</text>
          </view>

          <!-- 消息内容 -->
          <block wx:else>
            <!-- 数据库检索结果 -->
            <view wx:if="{{item.db_len}}" class="db-result">
              <image src="./imgs/database.svg" class="result-icon"/>
              <text class="result-text">已匹配 {{item.db_len}} 张数据表</text>
            </view>

            <!-- 联网搜索结果 -->
            <FoldedCard wx:if="{{item.search_info}}" class="search-result" initStatus="{{false}}" showBgColor="{{true}}">
              <view slot="title" class="result-header">
                <image src="./imgs/search.svg" class="result-icon"/>
                <text class="result-title">已参考 {{item.search_info.search_results.length}} 个网页</text>
              </view>
              <view slot="content" class="result-links">
                <block wx:for="{{item.search_info.search_results}}" wx:key="index">
                  <view class="link-item" bind:tap="copyUrl" data-url="{{item.url}}">
                    {{index+1}}. {{item.title}}
                  </view>
                </block>
              </view>
            </FoldedCard>

            <!-- 知识库结果 -->
            <view wx:if="{{item.knowledge_base&&item.knowledge_base.length}}" class="kb-result">
              <image src="./imgs/knowledge.svg" class="result-icon"/>
              <text class="result-text">已参考 {{item.knowledge_base.length}} 个知识库</text>
            </view>

            <!-- 推理过程 -->
            <FoldedCard wx:if="{{!!item.reasoning_content}}" class="reasoning-process" initStatus="{{true}}" showBgColor="{{false}}">
              <view slot="title" class="process-header">
                <image src="./imgs/system-sum.svg" class="process-icon"/>
                <text class="process-status">
                  {{item.pauseThinking ? '已停止思考' :
                    (item.reasoning_content&&!item.content ?
                    '思考中...' :
                    '已深度思考（用时'+item.thinkingTime+'秒）')}}
                </text>
              </view>
              <view slot="content" class="process-content">
                <markdownPreview markdown="{{item.reasoning_content||''}}" fontSize="{{28}}"/>
              </view>
            </FoldedCard>

            <!-- 主要内容 -->
            <view class="main-content" wx:if="{{item.content && item.content.trim() !== ''}}">
              <markdownPreview markdown="{{item.content}}"/>
            </view>

            <!-- 操作按钮组 -->
            <view class="message-actions" wx:if="{{!item.hiddenBtnGround && item.content && item.content.trim() !== ''}}">
              <view class="action-btn" bind:tap="copyChatRecord" data-content="{{item.content}}">
                <image src='./imgs/copy.svg' class="action-icon"/>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 用户消息 -->
      <view class="user-message" wx:if="{{item.role==='user' && item.content && item.content.trim() !== ''}}">
        <view class="message-bubble">
          {{item.content}}
        </view>
        <view class="file-attachments">
          <chatFile
            wx:for="{{item.fileList}}"
            wx:for-item="innerItem"
            wx:key="tempPath"
            enableDel="{{false}}"
            fileData="{{innerItem}}"
            bind:removeChild="handleRemoveChild"
            bind:changeChild="handleChangeChild"
          />
        </view>
      </view>
    </block>

    <!-- 推荐问题 - Material Design 3 风格 -->
    <view class="recommended-questions" wx:if="{{questions.length > 0}}">
      <view class="questions-title">推荐问题</view>
      <view class="questions-container">
        <block wx:for="{{questions}}" wx:key="item">
          <view class="question-item" bind:tap="handleSendMessage" data-message="{{item}}">
            <text class="question-text">{{item}}</text>
          </view>
        </block>
      </view>
    </view>

    <view id="scroll-bottom" class="scroll-anchor"/>
  </scroll-view>

  <!-- 回到底部按钮 -->
  <view class="to-bottom-btn" wx:if="{{manualScroll}}" bind:tap="autoToBottom">
    <image src="./imgs/toBottom.svg" mode="aspectFit" class="to-bottom-icon"/>
  </view>

  <!-- 底部输入区域 -->
  <view class="footer">
    <!-- 功能列表 -->
    <view class="feature-list" wx:if="{{showFeatureList}}">
      <view class="webSearchSwitch {{useWebSearch?'feature_enable':''}}" bind:tap="handleClickWebSearch">
        <image src="./imgs/search.svg" mode="aspectFit" class="feature-icon"/>
        <text>联网搜索</text>
      </view>
    </view>

    <!-- 文件列表 -->
    <view class="file-list" wx:if="{{showFileList}}">
      <chatFile
        wx:for="{{sendFileList}}"
        wx:key="tempPath"
        fileData="{{item}}"
        bind:removeChild="handleRemoveChild"
        bind:changeChild="handleChangeChild"
      />
    </view>

    <!-- 输入框功能区 -->
    <view class="input-area">
      <view class="input-container">
        <view class="input-box">
          <textarea
            class="input"
            value="{{inputValue}}"
            maxlength="{{-1}}"
            auto-height="{{true}}"
            cursor-spacing="{{20}}"
            show-confirm-bar="{{false}}"
            adjust-position="{{true}}"
            hold-keyboard="{{true}}"
            bindinput="bindKeyInput"
            bindlinechange="handleLineChange"
            bindfocus="bindInputFocus"
            bindconfirm="handleConfirm"
            confirm-type="send"
            confirm-hold="{{false}}"
            placeholder="输入消息..."
          />
        </view>
        <view class="input-actions">
          <image wx:if="{{showUploadFile}}" src="./imgs/file.svg" class="action-icon file-icon" bind:tap="handleUploadMessageFile"/>
          <view class="send-btn" bind:tap="handleSendMessage">
            <image src="./imgs/send.svg" class="action-icon send-icon"/>
          </view>
        </view>
      </view>
    </view>

    <!-- 工具栏 -->
    <view class="toolbar" wx:if="{{showTools}}">
      <view class="tool-item" bind:tap="handleCamera">
        <image src="./imgs/camera.svg" class="tool-icon"/>
        <text class="tool-text">拍照</text>
      </view>
      <view class="tool-item" bind:tap="handleAlbum">
        <image src="./imgs/album.svg" class="tool-icon"/>
        <text class="tool-text">相册</text>
      </view>
      <view class="tool-item" bind:tap="clearChatRecords">
        <image src="./imgs/clear.svg" class="tool-icon"/>
        <text class="tool-text">清空</text>
      </view>
    </view>
  </view>
</view>